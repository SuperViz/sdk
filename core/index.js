var De=Object.create;var Mt=Object.defineProperty,Le=Object.defineProperties,Ne=Object.getOwnPropertyDescriptor,Ue=Object.getOwnPropertyDescriptors,Ge=Object.getOwnPropertyNames,jt=Object.getOwnPropertySymbols,Be=Object.getPrototypeOf,Wt=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable;var kt=(D,l,t)=>l in D?Mt(D,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):D[l]=t,dt=(D,l)=>{for(var t in l||(l={}))Wt.call(l,t)&&kt(D,t,l[t]);if(jt)for(var t of jt(l))Fe.call(l,t)&&kt(D,t,l[t]);return D},zt=(D,l)=>Le(D,Ue(l));var _e=(D,l)=>()=>(D&&(l=D(D=0)),l);var it=(D,l)=>()=>(l||D((l={exports:{}}).exports,l),l.exports);var He=(D,l,t,d)=>{if(l&&typeof l=="object"||typeof l=="function")for(let r of Ge(l))!Wt.call(D,r)&&r!==t&&Mt(D,r,{get:()=>l[r],enumerable:!(d=Ne(l,r))||d.enumerable});return D};var At=(D,l,t)=>(t=D!=null?De(Be(D)):{},He(l||!D||!D.__esModule?Mt(t,"default",{value:D,enumerable:!0}):t,D));var ht=(D,l,t)=>new Promise((d,r)=>{var P=A=>{try{O(t.next(A))}catch(x){r(x)}},R=A=>{try{O(t.throw(A))}catch(x){r(x)}},O=A=>A.done?d(A.value):Promise.resolve(A.value).then(P,R);O((t=t.apply(D,l)).next())});var tt,J=_e(()=>{tt={}});var Kt=it((tr,Vt)=>{J();var gt=1e3,vt=gt*60,mt=vt*60,pt=mt*24,ke=pt*7,We=pt*365.25;Vt.exports=function(D,l){l=l||{};var t=typeof D;if(t==="string"&&D.length>0)return ze(D);if(t==="number"&&isFinite(D))return l.long?Ke(D):Ve(D);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(D))};function ze(D){if(D=String(D),!(D.length>100)){var l=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(D);if(!!l){var t=parseFloat(l[1]),d=(l[2]||"ms").toLowerCase();switch(d){case"years":case"year":case"yrs":case"yr":case"y":return t*We;case"weeks":case"week":case"w":return t*ke;case"days":case"day":case"d":return t*pt;case"hours":case"hour":case"hrs":case"hr":case"h":return t*mt;case"minutes":case"minute":case"mins":case"min":case"m":return t*vt;case"seconds":case"second":case"secs":case"sec":case"s":return t*gt;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Ve(D){var l=Math.abs(D);return l>=pt?Math.round(D/pt)+"d":l>=mt?Math.round(D/mt)+"h":l>=vt?Math.round(D/vt)+"m":l>=gt?Math.round(D/gt)+"s":D+"ms"}function Ke(D){var l=Math.abs(D);return l>=pt?bt(D,l,pt,"day"):l>=mt?bt(D,l,mt,"hour"):l>=vt?bt(D,l,vt,"minute"):l>=gt?bt(D,l,gt,"second"):D+" ms"}function bt(D,l,t,d){var r=l>=t*1.5;return Math.round(D/t)+" "+d+(r?"s":"")}});var Qt=it((er,Jt)=>{J();function Je(D){t.debug=t,t.default=t,t.coerce=A,t.disable=P,t.enable=r,t.enabled=R,t.humanize=Kt(),t.destroy=x,Object.keys(D).forEach(m=>{t[m]=D[m]}),t.names=[],t.skips=[],t.formatters={};function l(m){let y=0;for(let i=0;i<m.length;i++)y=(y<<5)-y+m.charCodeAt(i),y|=0;return t.colors[Math.abs(y)%t.colors.length]}t.selectColor=l;function t(m){let y,i=null,g,S;function C(...f){if(!C.enabled)return;let c=C,h=Number(new Date),n=h-(y||h);c.diff=n,c.prev=y,c.curr=h,y=h,f[0]=t.coerce(f[0]),typeof f[0]!="string"&&f.unshift("%O");let s=0;f[0]=f[0].replace(/%([a-zA-Z%])/g,(a,e)=>{if(a==="%%")return"%";s++;let u=t.formatters[e];if(typeof u=="function"){let v=f[s];a=u.call(c,v),f.splice(s,1),s--}return a}),t.formatArgs.call(c,f),(c.log||t.log).apply(c,f)}return C.namespace=m,C.useColors=t.useColors(),C.color=t.selectColor(m),C.extend=d,C.destroy=t.destroy,Object.defineProperty(C,"enabled",{enumerable:!0,configurable:!1,get:()=>i!==null?i:(g!==t.namespaces&&(g=t.namespaces,S=t.enabled(m)),S),set:f=>{i=f}}),typeof t.init=="function"&&t.init(C),C}function d(m,y){let i=t(this.namespace+(typeof y=="undefined"?":":y)+m);return i.log=this.log,i}function r(m){t.save(m),t.namespaces=m,t.names=[],t.skips=[];let y,i=(typeof m=="string"?m:"").split(/[\s,]+/),g=i.length;for(y=0;y<g;y++)!i[y]||(m=i[y].replace(/\*/g,".*?"),m[0]==="-"?t.skips.push(new RegExp("^"+m.slice(1)+"$")):t.names.push(new RegExp("^"+m+"$")))}function P(){let m=[...t.names.map(O),...t.skips.map(O).map(y=>"-"+y)].join(",");return t.enable(""),m}function R(m){if(m[m.length-1]==="*")return!0;let y,i;for(y=0,i=t.skips.length;y<i;y++)if(t.skips[y].test(m))return!1;for(y=0,i=t.names.length;y<i;y++)if(t.names[y].test(m))return!0;return!1}function O(m){return m.toString().substring(2,m.toString().length-2).replace(/\.\*\?$/,"*")}function A(m){return m instanceof Error?m.stack||m.message:m}function x(){}return t.enable(t.load()),t}Jt.exports=Je});var $t=it((ct,St)=>{J();ct.formatArgs=$e;ct.save=Ye;ct.load=Xe;ct.useColors=Qe;ct.storage=qe();ct.destroy=(()=>{let D=!1;return()=>{D||(D=!0)}})();ct.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Qe(){return typeof window!="undefined"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document!="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function $e(D){if(D[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+D[0]+(this.useColors?"%c ":" ")+"+"+St.exports.humanize(this.diff),!this.useColors)return;let l="color: "+this.color;D.splice(1,0,l,"color: inherit");let t=0,d=0;D[0].replace(/%[a-zA-Z%]/g,r=>{r!=="%%"&&(t++,r==="%c"&&(d=t))}),D.splice(d,0,l)}ct.log=console.debug||console.log||(()=>{});function Ye(D){try{D?ct.storage.setItem("debug",D):ct.storage.removeItem("debug")}catch(l){}}function Xe(){let D;try{D=ct.storage.getItem("debug")}catch(l){}return!D&&typeof process!="undefined"&&"env"in process&&(D=tt.DEBUG),D}function qe(){try{return localStorage}catch(D){}}St.exports=Qt()(ct);var{formatters:Ze}=St.exports;Ze.j=function(D){try{return JSON.stringify(D)}catch(l){return"[UnexpectedJSONParseError]: "+l.message}}});var Tt=it((ir,Xt)=>{J();function tn(D){var l=typeof D;return D!=null&&(l=="object"||l=="function")}Xt.exports=tn});var Zt=it((or,qt)=>{J();var en=typeof global=="object"&&global&&global.Object===Object&&global;qt.exports=en});var wt=it((ar,te)=>{J();var nn=Zt(),rn=typeof self=="object"&&self&&self.Object===Object&&self,on=nn||rn||Function("return this")();te.exports=on});var ne=it((sr,ee)=>{J();var an=wt(),sn=function(){return an.Date.now()};ee.exports=sn});var ie=it((ur,re)=>{J();var un=/\s/;function cn(D){for(var l=D.length;l--&&un.test(D.charAt(l)););return l}re.exports=cn});var ae=it((cr,oe)=>{J();var ln=ie(),fn=/^\s+/;function dn(D){return D&&D.slice(0,ln(D)+1).replace(fn,"")}oe.exports=dn});var xt=it((lr,se)=>{J();var hn=wt(),pn=hn.Symbol;se.exports=pn});var fe=it((fr,le)=>{J();var ue=xt(),ce=Object.prototype,gn=ce.hasOwnProperty,vn=ce.toString,Rt=ue?ue.toStringTag:void 0;function mn(D){var l=gn.call(D,Rt),t=D[Rt];try{D[Rt]=void 0;var d=!0}catch(P){}var r=vn.call(D);return d&&(l?D[Rt]=t:delete D[Rt]),r}le.exports=mn});var he=it((dr,de)=>{J();var yn=Object.prototype,Cn=yn.toString;function Rn(D){return Cn.call(D)}de.exports=Rn});var me=it((hr,ve)=>{J();var pe=xt(),On=fe(),An=he(),bn="[object Null]",Sn="[object Undefined]",ge=pe?pe.toStringTag:void 0;function Tn(D){return D==null?D===void 0?Sn:bn:ge&&ge in Object(D)?On(D):An(D)}ve.exports=Tn});var Ce=it((pr,ye)=>{J();function In(D){return D!=null&&typeof D=="object"}ye.exports=In});var Oe=it((gr,Re)=>{J();var En=me(),Pn=Ce(),Mn="[object Symbol]";function wn(D){return typeof D=="symbol"||Pn(D)&&En(D)==Mn}Re.exports=wn});var Te=it((vr,Se)=>{J();var xn=ae(),Ae=Tt(),Dn=Oe(),be=0/0,Ln=/^[-+]0x[0-9a-f]+$/i,Nn=/^0b[01]+$/i,Un=/^0o[0-7]+$/i,Gn=parseInt;function Bn(D){if(typeof D=="number")return D;if(Dn(D))return be;if(Ae(D)){var l=typeof D.valueOf=="function"?D.valueOf():D;D=Ae(l)?l+"":l}if(typeof D!="string")return D===0?D:+D;D=xn(D);var t=Nn.test(D);return t||Un.test(D)?Gn(D.slice(2),t?2:8):Ln.test(D)?be:+D}Se.exports=Bn});var Pe=it((mr,Ee)=>{J();var Fn=Tt(),Dt=ne(),Ie=Te(),_n="Expected a function",Hn=Math.max,jn=Math.min;function kn(D,l,t){var d,r,P,R,O,A,x=0,m=!1,y=!1,i=!0;if(typeof D!="function")throw new TypeError(_n);l=Ie(l)||0,Fn(t)&&(m=!!t.leading,y="maxWait"in t,P=y?Hn(Ie(t.maxWait)||0,l):P,i="trailing"in t?!!t.trailing:i);function g(a){var e=d,u=r;return d=r=void 0,x=a,R=D.apply(u,e),R}function S(a){return x=a,O=setTimeout(c,l),m?g(a):R}function C(a){var e=a-A,u=a-x,v=l-e;return y?jn(v,P-u):v}function f(a){var e=a-A,u=a-x;return A===void 0||e>=l||e<0||y&&u>=P}function c(){var a=Dt();if(f(a))return h(a);O=setTimeout(c,C(a))}function h(a){return O=void 0,i&&d?g(a):(d=r=void 0,R)}function n(){O!==void 0&&clearTimeout(O),x=0,d=A=r=O=void 0}function s(){return O===void 0?R:h(Dt())}function o(){var a=Dt(),e=f(a);if(d=arguments,r=this,A=a,e){if(O===void 0)return S(A);if(y)return clearTimeout(O),O=setTimeout(c,l),g(A)}return O===void 0&&(O=setTimeout(c,l)),R}return o.cancel=n,o.flush=s,o}Ee.exports=kn});var Lt=it((yr,Me)=>{J();var Wn=Pe(),zn=Tt(),Vn="Expected a function";function Kn(D,l,t){var d=!0,r=!0;if(typeof D!="function")throw new TypeError(Vn);return zn(t)&&(d="leading"in t?!!t.leading:d,r="trailing"in t?!!t.trailing:r),Wn(D,l,{leading:d,maxWait:l,trailing:r})}Me.exports=Kn});var xe=it((Et,Nt)=>{J();(function(l,t){typeof Et=="object"&&typeof Nt=="object"?Nt.exports=t():typeof define=="function"&&define.amd?define([],t):typeof Et=="object"?Et.Ably=t():l.Ably=t()})(window,function(){return function(D){var l={};function t(d){if(l[d])return l[d].exports;var r=l[d]={i:d,l:!1,exports:{}};return D[d].call(r.exports,r,r.exports,t),r.l=!0,r.exports}return t.m=D,t.c=l,t.d=function(d,r,P){t.o(d,r)||Object.defineProperty(d,r,{enumerable:!0,get:P})},t.r=function(d){typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})},t.t=function(d,r){if(r&1&&(d=t(d)),r&8||r&4&&typeof d=="object"&&d&&d.__esModule)return d;var P=Object.create(null);if(t.r(P),Object.defineProperty(P,"default",{enumerable:!0,value:d}),r&2&&typeof d!="string")for(var R in d)t.d(P,R,function(O){return d[O]}.bind(null,R));return P},t.n=function(d){var r=d&&d.__esModule?function(){return d.default}:function(){return d};return t.d(r,"a",r),r},t.o=function(d,r){return Object.prototype.hasOwnProperty.call(d,r)},t.p="",t(t.s=41)}([function(D,l,t){"use strict";l.__esModule=!0;var d=function(){function r(){}return r}();l.default=d},function(D,l,t){"use strict";t.r(l),t.d(l,"__extends",function(){return r}),t.d(l,"__assign",function(){return P}),t.d(l,"__rest",function(){return R}),t.d(l,"__decorate",function(){return O}),t.d(l,"__param",function(){return A}),t.d(l,"__metadata",function(){return x}),t.d(l,"__awaiter",function(){return m}),t.d(l,"__generator",function(){return y}),t.d(l,"__createBinding",function(){return i}),t.d(l,"__exportStar",function(){return g}),t.d(l,"__values",function(){return S}),t.d(l,"__read",function(){return C}),t.d(l,"__spread",function(){return f}),t.d(l,"__spreadArrays",function(){return c}),t.d(l,"__spreadArray",function(){return h}),t.d(l,"__await",function(){return n}),t.d(l,"__asyncGenerator",function(){return s}),t.d(l,"__asyncDelegator",function(){return o}),t.d(l,"__asyncValues",function(){return a}),t.d(l,"__makeTemplateObject",function(){return e}),t.d(l,"__importStar",function(){return v}),t.d(l,"__importDefault",function(){return I}),t.d(l,"__classPrivateFieldGet",function(){return U}),t.d(l,"__classPrivateFieldSet",function(){return L});var d=function(E,p){return d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(b,G){b.__proto__=G}||function(b,G){for(var N in G)Object.prototype.hasOwnProperty.call(G,N)&&(b[N]=G[N])},d(E,p)};function r(E,p){if(typeof p!="function"&&p!==null)throw new TypeError("Class extends value "+String(p)+" is not a constructor or null");d(E,p);function b(){this.constructor=E}E.prototype=p===null?Object.create(p):(b.prototype=p.prototype,new b)}var P=function(){return P=Object.assign||function(p){for(var b,G=1,N=arguments.length;G<N;G++){b=arguments[G];for(var _ in b)Object.prototype.hasOwnProperty.call(b,_)&&(p[_]=b[_])}return p},P.apply(this,arguments)};function R(E,p){var b={};for(var G in E)Object.prototype.hasOwnProperty.call(E,G)&&p.indexOf(G)<0&&(b[G]=E[G]);if(E!=null&&typeof Object.getOwnPropertySymbols=="function")for(var N=0,G=Object.getOwnPropertySymbols(E);N<G.length;N++)p.indexOf(G[N])<0&&Object.prototype.propertyIsEnumerable.call(E,G[N])&&(b[G[N]]=E[G[N]]);return b}function O(E,p,b,G){var N=arguments.length,_=N<3?p:G===null?G=Object.getOwnPropertyDescriptor(p,b):G,k;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(E,p,b,G);else for(var H=E.length-1;H>=0;H--)(k=E[H])&&(_=(N<3?k(_):N>3?k(p,b,_):k(p,b))||_);return N>3&&_&&Object.defineProperty(p,b,_),_}function A(E,p){return function(b,G){p(b,G,E)}}function x(E,p){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(E,p)}function m(E,p,b,G){function N(_){return _ instanceof b?_:new b(function(k){k(_)})}return new(b||(b=Promise))(function(_,k){function H(M){try{T(G.next(M))}catch(F){k(F)}}function w(M){try{T(G.throw(M))}catch(F){k(F)}}function T(M){M.done?_(M.value):N(M.value).then(H,w)}T((G=G.apply(E,p||[])).next())})}function y(E,p){var b={label:0,sent:function(){if(_[0]&1)throw _[1];return _[1]},trys:[],ops:[]},G,N,_,k;return k={next:H(0),throw:H(1),return:H(2)},typeof Symbol=="function"&&(k[Symbol.iterator]=function(){return this}),k;function H(T){return function(M){return w([T,M])}}function w(T){if(G)throw new TypeError("Generator is already executing.");for(;b;)try{if(G=1,N&&(_=T[0]&2?N.return:T[0]?N.throw||((_=N.return)&&_.call(N),0):N.next)&&!(_=_.call(N,T[1])).done)return _;switch(N=0,_&&(T=[T[0]&2,_.value]),T[0]){case 0:case 1:_=T;break;case 4:return b.label++,{value:T[1],done:!1};case 5:b.label++,N=T[1],T=[0];continue;case 7:T=b.ops.pop(),b.trys.pop();continue;default:if(_=b.trys,!(_=_.length>0&&_[_.length-1])&&(T[0]===6||T[0]===2)){b=0;continue}if(T[0]===3&&(!_||T[1]>_[0]&&T[1]<_[3])){b.label=T[1];break}if(T[0]===6&&b.label<_[1]){b.label=_[1],_=T;break}if(_&&b.label<_[2]){b.label=_[2],b.ops.push(T);break}_[2]&&b.ops.pop(),b.trys.pop();continue}T=p.call(E,b)}catch(M){T=[6,M],N=0}finally{G=_=0}if(T[0]&5)throw T[1];return{value:T[0]?T[1]:void 0,done:!0}}}var i=Object.create?function(E,p,b,G){G===void 0&&(G=b),Object.defineProperty(E,G,{enumerable:!0,get:function(){return p[b]}})}:function(E,p,b,G){G===void 0&&(G=b),E[G]=p[b]};function g(E,p){for(var b in E)b!=="default"&&!Object.prototype.hasOwnProperty.call(p,b)&&i(p,E,b)}function S(E){var p=typeof Symbol=="function"&&Symbol.iterator,b=p&&E[p],G=0;if(b)return b.call(E);if(E&&typeof E.length=="number")return{next:function(){return E&&G>=E.length&&(E=void 0),{value:E&&E[G++],done:!E}}};throw new TypeError(p?"Object is not iterable.":"Symbol.iterator is not defined.")}function C(E,p){var b=typeof Symbol=="function"&&E[Symbol.iterator];if(!b)return E;var G=b.call(E),N,_=[],k;try{for(;(p===void 0||p-- >0)&&!(N=G.next()).done;)_.push(N.value)}catch(H){k={error:H}}finally{try{N&&!N.done&&(b=G.return)&&b.call(G)}finally{if(k)throw k.error}}return _}function f(){for(var E=[],p=0;p<arguments.length;p++)E=E.concat(C(arguments[p]));return E}function c(){for(var E=0,p=0,b=arguments.length;p<b;p++)E+=arguments[p].length;for(var G=Array(E),N=0,p=0;p<b;p++)for(var _=arguments[p],k=0,H=_.length;k<H;k++,N++)G[N]=_[k];return G}function h(E,p,b){if(b||arguments.length===2)for(var G=0,N=p.length,_;G<N;G++)(_||!(G in p))&&(_||(_=Array.prototype.slice.call(p,0,G)),_[G]=p[G]);return E.concat(_||Array.prototype.slice.call(p))}function n(E){return this instanceof n?(this.v=E,this):new n(E)}function s(E,p,b){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var G=b.apply(E,p||[]),N,_=[];return N={},k("next"),k("throw"),k("return"),N[Symbol.asyncIterator]=function(){return this},N;function k(B){G[B]&&(N[B]=function(W){return new Promise(function(K,X){_.push([B,W,K,X])>1||H(B,W)})})}function H(B,W){try{w(G[B](W))}catch(K){F(_[0][3],K)}}function w(B){B.value instanceof n?Promise.resolve(B.value.v).then(T,M):F(_[0][2],B)}function T(B){H("next",B)}function M(B){H("throw",B)}function F(B,W){B(W),_.shift(),_.length&&H(_[0][0],_[0][1])}}function o(E){var p,b;return p={},G("next"),G("throw",function(N){throw N}),G("return"),p[Symbol.iterator]=function(){return this},p;function G(N,_){p[N]=E[N]?function(k){return(b=!b)?{value:n(E[N](k)),done:N==="return"}:_?_(k):k}:_}}function a(E){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var p=E[Symbol.asyncIterator],b;return p?p.call(E):(E=typeof S=="function"?S(E):E[Symbol.iterator](),b={},G("next"),G("throw"),G("return"),b[Symbol.asyncIterator]=function(){return this},b);function G(_){b[_]=E[_]&&function(k){return new Promise(function(H,w){k=E[_](k),N(H,w,k.done,k.value)})}}function N(_,k,H,w){Promise.resolve(w).then(function(T){_({value:T,done:H})},k)}}function e(E,p){return Object.defineProperty?Object.defineProperty(E,"raw",{value:p}):E.raw=p,E}var u=Object.create?function(E,p){Object.defineProperty(E,"default",{enumerable:!0,value:p})}:function(E,p){E.default=p};function v(E){if(E&&E.__esModule)return E;var p={};if(E!=null)for(var b in E)b!=="default"&&Object.prototype.hasOwnProperty.call(E,b)&&i(p,E,b);return u(p,E),p}function I(E){return E&&E.__esModule?E:{default:E}}function U(E,p,b,G){if(b==="a"&&!G)throw new TypeError("Private accessor was defined without a getter");if(typeof p=="function"?E!==p||!G:!p.has(E))throw new TypeError("Cannot read private member from an object whose class did not declare it");return b==="m"?G:b==="a"?G.call(E):G?G.value:p.get(E)}function L(E,p,b,G,N){if(G==="m")throw new TypeError("Private method is not writable");if(G==="a"&&!N)throw new TypeError("Private accessor was defined without a setter");if(typeof p=="function"?E!==p||!N:!p.has(E))throw new TypeError("Cannot write private member to an object whose class did not declare it");return G==="a"?N.call(E,b):N?N.value=b:p.set(E,b),b}},function(D,l,t){"use strict";(function(d){l.__esModule=!0,l.allToUpperCase=l.allToLowerCase=l.encodeBody=l.decodeBody=l.Format=l.promisify=l.trim=l.arrChooseN=l.randomHexString=l.randomString=l.cheapRandStr=l.dataSizeBytes=l.inspectBody=l.inspectError=l.isErrorInfo=l.now=l.parseQueryString=l.toQueryString=l.arrPopRandomElement=l.defaultPostHeaders=l.defaultGetHeaders=l.allSame=l.arrEvery=l.arrFilter=l.arrMap=l.safeArrForEach=l.arrForEach=l.forInOwnNonNullProperties=l.valuesArray=l.keysArray=l.arrWithoutValue=l.arrDeleteValue=l.arrIn=l.arrIndexOf=l.arrSubtract=l.arrIntersectOb=l.arrIntersect=l.intersect=l.containsValue=l.inherits=l.prototypicalClone=l.shallowClone=l.isEmptyArg=l.isOnlyPropIn=l.isEmpty=l.isObject=l.ensureArray=l.isArray=l.copy=l.mixin=void 0,l.getGlobalObject=l.getJitterCoefficient=l.getBackoffCoefficient=void 0;var r=t(1),P=r.__importDefault(t(0)),R=r.__importDefault(t(8));function O(j){return Math.floor(Math.random()*j.length)}function A(j){for(var z=[],V=1;V<arguments.length;V++)z[V-1]=arguments[V];for(var $=0;$<z.length;$++){var q=z[$];if(!q)break;var ut=Object.prototype.hasOwnProperty;for(var Ct in q)(!ut||ut.call(q,Ct))&&(j[Ct]=q[Ct])}return j}l.mixin=A;function x(j){return A({},j)}l.copy=x,l.isArray=Array.isArray||function(j){return Object.prototype.toString.call(j)=="[object Array]"};function m(j){return S(j)?[]:l.isArray(j)?j:[j]}l.ensureArray=m;function y(j){return Object.prototype.toString.call(j)=="[object Object]"}l.isObject=y;function i(j){for(var z in j)return!1;return!0}l.isEmpty=i;function g(j,z){for(var V in j)if(V!==z)return!1;return!0}l.isOnlyPropIn=g;function S(j){return j==null}l.isEmptyArg=S;function C(j){var z=new Object;for(var V in j)z[V]=j[V];return z}l.shallowClone=C;function f(j,z){var V=function(){function q(){}return q}();V.prototype=j;var $=new V;return z&&A($,z),$}l.prototypicalClone=f;var c=function(j,z){if(P.default.Config.inherits){P.default.Config.inherits(j,z);return}j.super_=z,j.prototype=f(z.prototype,{constructor:j})};l.inherits=c;function h(j,z){for(var V in j)if(j[V]==z)return!0;return!1}l.containsValue=h;function n(j,z){return l.isArray(z)?s(j,z):o(j,z)}l.intersect=n;function s(j,z){for(var V=[],$=0;$<j.length;$++){var q=j[$];l.arrIndexOf(z,q)!=-1&&V.push(q)}return V}l.arrIntersect=s;function o(j,z){for(var V=[],$=0;$<j.length;$++){var q=j[$];q in z&&V.push(q)}return V}l.arrIntersectOb=o;function a(j,z){for(var V=[],$=0;$<j.length;$++){var q=j[$];l.arrIndexOf(z,q)==-1&&V.push(q)}return V}l.arrSubtract=a,l.arrIndexOf=Array.prototype.indexOf?function(j,z,V){return j.indexOf(z,V)}:function(j,z,V){V=V||0;for(var $=j.length;V<$;V++)if(j[V]===z)return V;return-1};function e(j,z){return l.arrIndexOf(j,z)!==-1}l.arrIn=e;function u(j,z){var V=l.arrIndexOf(j,z),$=V!=-1;return $&&j.splice(V,1),$}l.arrDeleteValue=u;function v(j,z){var V=j.slice();return u(V,z),V}l.arrWithoutValue=v;function I(j,z){var V=[];for(var $ in j)z&&!Object.prototype.hasOwnProperty.call(j,$)||V.push($);return V}l.keysArray=I;function U(j,z){var V=[];for(var $ in j)z&&!Object.prototype.hasOwnProperty.call(j,$)||V.push(j[$]);return V}l.valuesArray=U;function L(j,z){for(var V in j)Object.prototype.hasOwnProperty.call(j,V)&&j[V]&&z(V)}l.forInOwnNonNullProperties=L,l.arrForEach=Array.prototype.forEach?function(j,z){j.forEach(z)}:function(j,z){for(var V=j.length,$=0;$<V;$++)z(j[$],$,j)};function E(j,z){return l.arrForEach(j.slice(),z)}l.safeArrForEach=E,l.arrMap=Array.prototype.map?function(j,z){return j.map(z)}:function(j,z){for(var V=[],$=j.length,q=0;q<$;q++)V.push(z(j[q],q,j));return V},l.arrFilter=Array.prototype.filter?function(j,z){return j.filter(z)}:function(j,z){for(var V=[],$=j.length,q=0;q<$;q++)z(j[q])&&V.push(j[q]);return V},l.arrEvery=Array.prototype.every?function(j,z){return j.every(z)}:function(j,z){for(var V=j.length,$=0;$<V;$++)if(!z(j[$],$,j))return!1;return!0};function p(j,z){if(j.length===0)return!0;var V=j[0][z];return l.arrEvery(j,function($){return $[z]===V})}l.allSame=p;var b={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};function G(j){var z=b[j||Z.json];return{accept:z,"X-Ably-Version":R.default.apiVersion,"Ably-Agent":R.default.agent}}l.defaultGetHeaders=G;function N(j){var z,V=z=b[j||Z.json];return{accept:V,"content-type":z,"X-Ably-Version":R.default.apiVersion,"Ably-Agent":R.default.agent}}l.defaultPostHeaders=N;function _(j){return j.splice(O(j),1)[0]}l.arrPopRandomElement=_;function k(j){var z=[];if(j)for(var V in j)z.push(encodeURIComponent(V)+"="+encodeURIComponent(j[V]));return z.length?"?"+z.join("&"):""}l.toQueryString=k;function H(j){for(var z,V=/([^?&=]+)=?([^&]*)/g,$={};z=V.exec(j);)$[decodeURIComponent(z[1])]=decodeURIComponent(z[2]);return $}l.parseQueryString=H,l.now=Date.now||function(){return new Date().getTime()};function w(j){return j.constructor.name=="ErrorInfo"}l.isErrorInfo=w;function T(j){var z,V;return j instanceof Error||((V=(z=j)===null||z===void 0?void 0:z.constructor)===null||V===void 0?void 0:V.name)==="ErrorInfo"?P.default.Config.inspect(j):j.toString()}l.inspectError=T;function M(j){return P.default.BufferUtils.isBuffer(j)?j.toString():typeof j=="string"?j:P.default.Config.inspect(j)}l.inspectBody=M;function F(j){if(P.default.BufferUtils.isBuffer(j))return P.default.BufferUtils.byteLength(j);if(typeof j=="string")return P.default.Config.stringByteSize(j);throw new Error("Expected input of Utils.dataSizeBytes to be a buffer or string, but was: "+typeof j)}l.dataSizeBytes=F;function B(){return String(Math.random()).substr(2)}l.cheapRandStr=B;var W=function(j){if(P.default.Config.getRandomValues&&typeof Uint8Array!="undefined"){var z=new Uint8Array(j);return P.default.Config.getRandomValues(z),P.default.BufferUtils.base64Encode(z)}for(var V=P.default.BufferUtils.base64CharSet,$=Math.round(j*4/3),q="",ut=0;ut<$;ut++)q+=V[O(V)];return q};l.randomString=W;var K=function(j){if(P.default.Config.getRandomValues&&typeof Uint8Array!="undefined"){var z=new Uint8Array(j);return P.default.Config.getRandomValues(z),P.default.BufferUtils.hexEncode(z)}for(var V=P.default.BufferUtils.hexCharSet,$=j*2,q="",ut=0;ut<$;ut++)q+=V[O(V)];return q};l.randomHexString=K;function X(j,z){for(var V=Math.min(z,j.length),$=j.slice(),q=[],ut=0;ut<V;ut++)q.push(_($));return q}l.arrChooseN=X,l.trim=String.prototype.trim?function(j){return j.trim()}:function(j){return j.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")};function Y(j,z,V){return new Promise(function($,q){j[z].apply(j,r.__spreadArray(r.__spreadArray([],V),[function(ut,Ct){ut?q(ut):$(Ct)}]))})}l.promisify=Y;var Z;(function(j){j.msgpack="msgpack",j.json="json"})(Z=l.Format||(l.Format={}));function et(j,z){return z=="msgpack"?P.default.Config.msgpack.decode(j):JSON.parse(String(j))}l.decodeBody=et;function Q(j,z){return z=="msgpack"?P.default.Config.msgpack.encode(j,!0):JSON.stringify(j)}l.encodeBody=Q;function nt(j){return j.map(function(z){return z&&z.toLowerCase()})}l.allToLowerCase=nt;function st(j){return j.map(function(z){return z&&z.toUpperCase()})}l.allToUpperCase=st;function at(j){return Math.min((j+2)/3,2)}l.getBackoffCoefficient=at;function rt(){return 1-Math.random()*.2}l.getJitterCoefficient=rt;function lt(){return d||(typeof window!="undefined"?window:self)}l.getGlobalObject=lt}).call(this,t(12))},function(D,l,t){"use strict";(function(d){l.__esModule=!0;var r=t(1),P=r.__importDefault(t(0)),R=d||(typeof window!="undefined"?window:self),O;(function(i){i[i.None=0]="None",i[i.Error=1]="Error",i[i.Major=2]="Major",i[i.Minor=3]="Minor",i[i.Micro=4]="Micro"})(O||(O={}));function A(i,g){return(""+i).padStart(g?3:2,"0")}function x(i){return P.default.Config.logTimestamps?function(g){var S=new Date;i(A(S.getHours())+":"+A(S.getMinutes())+":"+A(S.getSeconds())+"."+A(S.getMilliseconds(),1)+" "+g)}:i}var m=function(){var i,g,S,C;return typeof Window=="undefined"&&typeof WorkerGlobalScope=="undefined"||typeof((g=(i=R==null?void 0:R.console)===null||i===void 0?void 0:i.log)===null||g===void 0?void 0:g.apply)=="function"?(S=function(){for(var f=[],c=0;c<arguments.length;c++)f[c]=arguments[c]},C=console.warn?function(){for(var f=[],c=0;c<arguments.length;c++)f[c]=arguments[c]}:S):R!=null&&R.console.log?S=C=function(){Function.prototype.apply.call(console.log,console,arguments)}:S=C=function(){},[S,C].map(x)},y=function(){function i(){i.logLevel=i.LOG_DEFAULT}return i.initLogHandlers=function(){var g=m(),S=g[0],C=g[1];this.logHandler=S,this.logErrorHandler=C},i.logLevel=O.Error,i.LOG_NONE=O.None,i.LOG_ERROR=O.Error,i.LOG_MAJOR=O.Major,i.LOG_MINOR=O.Minor,i.LOG_MICRO=O.Micro,i.LOG_DEFAULT=O.Error,i.LOG_DEBUG=O.Micro,i.logAction=function(g,S,C){i.shouldLog(g)&&(g===O.Error?i.logErrorHandler:i.logHandler)("Ably: "+S+": "+C)},i.deprecated=function(g,S){i.deprecatedWithMsg(g,"Please use '"+S+"' instead.")},i.deprecatedWithMsg=function(g,S){i.shouldLog(O.Error)&&i.logErrorHandler("Ably: Deprecation warning - '"+g+"' is deprecated and will be removed from a future version. "+S)},i.shouldLog=function(g){return g<=i.logLevel},i.setLog=function(g,S){g!==void 0&&(i.logLevel=g),S!==void 0&&(i.logHandler=i.logErrorHandler=S)},i}();l.default=y}).call(this,t(12))},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){return function(){if(typeof ArrayBuffer=="function"){var r=d,P=r.lib,R=P.WordArray,O=R.init,A=R.init=function(x){if(x instanceof ArrayBuffer&&(x=new Uint8Array(x)),(x instanceof Int8Array||typeof Uint8ClampedArray!="undefined"&&x instanceof Uint8ClampedArray||x instanceof Int16Array||x instanceof Uint16Array||x instanceof Int32Array||x instanceof Uint32Array||x instanceof Float32Array||x instanceof Float64Array)&&(x=new Uint8Array(x.buffer,x.byteOffset,x.byteLength)),x instanceof Uint8Array){for(var m=x.byteLength,y=[],i=0;i<m;i++)y[i>>>2]|=x[i]<<24-i%4*8;O.call(this,y,m)}else O.apply(this,arguments)};A.prototype=R}}(),d.lib.WordArray})},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(0)),P=d.__importStar(t(2)),R=function(){function O(A,x,m,y){this.message=A,this.code=x,this.statusCode=m,this.cause=y}return O.prototype.toString=function(){var A="["+this.constructor.name;return this.message&&(A+=": "+this.message),this.statusCode&&(A+="; statusCode="+this.statusCode),this.code&&(A+="; code="+this.code),this.cause&&(A+="; cause="+P.inspectError(this.cause)),this.href&&!(this.message&&this.message.indexOf("help.ably.io")>-1)&&(A+="; see "+this.href+" "),A+="]",A},O.fromValues=function(A){var x=A,m=x.message,y=x.code,i=x.statusCode;if(typeof m!="string"||typeof y!="number"||typeof i!="number")throw new Error("ErrorInfo.fromValues(): invalid values: "+r.default.Config.inspect(A));var g=Object.assign(new O(m,y,i),A);return g.code&&!g.href&&(g.href="https://help.ably.io/error/"+g.code),g},O}();l.default=R},function(D,l,t){(function(d){(function(r,P){D.exports=l=P()})(this,function(){var r=r||function(P,R){var O;if(typeof window!="undefined"&&window.crypto&&(O=window.crypto),!O&&typeof window!="undefined"&&window.msCrypto&&(O=window.msCrypto),!O&&typeof d!="undefined"&&d.crypto&&(O=d.crypto),!O)try{O=t(44)}catch(o){}var A=function(){if(O){if(typeof O.getRandomValues=="function")try{return O.getRandomValues(new Uint32Array(1))[0]}catch(o){}if(typeof O.randomBytes=="function")try{return O.randomBytes(4).readInt32LE()}catch(o){}}throw new Error("Native crypto module could not be used to get secure random number.")},x=Object.create||function(){function o(){}return function(a){var e;return o.prototype=a,e=new o,o.prototype=null,e}}(),m={},y=m.lib={},i=y.Base=function(){return{extend:function(o){var a=x(this);return o&&a.mixIn(o),(!a.hasOwnProperty("init")||this.init===a.init)&&(a.init=function(){a.$super.init.apply(this,arguments)}),a.init.prototype=a,a.$super=this,a},create:function(){var o=this.extend();return o.init.apply(o,arguments),o},init:function(){},mixIn:function(o){for(var a in o)o.hasOwnProperty(a)&&(this[a]=o[a]);o.hasOwnProperty("toString")&&(this.toString=o.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),g=y.WordArray=i.extend({init:function(o,a){o=this.words=o||[],a!=R?this.sigBytes=a:this.sigBytes=o.length*4},toString:function(o){return(o||C).stringify(this)},concat:function(o){var a=this.words,e=o.words,u=this.sigBytes,v=o.sigBytes;if(this.clamp(),u%4)for(var I=0;I<v;I++){var U=e[I>>>2]>>>24-I%4*8&255;a[u+I>>>2]|=U<<24-(u+I)%4*8}else for(var I=0;I<v;I+=4)a[u+I>>>2]=e[I>>>2];return this.sigBytes+=v,this},clamp:function(){var o=this.words,a=this.sigBytes;o[a>>>2]&=4294967295<<32-a%4*8,o.length=P.ceil(a/4)},clone:function(){var o=i.clone.call(this);return o.words=this.words.slice(0),o},random:function(o){for(var a=[],e=0;e<o;e+=4)a.push(A());return new g.init(a,o)}}),S=m.enc={},C=S.Hex={stringify:function(o){for(var a=o.words,e=o.sigBytes,u=[],v=0;v<e;v++){var I=a[v>>>2]>>>24-v%4*8&255;u.push((I>>>4).toString(16)),u.push((I&15).toString(16))}return u.join("")},parse:function(o){for(var a=o.length,e=[],u=0;u<a;u+=2)e[u>>>3]|=parseInt(o.substr(u,2),16)<<24-u%8*4;return new g.init(e,a/2)}},f=S.Latin1={stringify:function(o){for(var a=o.words,e=o.sigBytes,u=[],v=0;v<e;v++){var I=a[v>>>2]>>>24-v%4*8&255;u.push(String.fromCharCode(I))}return u.join("")},parse:function(o){for(var a=o.length,e=[],u=0;u<a;u++)e[u>>>2]|=(o.charCodeAt(u)&255)<<24-u%4*8;return new g.init(e,a)}},c=S.Utf8={stringify:function(o){try{return decodeURIComponent(escape(f.stringify(o)))}catch(a){throw new Error("Malformed UTF-8 data")}},parse:function(o){return f.parse(unescape(encodeURIComponent(o)))}},h=y.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(o){typeof o=="string"&&(o=c.parse(o)),this._data.concat(o),this._nDataBytes+=o.sigBytes},_process:function(o){var a,e=this._data,u=e.words,v=e.sigBytes,I=this.blockSize,U=I*4,L=v/U;o?L=P.ceil(L):L=P.max((L|0)-this._minBufferSize,0);var E=L*I,p=P.min(E*4,v);if(E){for(var b=0;b<E;b+=I)this._doProcessBlock(u,b);a=u.splice(0,E),e.sigBytes-=p}return new g.init(a,p)},clone:function(){var o=i.clone.call(this);return o._data=this._data.clone(),o},_minBufferSize:0}),n=y.Hasher=h.extend({cfg:i.extend(),init:function(o){this.cfg=this.cfg.extend(o),this.reset()},reset:function(){h.reset.call(this),this._doReset()},update:function(o){return this._append(o),this._process(),this},finalize:function(o){o&&this._append(o);var a=this._doFinalize();return a},blockSize:512/32,_createHelper:function(o){return function(a,e){return new o.init(e).finalize(a)}},_createHmacHelper:function(o){return function(a,e){return new s.HMAC.init(o,e).finalize(a)}}}),s=m.algo={};return m}(Math);return r})}).call(this,t(12))},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(3)),R=d.__importDefault(t(0));function O(m,y,i){try{y.apply(m,i)}catch(g){P.default.logAction(P.default.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+g+"; stack = "+(g&&g.stack))}}function A(m,y,i){for(var g,S,C,f=0;f<m.length;f++)if(g=m[f],i&&(g=g[i]),r.isArray(g)){for(;(S=r.arrIndexOf(g,y))!==-1;)g.splice(S,1);i&&g.length===0&&delete m[f][i]}else if(r.isObject(g))for(C in g)Object.prototype.hasOwnProperty.call(g,C)&&r.isArray(g[C])&&A([g],y,C)}var x=function(){function m(){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}return m.prototype.on=function(){for(var y=this,i=[],g=0;g<arguments.length;g++)i[g]=arguments[g];if(i.length===1){var S=i[0];if(typeof S=="function")this.any.push(S);else throw new Error("EventListener.on(): Invalid arguments: "+R.default.Config.inspect(i))}if(i.length===2){var C=i[0],f=i[1];if(typeof f!="function")throw new Error("EventListener.on(): Invalid arguments: "+R.default.Config.inspect(i));if(r.isEmptyArg(C))this.any.push(f);else if(r.isArray(C))C.forEach(function(h){y.on(h,f)});else{if(typeof C!="string")throw new Error("EventListener.on(): Invalid arguments: "+R.default.Config.inspect(i));var c=this.events[C]||(this.events[C]=[]);c.push(f)}}},m.prototype.off=function(){for(var y,i=this,g=[],S=0;S<arguments.length;S++)g[S]=arguments[S];if(g.length==0||r.isEmptyArg(g[0])&&r.isEmptyArg(g[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}var C=g[0],f=g[1],c=null,h=null;if(g.length===1||!f)typeof C=="function"?c=C:h=C;else{if(typeof f!="function")throw new Error("EventEmitter.off(): invalid arguments:"+R.default.Config.inspect(g));y=[C,f],h=y[0],c=y[1]}if(c&&r.isEmptyArg(h)){A([this.any,this.events,this.anyOnce,this.eventsOnce],c);return}if(r.isArray(h)){h.forEach(function(n){i.off(n,c)});return}if(typeof h!="string")throw new Error("EventEmitter.off(): invalid arguments:"+R.default.Config.inspect(g));c?A([this.events,this.eventsOnce],c,h):(delete this.events[h],delete this.eventsOnce[h])},m.prototype.listeners=function(y){if(y){var i=this.events[y]||[];return this.eventsOnce[y]&&Array.prototype.push.apply(i,this.eventsOnce[y]),i.length?i:null}return this.any.length?this.any:null},m.prototype.emit=function(y){for(var i=[],g=1;g<arguments.length;g++)i[g-1]=arguments[g];var S={event:y},C=[];this.anyOnce.length&&(Array.prototype.push.apply(C,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(C,this.any);var f=this.eventsOnce[y];f&&(Array.prototype.push.apply(C,f),delete this.eventsOnce[y]);var c=this.events[y];c&&Array.prototype.push.apply(C,c),r.arrForEach(C,function(h){O(S,h,i)})},m.prototype.once=function(){for(var y=this,i=[],g=0;g<arguments.length;g++)i[g]=arguments[g];var S=i.length;if((S===0||S===1&&typeof i[0]!="function")&&R.default.Config.Promise){var C=i[0];if(typeof C!="string")throw new Error("EventEmitter.once(): Invalid arguments:"+R.default.Config.inspect(i));return new R.default.Config.Promise(function(o){y.once(C,o)})}var f=i[0],c=i[1];if(i.length===1&&typeof f=="function")this.anyOnce.push(f);else if(r.isEmptyArg(f)){if(typeof c!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+R.default.Config.inspect(i));this.anyOnce.push(c)}else if(r.isArray(f)){var h=this,n=function(){var o=Array.prototype.slice.call(arguments);if(r.arrForEach(f,function(a){h.off(a,n)}),typeof c!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+R.default.Config.inspect(i));c.apply(this,o)};r.arrForEach(f,function(o){h.on(o,n)})}else{if(typeof f!="string")throw new Error("EventEmitter.once(): Invalid arguments:"+R.default.Config.inspect(i));var s=this.eventsOnce[f]||(this.eventsOnce[f]=[]);if(c){if(typeof c!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+R.default.Config.inspect(i));s.push(c)}}},m.prototype.whenState=function(y,i,g){for(var S=this,C=[],f=3;f<arguments.length;f++)C[f-3]=arguments[f];var c={event:y};if(typeof y!="string"||typeof i!="string")throw"whenState requires a valid event String argument";if(typeof g!="function"&&R.default.Config.Promise)return new R.default.Config.Promise(function(h){m.prototype.whenState.apply(S,[y,i,h].concat(C))});y===i?O(c,g,C):this.once(y,g)},m}();l.default=x},function(D,l,t){"use strict";l.__esModule=!0,l.getDefaults=l.normaliseOptions=l.objectifyOptions=l.getHosts=l.getFallbackHosts=l.environmentFallbackHosts=l.getHttpScheme=l.getPort=l.getHost=void 0;var d=t(1),r=d.__importDefault(t(0)),P=d.__importStar(t(2)),R=d.__importDefault(t(3)),O=d.__importDefault(t(5)),A=t(42),x="ably-js/"+A.version,m={ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,preferenceConnectTimeout:6e3,parallelUpgradeDelay:6e3},httpMaxRetryCount:3,maxMessageSize:65536,version:A.version,apiVersion:"1.2",agent:x,getHost:y,getPort:i,getHttpScheme:g,environmentFallbackHosts:S,getFallbackHosts:C,getHosts:f,checkHost:c,objectifyOptions:s,normaliseOptions:o};function y(e,u,v){return v?u=u==e.restHost&&e.realtimeHost||u||e.realtimeHost:u=u||e.restHost,u}l.getHost=y;function i(e,u){return u||e.tls?e.tlsPort:e.port}l.getPort=i;function g(e){return e.tls?"https://":"http://"}l.getHttpScheme=g;function S(e){return[e+"-a-fallback.ably-realtime.com",e+"-b-fallback.ably-realtime.com",e+"-c-fallback.ably-realtime.com",e+"-d-fallback.ably-realtime.com",e+"-e-fallback.ably-realtime.com"]}l.environmentFallbackHosts=S;function C(e){var u=e.fallbackHosts,v=typeof e.httpMaxRetryCount!="undefined"?e.httpMaxRetryCount:m.httpMaxRetryCount;return u?P.arrChooseN(u,v):[]}l.getFallbackHosts=C;function f(e){return[e.restHost].concat(C(e))}l.getHosts=f;function c(e){if(typeof e!="string")throw new O.default("host must be a string; was a "+typeof e,4e4,400);if(!e.length)throw new O.default("host must not be zero-length",4e4,400)}function h(e,u,v){return e.realtimeHost?e.realtimeHost:e.restHost?(R.default.logAction(R.default.LOG_MINOR,"Defaults.normaliseOptions",'restHost is set to "'+e.restHost+'" but realtimeHost is not set, so setting realtimeHost to "'+e.restHost+'" too. If this is not what you want, please set realtimeHost explicitly.'),e.restHost):u?m.REALTIME_HOST:v+"-"+m.REALTIME_HOST}function n(e){var u={};for(var v in m.TIMEOUTS)u[v]=e[v]||m.TIMEOUTS[v];return u}function s(e){return typeof e=="string"?e.indexOf(":")==-1?{token:e}:{key:e}:e}l.objectifyOptions=s;function o(e){if(e.host&&(R.default.deprecated("host","restHost"),e.restHost=e.host),e.wsHost&&(R.default.deprecated("wsHost","realtimeHost"),e.realtimeHost=e.wsHost),e.queueEvents&&(R.default.deprecated("queueEvents","queueMessages"),e.queueMessages=e.queueEvents),e.fallbackHostsUseDefault){if(e.fallbackHosts){var u="fallbackHosts and fallbackHostsUseDefault cannot both be set";throw R.default.logAction(R.default.LOG_ERROR,"Defaults.normaliseOptions",u),new O.default(u,4e4,400)}if(e.port||e.tlsPort){var u="fallbackHostsUseDefault cannot be set when port or tlsPort are set";throw R.default.logAction(R.default.LOG_ERROR,"Defaults.normaliseOptions",u),new O.default(u,4e4,400)}e.environment?R.default.deprecatedWithMsg("fallbackHostsUseDefault","There is no longer a need to set this when the environment option is also set since the library will now generate the correct fallback hosts using the environment option."):R.default.deprecated("fallbackHostsUseDefault","fallbackHosts: Ably.Defaults.FALLBACK_HOSTS"),e.fallbackHosts=m.FALLBACK_HOSTS}e.recover===!0&&(R.default.deprecated("{recover: true}","{recover: function(lastConnectionDetails, cb) { cb(true); }}"),e.recover=function(G,N){N(!0)}),typeof e.recover=="function"&&e.closeOnUnload===!0&&(R.default.logAction(R.default.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),e.recover=void 0),"closeOnUnload"in e||(e.closeOnUnload=!e.recover),e.transports&&P.arrIn(e.transports,"xhr")&&(R.default.deprecated('transports: ["xhr"]','transports: ["xhr_streaming"]'),P.arrDeleteValue(e.transports,"xhr"),e.transports.push("xhr_streaming")),"queueMessages"in e||(e.queueMessages=!0);var v=e.environment&&String(e.environment).toLowerCase()||m.ENVIRONMENT,I=!v||v==="production";!e.fallbackHosts&&!e.restHost&&!e.realtimeHost&&!e.port&&!e.tlsPort&&(e.fallbackHosts=I?m.FALLBACK_HOSTS:S(v));var U=e.restHost||(I?m.REST_HOST:v+"-"+m.REST_HOST),L=h(e,I,v);P.arrForEach((e.fallbackHosts||[]).concat(U,L),c),e.port=e.port||m.PORT,e.tlsPort=e.tlsPort||m.TLS_PORT,"tls"in e||(e.tls=!0);var E=n(e);if("useBinaryProtocol"in e?e.useBinaryProtocol=r.default.Config.supportsBinary&&e.useBinaryProtocol:e.useBinaryProtocol=r.default.Config.preferBinary,e.clientId){var p=e.headers=e.headers||{};p["X-Ably-ClientId"]=r.default.BufferUtils.base64Encode(r.default.BufferUtils.utf8Encode(e.clientId))}if("idempotentRestPublishing"in e||(e.idempotentRestPublishing=!0),e.promises&&!r.default.Config.Promise&&(R.default.logAction(R.default.LOG_ERROR,"Defaults.normaliseOptions","{promises: true} was specified, but no Promise constructor found; disabling promises"),e.promises=!1),e.agents)for(var b in e.agents)m.agent+=" "+b+"/"+e.agents[b];return d.__assign(d.__assign({},e),{useBinaryProtocol:"useBinaryProtocol"in e?r.default.Config.supportsBinary&&e.useBinaryProtocol:r.default.Config.preferBinary,realtimeHost:L,restHost:U,maxMessageSize:e.maxMessageSize||m.maxMessageSize,timeouts:E})}l.normaliseOptions=o,l.default=m;function a(e){return Object.assign(m,e)}l.getDefaults=a},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(0)),P=d.__importDefault(t(3)),R=d.__importDefault(t(5)),O=d.__importStar(t(2));function A(i){return!i||!i.channelOptions?{channelOptions:i,plugins:{},baseEncodedPreviousPayload:void 0}:i}function x(i){if(i&&i.cipher&&!i.cipher.channelCipher){if(!r.default.Crypto)throw new Error("Encryption not enabled; use ably.encryption.js instead");var g=r.default.Crypto.getCipher(i.cipher);return{cipher:g.cipherParams,channelCipher:g.cipher}}return i}function m(i){var g=0;return i.name&&(g+=i.name.length),i.clientId&&(g+=i.clientId.length),i.extras&&(g+=JSON.stringify(i.extras).length),i.data&&(g+=O.dataSizeBytes(i.data)),g}var y=function(){function i(){}return i.prototype.toJSON=function(){var g=this.encoding,S=this.data;return S&&r.default.BufferUtils.isBuffer(S)&&(arguments.length>0?(g=g?g+"/base64":"base64",S=r.default.BufferUtils.base64Encode(S)):S=r.default.BufferUtils.toBuffer(S)),{name:this.name,id:this.id,clientId:this.clientId,connectionId:this.connectionId,connectionKey:this.connectionKey,extras:this.extras,encoding:g,data:S}},i.prototype.toString=function(){var g="[Message";return this.name&&(g+="; name="+this.name),this.id&&(g+="; id="+this.id),this.timestamp&&(g+="; timestamp="+this.timestamp),this.clientId&&(g+="; clientId="+this.clientId),this.connectionId&&(g+="; connectionId="+this.connectionId),this.encoding&&(g+="; encoding="+this.encoding),this.extras&&(g+="; extras ="+JSON.stringify(this.extras)),this.data&&(typeof this.data=="string"?g+="; data="+this.data:r.default.BufferUtils.isBuffer(this.data)?g+="; data (buffer)="+r.default.BufferUtils.base64Encode(this.data):g+="; data (json)="+JSON.stringify(this.data)),this.extras&&(g+="; extras="+JSON.stringify(this.extras)),g+="]",g},i.encrypt=function(g,S,C){var f=g.data,c=g.encoding,h=S.channelCipher;c=c?c+"/":"",r.default.BufferUtils.isBuffer(f)||(f=r.default.BufferUtils.utf8Encode(String(f)),c=c+"utf-8/"),h.encrypt(f,function(n,s){if(n){C(n);return}g.data=s,g.encoding=c+"cipher+"+h.algorithm,C(null,g)})},i.encode=function(g,S,C){var f=g.data,c=typeof f=="string"||r.default.BufferUtils.isBuffer(f)||f===null||f===void 0;if(!c)if(O.isObject(f)||O.isArray(f))g.data=JSON.stringify(f),g.encoding=g.encoding?g.encoding+"/json":"json";else throw new R.default("Data type is unsupported",40013,400);S!=null&&S.cipher?i.encrypt(g,S,C):C(null,g)},i.encodeArray=function(g,S,C){for(var f=0,c=0;c<g.length;c++)i.encode(g[c],S,function(h){if(h){C(h);return}f++,f==g.length&&C(null,g)})},i.decode=function(g,S){var C=A(S),f=g.data,c=g.encoding;if(c){var h=c.split("/"),n=void 0,s=h.length,o=g.data,a="";try{for(;(n=s)>0;){var e=h[--s].match(/([-\w]+)(\+([\w-]+))?/);if(!e)break;switch(a=e[1],a){case"base64":o=r.default.BufferUtils.base64Decode(String(o)),n==h.length&&(f=o);continue;case"utf-8":o=r.default.BufferUtils.utf8Decode(o);continue;case"json":o=JSON.parse(o);continue;case"cipher":if(C.channelOptions!=null&&C.channelOptions.cipher&&C.channelOptions.channelCipher){var u=e[3],v=C.channelOptions.channelCipher;if(u!=v.algorithm)throw new Error("Unable to decrypt message with given cipher; incompatible cipher params");o=v.decrypt(o);continue}else throw new Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!C.plugins||!C.plugins.vcdiff)throw new R.default("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if(typeof Uint8Array=="undefined")throw new R.default("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{var I=C.baseEncodedPreviousPayload;typeof I=="string"&&(I=r.default.BufferUtils.utf8Encode(I)),I=r.default.BufferUtils.toBuffer(I),o=r.default.BufferUtils.toBuffer(o),o=r.default.BufferUtils.typedArrayToBuffer(C.plugins.vcdiff.decode(o,I)),f=o}catch(L){throw new R.default("Vcdiff delta decode failed with "+L,40018,400)}continue;default:throw new Error("Unknown encoding")}}}catch(L){var U=L;throw new R.default("Error processing the "+a+" encoding, decoder returned \u2018"+U.message+"\u2019",U.code||40013,400)}finally{g.encoding=n<=0?null:h.slice(0,n).join("/"),g.data=o}}C.baseEncodedPreviousPayload=f},i.fromResponseBody=function(g,S,C){C&&(g=O.decodeBody(g,C));for(var f=0;f<g.length;f++){var c=g[f]=i.fromValues(g[f]);try{i.decode(c,S)}catch(h){P.default.logAction(P.default.LOG_ERROR,"Message.fromResponseBody()",h.toString())}}return g},i.fromValues=function(g){return Object.assign(new i,g)},i.fromValuesArray=function(g){for(var S=g.length,C=new Array(S),f=0;f<S;f++)C[f]=i.fromValues(g[f]);return C},i.fromEncoded=function(g,S){var C=i.fromValues(g),f=x(S);try{i.decode(C,f)}catch(c){P.default.logAction(P.default.LOG_ERROR,"Message.fromEncoded()",c.toString())}return C},i.fromEncodedArray=function(g,S){return x(S),g.map(function(C){return i.fromEncoded(C,S)})},i.getMessagesSize=function(g){for(var S,C=0,f=0;f<g.length;f++)S=g[f],C+=S.size||(S.size=m(S));return C},i.serialize=O.encodeBody,i}();l.default=y},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(5)),R=d.__importDefault(t(9)),O=d.__importDefault(t(14)),A={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17},x=[];Object.keys(A).forEach(function(C){x[A[C]]=C});var m={HAS_PRESENCE:1<<0,HAS_BACKLOG:1<<1,RESUMED:1<<2,TRANSIENT:1<<4,ATTACH_RESUME:1<<5,PRESENCE:1<<16,PUBLISH:1<<17,SUBSCRIBE:1<<18,PRESENCE_SUBSCRIBE:1<<19},y=Object.keys(m);m.MODE_ALL=m.PRESENCE|m.PUBLISH|m.SUBSCRIBE|m.PRESENCE_SUBSCRIBE;function i(C){var f=[];if(C)for(var c=0;c<C.length;c++)f.push(C[c].toString());return"[ "+f.join(", ")+" ]"}var g="id channel channelSerial connectionId connectionKey connectionSerial count msgSerial timestamp".split(" "),S=function(){function C(){var f=this;this.hasFlag=function(c){return(f.flags&m[c])>0}}return C.prototype.setFlag=function(f){return this.flags=this.flags|m[f]},C.prototype.getMode=function(){return this.flags&&this.flags&m.MODE_ALL},C.prototype.encodeModesToFlags=function(f){var c=this;f.forEach(function(h){return c.setFlag(h)})},C.prototype.decodeModesFromFlags=function(){var f=this,c=[];return C.channelModes.forEach(function(h){f.hasFlag(h)&&c.push(h)}),c.length>0?c:void 0},C.fromValues=function(f){return Object.assign(new C,f)},C.Action=A,C.channelModes=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE"],C.ActionName=x,C.serialize=r.encodeBody,C.deserialize=function(f,c){var h=r.decodeBody(f,c);return C.fromDeserialized(h)},C.fromDeserialized=function(f){var c=f.error;c&&(f.error=P.default.fromValues(c));var h=f.messages;if(h)for(var n=0;n<h.length;n++)h[n]=R.default.fromValues(h[n]);var s=f.presence;if(s)for(var n=0;n<s.length;n++)s[n]=O.default.fromValues(s[n],!0);return Object.assign(new C,f)},C.stringify=function(f){var c="[ProtocolMessage";f.action!==void 0&&(c+="; action="+C.ActionName[f.action]||!1);for(var h,n=0;n<g.length;n++)h=g[n],f[h]!==void 0&&(c+="; "+h+"="+f[h]);if(f.messages&&(c+="; messages="+i(R.default.fromValuesArray(f.messages))),f.presence&&(c+="; presence="+i(O.default.fromValuesArray(f.presence))),f.error&&(c+="; error="+P.default.fromValues(f.error).toString()),f.auth&&f.auth.accessToken&&(c+="; token="+f.auth.accessToken),f.flags&&(c+="; flags="+y.filter(f.hasFlag).join(",")),f.params){var s="";r.forInOwnNonNullProperties(f.params,function(o){s.length>0&&(s+="; "),s+=o+"="+f.params[o]}),s.length>0&&(c+="; params=["+s+"]")}return c+="]",c},C.isDuplicate=function(f,c){if(f&&c&&(f.action===A.MESSAGE||f.action===A.PRESENCE)&&f.action===c.action&&f.channel===c.channel&&f.id===c.id){if(f.action===A.PRESENCE)return!0;if(f.messages.length===c.messages.length){for(var h=0;h<f.messages.length;h++){var n=f.messages[h],s=c.messages[h];if((n.extras&&n.extras.delta&&n.extras.delta.format)!==(s.extras&&s.extras.delta&&s.extras.delta.format))return!1}return!0}}return!1},C}();l.default=S},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(10)),R=d.__importDefault(t(26)),O=d.__importDefault(t(3)),A=d.__importDefault(t(8)),x=d.__importDefault(t(19)),m=d.__importDefault(t(16)),y=d.__importDefault(t(5)),i=d.__importDefault(t(20)),g=d.__importDefault(t(0));function S(c){var h=[80015,80017,80030];return c.code?m.default.isTokenErr(c)?!1:r.arrIn(h,c.code)?!0:c.code>=4e4&&c.code<5e4:!1}function C(c){return S(c)?[P.default.fromValues({action:P.default.Action.ERROR,error:c})]:[P.default.fromValues({action:P.default.Action.DISCONNECTED,error:c})]}var f=function(c){d.__extends(h,c);function h(n,s,o){var a=c.call(this,n,s,o,!0)||this;return a.onAuthUpdated=function(e){a.authParams={access_token:e.token}},a.stream="stream"in o?o.stream:!0,a.sendRequest=null,a.recvRequest=null,a.pendingCallback=null,a.pendingItems=null,a}return h.prototype.connect=function(){var n=this;O.default.logAction(O.default.LOG_MINOR,"CometTransport.connect()","starting"),R.default.prototype.connect.call(this);var s=this.params,o=s.options,a=A.default.getHost(o,s.host),e=A.default.getPort(o),u=o.tls?"https://":"http://";this.baseUri=u+a+":"+e+"/comet/";var v=this.baseUri+"connect";O.default.logAction(O.default.LOG_MINOR,"CometTransport.connect()","uri: "+v),this.auth.getAuthParams(function(I,U){if(I){n.disconnect(I);return}if(!n.isDisposed){n.authParams=U;var L=n.params.getConnectParams(U);"stream"in L&&(n.stream=L.stream),O.default.logAction(O.default.LOG_MINOR,"CometTransport.connect()","connectParams:"+r.toQueryString(L));var E=!1,p=n.recvRequest=n.createRequest(v,null,L,null,n.stream?i.default.REQ_RECV_STREAM:i.default.REQ_RECV);p.on("data",function(b){!n.recvRequest||(E||(E=!0,n.emit("preconnect")),n.onData(b))}),p.on("complete",function(b){if(n.recvRequest||(b=b||new y.default("Request cancelled",80003,400)),n.recvRequest=null,!E&&!b&&(E=!0,n.emit("preconnect")),n.onActivity(),b){b.code?n.onData(C(b)):n.disconnect(b);return}g.default.Config.nextTick(function(){n.recv()})}),p.exec()}})},h.prototype.requestClose=function(){O.default.logAction(O.default.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)},h.prototype.requestDisconnect=function(){O.default.logAction(O.default.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)},h.prototype._requestCloseOrDisconnect=function(n){var s=this,o=n?this.closeUri:this.disconnectUri;if(o){var a=this.createRequest(o,null,this.authParams,null,i.default.REQ_SEND);a.on("complete",function(e){e&&(O.default.logAction(O.default.LOG_ERROR,"CometTransport.request"+(n?"Close()":"Disconnect()"),"request returned err = "+r.inspectError(e)),s.finish("disconnected",e))}),a.exec()}},h.prototype.dispose=function(){var n=this;O.default.logAction(O.default.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(O.default.logAction(O.default.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",x.default.disconnected),g.default.Config.nextTick(function(){n.emit("disposed")}))},h.prototype.onConnect=function(n){if(!this.isDisposed){var s=n.connectionKey;R.default.prototype.onConnect.call(this,n);var o=this.baseUri+s;O.default.logAction(O.default.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+o+"; connectionKey = "+n.connectionKey),this.sendUri=o+"/send",this.recvUri=o+"/recv",this.closeUri=o+"/close",this.disconnectUri=o+"/disconnect"}},h.prototype.send=function(n){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(n);return}var s=this.pendingItems||[];s.push(n),this.pendingItems=null,this.sendItems(s)},h.prototype.sendAnyPending=function(){var n=this.pendingItems;!n||(this.pendingItems=null,this.sendItems(n))},h.prototype.sendItems=function(n){var s=this,o=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(n),i.default.REQ_SEND);o.on("complete",function(a,e){if(a&&O.default.logAction(O.default.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+r.inspectError(a)),s.sendRequest=null,a){a.code?s.onData(C(a)):s.disconnect(a);return}e&&s.onData(e),s.pendingItems&&g.default.Config.nextTick(function(){s.sendRequest||s.sendAnyPending()})}),o.exec()},h.prototype.recv=function(){var n=this;if(!this.recvRequest&&!!this.isConnected){var s=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?i.default.REQ_RECV_STREAM:i.default.REQ_RECV_POLL);s.on("data",function(o){n.onData(o)}),s.on("complete",function(o){if(n.recvRequest=null,n.onActivity(),o){o.code?n.onData(C(o)):n.disconnect(o);return}g.default.Config.nextTick(function(){n.recv()})}),s.exec()}},h.prototype.onData=function(n){try{var s=this.decodeResponse(n);if(s&&s.length)for(var o=0;o<s.length;o++)this.onProtocolMessage(P.default.fromDeserialized(s[o]))}catch(a){O.default.logAction(O.default.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+a.stack)}},h.prototype.encodeRequest=function(n){return JSON.stringify(n)},h.prototype.decodeResponse=function(n){return typeof n=="string"?JSON.parse(n):n},h}(R.default);l.default=f},function(D,l){var t;t=function(){return this}();try{t=t||new Function("return this")()}catch(d){typeof window=="object"&&(t=window)}D.exports=t},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){return function(){var r=d,P=r.lib,R=P.WordArray,O=r.enc,A=O.Base64={stringify:function(m){var y=m.words,i=m.sigBytes,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";m.clamp();for(var S=[],C=0;C<i;C+=3)for(var f=y[C>>>2]>>>24-C%4*8&255,c=y[C+1>>>2]>>>24-(C+1)%4*8&255,h=y[C+2>>>2]>>>24-(C+2)%4*8&255,n=f<<16|c<<8|h,s=0;s<4&&C+s*.75<i;s++)S.push(g.charAt(n>>>6*(3-s)&63));var o=g.charAt(64);if(o)for(;S.length%4;)S.push(o);return S.join("")},parse:function(m){var y=m.length,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",g=this._reverseMap;if(!g){g=this._reverseMap=[];for(var S=0;S<i.length;S++)g[i.charCodeAt(S)]=S}var C=i.charAt(64);if(C){var f=m.indexOf(C);f!==-1&&(y=f)}return x(m,y,g)}};function x(m,y,i){for(var g=[],S=0,C=0;C<y;C++)if(C%4){var f=i[m.charCodeAt(C-1)]<<C%4*2,c=i[m.charCodeAt(C)]>>>6-C%4*2,h=f|c;g[S>>>2]|=h<<24-S%4*8,S++}return R.create(g,S)}}(),d.enc.Base64})},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(3)),P=d.__importDefault(t(0)),R=d.__importDefault(t(9)),O=d.__importStar(t(2));function A(m){return x.Actions.indexOf(m)}var x=function(){function m(){}return m.prototype.isSynthesized=function(){return!this.id||!this.connectionId?!0:this.id.substring(this.connectionId.length,0)!==this.connectionId},m.prototype.parseId=function(){if(!this.id)throw new Error("parseId(): Presence message does not contain an id");var y=this.id.split(":");return{connectionId:y[0],msgSerial:parseInt(y[1],10),index:parseInt(y[2],10)}},m.prototype.toJSON=function(){var y=this.data,i=this.encoding;return y&&P.default.BufferUtils.isBuffer(y)&&(arguments.length>0?(i=i?i+"/base64":"base64",y=P.default.BufferUtils.base64Encode(y)):y=P.default.BufferUtils.toBuffer(y)),{clientId:this.clientId,action:A(this.action),data:y,encoding:i}},m.prototype.toString=function(){var y="[PresenceMessage";return y+="; action="+this.action,this.id&&(y+="; id="+this.id),this.timestamp&&(y+="; timestamp="+this.timestamp),this.clientId&&(y+="; clientId="+this.clientId),this.connectionId&&(y+="; connectionId="+this.connectionId),this.encoding&&(y+="; encoding="+this.encoding),this.data&&(typeof this.data=="string"?y+="; data="+this.data:P.default.BufferUtils.isBuffer(this.data)?y+="; data (buffer)="+P.default.BufferUtils.base64Encode(this.data):y+="; data (json)="+JSON.stringify(this.data)),y+="]",y},m.fromResponseBody=function(y,i,g){var S=[];g&&(y=O.decodeBody(y,g));for(var C=0;C<y.length;C++){var f=S[C]=m.fromValues(y[C],!0);try{m.decode(f,i)}catch(c){r.default.logAction(r.default.LOG_ERROR,"PresenceMessage.fromResponseBody()",c.toString())}}return S},m.fromValues=function(y,i){return i&&(y.action=m.Actions[y.action]),Object.assign(new m,y)},m.fromValuesArray=function(y){for(var i=y.length,g=new Array(i),S=0;S<i;S++)g[S]=m.fromValues(y[S]);return g},m.fromEncoded=function(y,i){var g=m.fromValues(y,!0);try{m.decode(g,i)}catch(S){r.default.logAction(r.default.LOG_ERROR,"PresenceMessage.fromEncoded()",S.toString())}return g},m.fromEncodedArray=function(y,i){return y.map(function(g){return m.fromEncoded(g,i)})},m.Actions=["absent","present","enter","leave","update"],m.encode=R.default.encode,m.decode=R.default.decode,m.getMessagesSize=R.default.getMessagesSize,m}();l.default=x},function(D,l,t){"use strict";(function(d){l.__esModule=!0;var r=t(1),P=r.__importStar(t(2)),R=r.__importDefault(t(7)),O=r.__importDefault(t(5)),A=r.__importDefault(t(3)),x=r.__importDefault(t(8)),m=r.__importDefault(t(20)),y=r.__importDefault(t(0));function i(u,v){return P.arrIn(P.allToLowerCase(P.keysArray(v)),"x-ably-errorcode")}function g(u,v){if(i(u,v))return u.error&&O.default.fromValues(u.error)}var S=function(){},C=0,f={},c=typeof d!="undefined"&&d.XDomainRequest;function h(){var u=navigator.userAgent.toString().match(/MSIE\s([\d.]+)/);return u&&Number(u[1])}function n(){var u;return c&&(u=h())&&u===10}function s(u,v){return u.getResponseHeader&&u.getResponseHeader(v)}function o(u){return u.getResponseHeader&&(u.getResponseHeader("transfer-encoding")||!u.getResponseHeader("content-length"))}function a(u){for(var v=P.trim(u.getAllResponseHeaders()).split(`\r
`),I={},U=0;U<v.length;U++){var L=v[U].split(":").map(P.trim);I[L[0].toLowerCase()]=L[1]}return I}var e=function(u){r.__extends(v,u);function v(I,U,L,E,p,b,G){var N=u.call(this)||this;return L=L||{},L.rnd=P.cheapRandStr(),n()&&!L.envelope&&(L.envelope="json"),N.uri=I+P.toQueryString(L),N.headers=U||{},N.body=E,N.method=G?G.toUpperCase():P.isEmptyArg(E)?"GET":"POST",N.requestMode=p,N.timeouts=b,N.timedOut=!1,N.requestComplete=!1,N.id=String(++C),f[N.id]=N,N}return v.createRequest=function(I,U,L,E,p,b,G){var N=b||x.default.TIMEOUTS;return new v(I,U,P.copy(L),E,p,N,G)},v.prototype.complete=function(I,U,L,E,p){this.requestComplete||(this.requestComplete=!0,!I&&U&&this.emit("data",U),this.emit("complete",I,U,L,E,p),this.dispose())},v.prototype.abort=function(){this.dispose()},v.prototype.exec=function(){var I=this,U=this.headers,L=this.requestMode==m.default.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,E=this.timer=setTimeout(function(){I.timedOut=!0,b.abort()},L),p=this.method,b=this.xhr=new XMLHttpRequest,G=U.accept,N=this.body,_="text";if(G?G.indexOf("application/x-msgpack")===0&&(_="arraybuffer"):U.accept="application/json",N){var k=U["content-type"]||(U["content-type"]="application/json");k.indexOf("application/json")>-1&&typeof N!="string"&&(N=JSON.stringify(N))}b.open(p,this.uri,!0),b.responseType=_,"authorization"in U&&(b.withCredentials=!0);for(var H in U)b.setRequestHeader(H,U[H]);var w=function(Q,nt,st,at){var rt,lt=nt+" (event type: "+Q.type+")";!((rt=I==null?void 0:I.xhr)===null||rt===void 0)&&rt.statusText&&(lt+=", current statusText is "+I.xhr.statusText),A.default.logAction(A.default.LOG_ERROR,"Request.on"+Q.type+"()",lt),I.complete(new O.default(lt,st,at))};b.onerror=function(Q){w(Q,"XHR error occurred",null,400)},b.onabort=function(Q){I.timedOut?w(Q,"Request aborted due to request timeout expiring",null,408):w(Q,"Request cancelled",null,400)},b.ontimeout=function(Q){w(Q,"Request timed out",null,408)};var T,M,F,B=0,W=!1,K=function(){if(clearTimeout(E),F=M<400,M==204){I.complete(null,null,null,null,M);return}T=I.requestMode==m.default.REQ_RECV_STREAM&&F&&o(b)},X=function(){var Q;try{var nt=s(b,"content-type"),st=nt?nt.indexOf("application/json")>=0:b.responseType=="text";if(st){var at=b.responseType==="arraybuffer"?y.default.BufferUtils.utf8Decode(b.response):String(b.responseText);at.length?Q=JSON.parse(at):Q=at,W=!0}else Q=b.response;Q.response!==void 0?(M=Q.statusCode,F=M<400,U=Q.headers,Q=Q.response):U=a(b)}catch(lt){I.complete(new O.default("Malformed response body from server: "+lt.message,null,400));return}if(F||P.isArray(Q)){I.complete(null,Q,U,W,M);return}var rt=g(Q,U);rt||(rt=new O.default("Error response received from server: "+M+" body was: "+y.default.Config.inspect(Q),null,M)),I.complete(rt,Q,U,W,M)};function Y(){for(var Q=b.responseText,nt=Q.length-1,st,at;B<nt&&(st=Q.indexOf(`
`,B))>-1;)at=Q.slice(B,st),B=st+1,Z(at)}var Z=function(Q){try{Q=JSON.parse(Q)}catch(nt){I.complete(new O.default("Malformed response body from server: "+nt.message,null,400));return}I.emit("data",Q)},et=function(){Y(),I.streamComplete=!0,y.default.Config.nextTick(function(){I.complete()})};b.onreadystatechange=function(){var Q=b.readyState;Q<3||b.status!==0&&(M===void 0&&(M=b.status,M===1223&&(M=204),K()),Q==3&&T?Y():Q==4&&(T?et():X()))},b.send(N)},v.prototype.dispose=function(){var I=this.xhr;if(I){I.onreadystatechange=I.onerror=I.onabort=I.ontimeout=S,this.xhr=null;var U=this.timer;U&&(clearTimeout(U),this.timer=null),this.requestComplete||I.abort()}delete f[this.id]},v}(R.default);l.default=e}).call(this,t(12))},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(3)),P=d.__importStar(t(2)),R=d.__importDefault(t(22)),O=d.__importDefault(t(5)),A=d.__importDefault(t(43)),x=t(13),m=t(32),y=d.__importDefault(t(17)),i=d.__importDefault(t(0)),g=Math.pow(2,17);function S(){}function C(){return("000000"+Math.floor(Math.random()*1e16)).slice(-16)}function f(L){return!!L.connection}function c(L){return P.isErrorInfo(L)?(L.code||(L.statusCode===403?L.code=40300:(L.code=40170,L.statusCode=401)),L):new O.default(P.inspectError(L),L.code||40170,L.statusCode||401)}var h=function(L){return i.default.Config.createHmac?Buffer.from(L,"ascii").toString("base64"):x.stringify(m.parse(L))},n=function(L,E){if(i.default.Config.createHmac){var p=i.default.Config.createHmac("SHA256",E);return p.update(L),p.digest("base64")}return x.stringify(A.default(L,E))};function s(L){if(!L)return"";typeof L=="string"&&(L=JSON.parse(L));var E={},p=P.keysArray(L,!0);if(!p)return"";p.sort();for(var b=0;b<p.length;b++)E[p[b]]=L[p[b]].sort();return JSON.stringify(E)}function o(L){if(L.authCallback)r.default.logAction(r.default.LOG_MINOR,"Auth()","using token auth with authCallback");else if(L.authUrl)r.default.logAction(r.default.LOG_MINOR,"Auth()","using token auth with authUrl");else if(L.key)r.default.logAction(r.default.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(L.tokenDetails)r.default.logAction(r.default.LOG_MINOR,"Auth()","using token auth with supplied token only");else{var E="authOptions must include valid authentication parameters";throw r.default.logAction(r.default.LOG_ERROR,"Auth()",E),new Error(E)}}function a(L){return"useTokenAuth"in L&&!L.useTokenAuth}function e(L){return L.useTokenAuth||!a(L)&&(L.authCallback||L.authUrl||L.token||L.tokenDetails)}function u(L){return!L.key&&!L.authCallback&&!L.authUrl}var v=0;function I(){return v++}var U=function(){function L(E,p){if(this.authOptions={},this.client=E,this.tokenParams=p.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,e(p)){if(p.key&&!n){var b="client-side token request signing not supported";throw r.default.logAction(r.default.LOG_ERROR,"Auth()",b),new Error(b)}u(p)&&r.default.logAction(r.default.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(p.defaultTokenParams,p),o(this.authOptions)}else{if(!p.key){var b="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw r.default.logAction(r.default.LOG_ERROR,"Auth()",b),new O.default(b,40160,401)}r.default.logAction(r.default.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(p)}}return L.prototype.authorize=function(E,p,b){var G=this,N;if(typeof E=="function"&&!b?(b=E,N=E=null):typeof p=="function"&&!b?(b=p,N=null):N=p,!b&&this.client.options.promises)return P.promisify(this,"authorize",arguments);if(N&&N.key&&this.authOptions.key!==N.key)throw new O.default("Unable to update auth options with incompatible key",40102,401);N&&"force"in N&&(r.default.logAction(r.default.LOG_ERROR,"Auth.authorize","Deprecation warning: specifying {force: true} in authOptions is no longer necessary, authorize() now always gets a new token. Please remove this, as in version 1.0 and later, having a non-null authOptions will overwrite stored library authOptions, which may not be what you want"),P.isOnlyPropIn(N,"force")&&(N=null)),this._forceNewToken(E,N,function(_,k){if(_){G.client.connection&&G.client.connection.connectionManager.actOnErrorFromAuthorize(_),b==null||b(_);return}f(G.client)?G.client.connection.connectionManager.onAuthUpdated(k,b||S):b==null||b(null,k)})},L.prototype.authorise=function(E,p,b){r.default.deprecated("Auth.authorise","Auth.authorize"),this.authorize(E,p,b)},L.prototype._forceNewToken=function(E,p,b){var G=this;this.tokenDetails=null,this._saveTokenOptions(E,p),o(this.authOptions),this._ensureValidAuthCredentials(!0,function(N,_){delete G.tokenParams.timestamp,delete G.authOptions.queryTime,b(N,_)})},L.prototype.requestToken=function(E,p,b){var G=this;if(typeof E=="function"&&!b?(b=E,p=E=null):typeof p=="function"&&!b&&(b=p,p=null),!b&&this.client.options.promises)return P.promisify(this,"requestToken",arguments);p=p||this.authOptions,E=E||P.copy(this.tokenParams);var N=b||S,_,k=this.client;if(p.authCallback)r.default.logAction(r.default.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),_=p.authCallback;else if(p.authUrl)r.default.logAction(r.default.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),_=function(B,W){var K=P.mixin({accept:"application/json, text/plain"},p.authHeaders),X=p.authMethod&&p.authMethod.toLowerCase()==="post",Y,Z=p.authUrl.indexOf("?");Z>-1&&(Y=P.parseQueryString(p.authUrl.slice(Z)),p.authUrl=p.authUrl.slice(0,Z),X||(p.authParams=P.mixin(Y,p.authParams)));var et=P.mixin({},p.authParams||{},B),Q=function(at,rt,lt,j){var z;if(at?r.default.logAction(r.default.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+P.inspectError(at)):(z=lt["content-type"],r.default.logAction(r.default.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+z+"; body: "+P.inspectBody(rt))),at||j)return W(at,rt);if(i.default.BufferUtils.isBuffer(rt)&&(rt=rt.toString()),!z){W(new O.default("authUrl response is missing a content-type header",40170,401));return}var V=z.indexOf("application/json")>-1,$=z.indexOf("text/plain")>-1||z.indexOf("application/jwt")>-1;if(!V&&!$){W(new O.default("authUrl responded with unacceptable content-type "+z+", should be either text/plain, application/jwt or application/json",40170,401));return}if(V){if(rt.length>g){W(new O.default("authUrl response exceeded max permitted length",40170,401));return}try{rt=JSON.parse(rt)}catch(q){W(new O.default("Unexpected error processing authURL response; err = "+q.message,40170,401));return}}W(null,rt,z)};if(r.default.logAction(r.default.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+p.authUrl+"; Params: "+JSON.stringify(et)+"; method: "+(X?"POST":"GET")),X){var nt=K||{};nt["content-type"]="application/x-www-form-urlencoded";var st=P.toQueryString(et).slice(1);G.client.http.doUri(y.default.Post,k,p.authUrl,nt,st,Y,Q)}else G.client.http.doUri(y.default.Get,k,p.authUrl,K||{},null,et,Q)};else if(p.key)r.default.logAction(r.default.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),_=function(B,W){G.createTokenRequest(B,p,W)};else{var H="Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)";r.default.logAction(r.default.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),N(new O.default(H,40171,403));return}"capability"in E&&(E.capability=s(E.capability));var w=function(B,W){var K=B.keyName,X="/keys/"+K+"/requestToken",Y=function(et){return k.baseUri(et)+X},Z=P.defaultPostHeaders();p.requestHeaders&&P.mixin(Z,p.requestHeaders),r.default.logAction(r.default.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+X+"; Token params: "+JSON.stringify(B)),G.client.http.do(y.default.Post,k,Y,Z,JSON.stringify(B),null,W)},T=!1,M=this.client.options.timeouts.realtimeRequestTimeout,F=setTimeout(function(){T=!0;var B="Token request callback timed out after "+M/1e3+" seconds";r.default.logAction(r.default.LOG_ERROR,"Auth.requestToken()",B),N(new O.default(B,40170,401))},M);_(E,function(B,W,K){if(!T){if(clearTimeout(F),B){r.default.logAction(r.default.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+P.inspectError(B)),N(c(B));return}if(typeof W=="string"){W.length===0?N(new O.default("Token string is empty",40170,401)):W.length>g?N(new O.default("Token string exceeded max permitted length (was "+W.length+" bytes)",40170,401)):W==="undefined"||W==="null"?N(new O.default("Token string was literal null/undefined",40170,401)):W[0]==="{"&&!(K&&K.indexOf("application/jwt")>-1)?N(new O.default("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401)):N(null,{token:W});return}if(typeof W!="object"){var X="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof W;r.default.logAction(r.default.LOG_ERROR,"Auth.requestToken()",X),N(new O.default(X,40170,401));return}var Y=JSON.stringify(W).length;if(Y>g&&!p.suppressMaxLengthCheck){N(new O.default("Token request/details object exceeded max permitted stringified size (was "+Y+" bytes)",40170,401));return}if("issued"in W){N(null,W);return}if(!("keyName"in W)){var X="Expected token request callback to call back with a token string, token request object, or token details object";r.default.logAction(r.default.LOG_ERROR,"Auth.requestToken()",X),N(new O.default(X,40170,401));return}w(W,function(Z,et,Q,nt){if(Z){r.default.logAction(r.default.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+P.inspectError(Z)),N(c(Z));return}nt||(et=JSON.parse(et)),r.default.logAction(r.default.LOG_MINOR,"Auth.getToken()","token received"),N(null,et)})}})},L.prototype.createTokenRequest=function(E,p,b){var G=this;if(typeof E=="function"&&!b?(b=E,p=E=null):typeof p=="function"&&!b&&(b=p,p=null),!b&&this.client.options.promises)return P.promisify(this,"createTokenRequest",arguments);p=p||this.authOptions,E=E||P.copy(this.tokenParams);var N=p.key;if(!N){b(new O.default("No key specified",40101,403));return}var _=N.split(":"),k=_[0],H=_[1];if(!H){b(new O.default("Invalid key specified",40101,403));return}if(E.clientId===""){b(new O.default("clientId can\u2019t be an empty string",40012,400));return}"capability"in E&&(E.capability=s(E.capability));var w=P.mixin({keyName:k},E),T=E.clientId||"",M=E.ttl||"",F=E.capability||"";(function(B){if(w.timestamp){B();return}G.getTimestamp(p&&p.queryTime,function(W,K){if(W){b(W);return}w.timestamp=K,B()})})(function(){var B=w.nonce||(w.nonce=C()),W=w.timestamp,K=w.keyName+`
`+M+`
`+F+`
`+T+`
`+W+`
`+B+`
`;w.mac=w.mac||n(K,H),r.default.logAction(r.default.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),b(null,w)})},L.prototype.getAuthParams=function(E){this.method=="basic"?E(null,{key:this.key}):this._ensureValidAuthCredentials(!1,function(p,b){if(p){E(p);return}if(!b)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");E(null,{access_token:b.token})})},L.prototype.getAuthHeaders=function(E){this.method=="basic"?E(null,{authorization:"Basic "+this.basicKey}):this._ensureValidAuthCredentials(!1,function(p,b){if(p){E(p);return}if(!b)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");E(null,{authorization:"Bearer "+h(b.token)})})},L.prototype.getTimestamp=function(E,p){!this.isTimeOffsetSet()&&(E||this.authOptions.queryTime)?this.client.time(p):p(null,this.getTimestampUsingOffset())},L.prototype.getTimestampUsingOffset=function(){return P.now()+(this.client.serverTimeOffset||0)},L.prototype.isTimeOffsetSet=function(){return this.client.serverTimeOffset!==null},L.prototype._saveBasicOptions=function(E){this.method="basic",this.key=E.key,this.basicKey=h(E.key),this.authOptions=E||{},"clientId"in E&&this._userSetClientId(E.clientId)},L.prototype._saveTokenOptions=function(E,p){this.method="token",E&&(this.tokenParams=E),p&&(p.token&&(p.tokenDetails=typeof p.token=="string"?{token:p.token}:p.token),p.tokenDetails&&(this.tokenDetails=p.tokenDetails),"clientId"in p&&this._userSetClientId(p.clientId),this.authOptions=p)},L.prototype._ensureValidAuthCredentials=function(E,p){var b=this,G=this.tokenDetails;if(G){if(this._tokenClientIdMismatch(G.clientId)){p(new O.default("Mismatch between clientId in token ("+G.clientId+") and current clientId ("+this.clientId+")",40102,403));return}if(!this.isTimeOffsetSet()||!G.expires||G.expires>=this.getTimestampUsingOffset()){r.default.logAction(r.default.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+G.expires),p(null,G);return}r.default.logAction(r.default.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}if((this.waitingForTokenRequest||(this.waitingForTokenRequest=R.default.create())).push(p),!(this.currentTokenRequestId!==null&&!E)){var N=this.currentTokenRequestId=I();this.requestToken(this.tokenParams,this.authOptions,function(_,k){if(b.currentTokenRequestId>N){r.default.logAction(r.default.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one");return}b.currentTokenRequestId=null;var H=b.waitingForTokenRequest||S;if(b.waitingForTokenRequest=null,_){H(_);return}H(null,b.tokenDetails=k)})}},L.prototype._userSetClientId=function(E){if(typeof E=="string"||E===null){if(E==="*")throw new O.default('Can\u2019t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);var p=this._uncheckedSetClientId(E);if(p)throw p}else throw new O.default("clientId must be either a string or null",40012,400)},L.prototype._uncheckedSetClientId=function(E){if(this._tokenClientIdMismatch(E)){var p="Unexpected clientId mismatch: client has "+this.clientId+", requested "+E,b=new O.default(p,40102,401);return r.default.logAction(r.default.LOG_ERROR,"Auth._uncheckedSetClientId()",p),b}else return this.clientId=this.tokenParams.clientId=E,null},L.prototype._tokenClientIdMismatch=function(E){return!!(this.clientId&&this.clientId!=="*"&&E&&E!=="*"&&this.clientId!==E)},L.isTokenErr=function(E){return E.code&&E.code>=40140&&E.code<40150},L}();l.default=U},function(D,l,t){"use strict";l.__esModule=!0;var d;(function(r){r.Get="get",r.Delete="delete",r.Post="post",r.Put="put",r.Patch="patch"})(d||(d={})),l.default=d},function(D,l,t){"use strict";l.__esModule=!0,l.HttpPaginatedResponse=l.PaginatedResult=void 0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(3)),R=d.__importDefault(t(24));function O(g){var S=g.match(/^\.\/(\w+)\?(.*)$/);return S&&S[2]&&r.parseQueryString(S[2])}function A(g){typeof g=="string"&&(g=g.split(","));for(var S={},C=0;C<g.length;C++){var f=g[C].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(f){var c=O(f[1]);c&&(S[f[2]]=c)}}return S}function x(g,S,C){return!(C&&(S||typeof g.code=="number"))}var m=function(){function g(S,C,f,c,h,n){this.rest=S,this.path=C,this.headers=f,this.envelope=c!=null?c:null,this.bodyHandler=h,this.useHttpPaginatedResponse=n||!1}return g.prototype.get=function(S,C){var f=this;R.default.get(this.rest,this.path,this.headers,S,this.envelope,function(c,h,n,s,o){f.handlePage(c,h,n,s,o,C)})},g.prototype.delete=function(S,C){var f=this;R.default.delete(this.rest,this.path,this.headers,S,this.envelope,function(c,h,n,s,o){f.handlePage(c,h,n,s,o,C)})},g.prototype.post=function(S,C,f){var c=this;R.default.post(this.rest,this.path,C,this.headers,S,this.envelope,function(h,n,s,o,a){f&&c.handlePage(h,n,s,o,a,f)})},g.prototype.put=function(S,C,f){var c=this;R.default.put(this.rest,this.path,C,this.headers,S,this.envelope,function(h,n,s,o,a){f&&c.handlePage(h,n,s,o,a,f)})},g.prototype.patch=function(S,C,f){var c=this;R.default.patch(this.rest,this.path,C,this.headers,S,this.envelope,function(h,n,s,o,a){f&&c.handlePage(h,n,s,o,a,f)})},g.prototype.handlePage=function(S,C,f,c,h,n){if(S&&x(S,C,this.useHttpPaginatedResponse)){P.default.logAction(P.default.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+r.inspectError(S)),n==null||n(S);return}var s,o,a;try{s=this.bodyHandler(C,f||{},c)}catch(e){n==null||n(S||e);return}f&&(o=f.Link||f.link)&&(a=A(o)),this.useHttpPaginatedResponse?n(null,new i(this,s,f||{},h,a,S)):n(null,new y(this,s,a))},g}(),y=function(){function g(S,C,f){var c=this;this.resource=S,this.items=C;var h=this;f&&("first"in f&&(this.first=function(n){if(!n&&h.resource.rest.options.promises)return r.promisify(h,"first",[]);h.get(f.first,n)}),"current"in f&&(this.current=function(n){if(!n&&h.resource.rest.options.promises)return r.promisify(h,"current",[]);h.get(f.current,n)}),this.next=function(n){if(!n&&h.resource.rest.options.promises)return r.promisify(h,"next",[]);"next"in f?h.get(f.next,n):n(null)},this.hasNext=function(){return"next"in f},this.isLast=function(){var n;return!(!((n=c.hasNext)===null||n===void 0)&&n.call(c))})}return g.prototype.get=function(S,C){var f=this.resource;R.default.get(f.rest,f.path,f.headers,S,f.envelope,function(c,h,n,s,o){f.handlePage(c,h,n,s,o,C)})},g}();l.PaginatedResult=y;var i=function(g){d.__extends(S,g);function S(C,f,c,h,n,s){var o=g.call(this,C,f,n)||this;return o.statusCode=h,o.success=h<300&&h>=200,o.headers=c,o.errorCode=s&&s.code,o.errorMessage=s&&s.message,o}return S.prototype.toJSON=function(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}},S}(y);l.HttpPaginatedResponse=i,l.default=m},function(D,l,t){"use strict";l.__esModule=!0,l.isRetriable=void 0;var d=t(1),r=d.__importDefault(t(5)),P={disconnected:r.default.fromValues({statusCode:400,code:80003,message:"Connection to server temporarily unavailable"}),suspended:r.default.fromValues({statusCode:400,code:80002,message:"Connection to server unavailable"}),failed:r.default.fromValues({statusCode:400,code:8e4,message:"Connection failed or disconnected by server"}),closing:r.default.fromValues({statusCode:400,code:80017,message:"Connection closing"}),closed:r.default.fromValues({statusCode:400,code:80017,message:"Connection closed"}),unknownConnectionErr:r.default.fromValues({statusCode:500,code:50002,message:"Internal connection error"}),unknownChannelErr:r.default.fromValues({statusCode:500,code:50001,message:"Internal channel error"})};function R(O){if(!O.statusCode||!O.code||O.statusCode>=500)return!0;var A=!1;return Object.values(P).forEach(function(x){x.code&&x.code==O.code&&(A=!0)}),A}l.isRetriable=R,l.default=P},function(D,l,t){"use strict";l.__esModule=!0;var d;(function(r){r[r.REQ_SEND=0]="REQ_SEND",r[r.REQ_RECV=1]="REQ_RECV",r[r.REQ_RECV_POLL=2]="REQ_RECV_POLL",r[r.REQ_RECV_STREAM=3]="REQ_RECV_STREAM"})(d||(d={})),l.default=d},function(D,l,t){(function(d,r){D.exports=l=r(t(6),t(4),t(58),t(13),t(39),t(31),t(23),t(27),t(28),t(59),t(60))})(this,function(d){return d})},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(3)),P=function(){function R(O){this.members=O||[]}return R.prototype.call=function(){for(var O=[],A=0;A<arguments.length;A++)O[A]=arguments[A];for(var x=0,m=this.members;x<m.length;x++){var y=m[x];if(y)try{y.apply(void 0,O)}catch(i){r.default.logAction(r.default.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+i+"; stack = "+i.stack)}}},R.prototype.push=function(){for(var O,A=[],x=0;x<arguments.length;x++)A[x]=arguments[x];(O=this.members).push.apply(O,A)},R.create=function(O){var A=new R(O);return Object.assign(function(){for(var x=[],m=0;m<arguments.length;m++)x[m]=arguments[m];return A.call.apply(A,x)},{push:function(x){return A.push(x)}})},R}();l.default=P},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){(function(){var r=d,P=r.lib,R=P.Base,O=r.enc,A=O.Utf8,x=r.algo,m=x.HMAC=R.extend({init:function(y,i){y=this._hasher=new y.init,typeof i=="string"&&(i=A.parse(i));var g=y.blockSize,S=g*4;i.sigBytes>S&&(i=y.finalize(i)),i.clamp();for(var C=this._oKey=i.clone(),f=this._iKey=i.clone(),c=C.words,h=f.words,n=0;n<g;n++)c[n]^=1549556828,h[n]^=909522486;C.sigBytes=f.sigBytes=S,this.reset()},reset:function(){var y=this._hasher;y.reset(),y.update(this._iKey)},update:function(y){return this._hasher.update(y),this},finalize:function(y){var i=this._hasher,g=i.finalize(y);i.reset();var S=i.finalize(this._oKey.clone().concat(g));return S}})})()})},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(0)),P=d.__importStar(t(2)),R=d.__importDefault(t(3)),O=d.__importDefault(t(16)),A=d.__importDefault(t(17)),x=d.__importDefault(t(5));function m(f,c,h,n,s){f.http.supportsAuthHeaders?f.auth.getAuthHeaders(function(o,a){o?n(o):s(P.mixin(a,c),h)}):f.auth.getAuthParams(function(o,a){o?n(o):s(c,P.mixin(a,h))})}function y(f,c){return function(h,n,s,o,a){if(h&&!n){f(h);return}if(!o)try{n=P.decodeBody(n,c)}catch(L){f(L);return}if(!n){f(new x.default("unenvelope(): Response body is missing",null));return}var e=n,u=e.statusCode,v=e.response,I=e.headers;if(u===void 0){f(h,n,s,!0,a);return}if(u<200||u>=300){var U=v&&v.error||h;U||(U=new Error("Error in unenveloping "+n),U.statusCode=u),f(U,v,I,!0,u);return}f(h,v,I,!0,u)}}function i(f){var c=[];if(f)for(var h in f)c.push(h+"="+f[h]);return c.join("&")}function g(f,c){return f+(c?"?":"")+i(c)}function S(f,c,h,n){return function(s,o,a,e,u){s?R.default.logAction(R.default.LOG_MICRO,"Resource."+c+"()","Received Error; "+g(h,n)+"; Error: "+P.inspectError(s)):R.default.logAction(R.default.LOG_MICRO,"Resource."+c+"()","Received; "+g(h,n)+"; Headers: "+i(a)+"; StatusCode: "+u+"; Body: "+(r.default.BufferUtils.isBuffer(o)?o.toString():o)),f&&f(s,o,a,e,u)}}var C=function(){function f(){}return f.get=function(c,h,n,s,o,a){f.do(A.default.Get,c,h,null,n,s,o,a)},f.delete=function(c,h,n,s,o,a){f.do(A.default.Delete,c,h,null,n,s,o,a)},f.post=function(c,h,n,s,o,a,e){f.do(A.default.Post,c,h,n,s,o,a,e)},f.patch=function(c,h,n,s,o,a,e){f.do(A.default.Patch,c,h,n,s,o,a,e)},f.put=function(c,h,n,s,o,a,e){f.do(A.default.Put,c,h,n,s,o,a,e)},f.do=function(c,h,n,s,o,a,e,u){R.default.shouldLog(R.default.LOG_MICRO)&&(u=S(u,c,n,a)),e&&(u=u&&y(u,e),(a=a||{}).envelope=e);function v(I,U){var L;if(R.default.shouldLog(R.default.LOG_MICRO)&&R.default.logAction(R.default.LOG_MICRO,"Resource."+c+"()","Sending; "+g(n,U)),R.default.shouldLog(R.default.LOG_MICRO)){var E=s;if(((L=I["content-type"])===null||L===void 0?void 0:L.indexOf("msgpack"))>0)try{E=r.default.Config.msgpack.decode(s)}catch(p){R.default.logAction(R.default.LOG_MICRO,"Resource."+c+"()","Sending MsgPack Decoding Error: "+P.inspectError(p))}R.default.logAction(R.default.LOG_MICRO,"Resource."+c+"()","Sending; "+g(n,U)+"; Body: "+E)}h.http.do(c,h,n,I,s,U,function(p,b,G,N,_){if(p&&O.default.isTokenErr(p)){h.auth.authorize(null,null,function(k){if(k){u(k);return}m(h,G,U,u,v)});return}u(p,b,G,N,_)})}m(h,o,a,u,v)},f}();l.default=C},function(D,l,t){"use strict";(function(d){l.__esModule=!0,l.TransportParams=void 0;var r=t(1),P=r.__importDefault(t(10)),R=r.__importStar(t(2)),O=r.__importStar(t(51)),A=r.__importDefault(t(8)),x=r.__importDefault(t(0)),m=r.__importDefault(t(7)),y=r.__importDefault(t(35)),i=r.__importDefault(t(3)),g=r.__importDefault(t(36)),S=r.__importStar(t(19)),C=r.__importDefault(t(5)),f=r.__importDefault(t(16)),c=r.__importDefault(t(9)),h=r.__importDefault(t(22)),n=r.__importDefault(t(52)),s=r.__importDefault(t(26)),o=r.__importDefault(t(53)),a=function(){var k;return typeof x.default.WebStorage!="undefined"&&((k=x.default.WebStorage)===null||k===void 0?void 0:k.localSupported)},e=function(){var k;return typeof x.default.WebStorage!="undefined"&&((k=x.default.WebStorage)===null||k===void 0?void 0:k.sessionSupported)},u=P.default.Action,v=function(){},I="ably-transport-preference",U="ably-connection-recovery";function L(){var k,H;return e()&&((H=(k=x.default.WebStorage)===null||k===void 0?void 0:k.getSession)===null||H===void 0?void 0:H.call(k,U))}function E(k){var H,w;return e()&&((w=(H=x.default.WebStorage)===null||H===void 0?void 0:H.setSession)===null||w===void 0?void 0:w.call(H,U,k))}function p(){var k,H;return e()&&((H=(k=x.default.WebStorage)===null||k===void 0?void 0:k.removeSession)===null||H===void 0?void 0:H.call(k,U))}function b(k,H){return R.arrIndexOf(x.default.Defaults.transportPreferenceOrder,k.shortName)>R.arrIndexOf(x.default.Defaults.transportPreferenceOrder,H.shortName)}function G(k,H,w){var T;if(k.channel!==H.channel||(T=k.action)!==u.PRESENCE&&T!==u.MESSAGE||T!==H.action)return!1;var M=T===u.PRESENCE?"presence":"messages",F=k[M].concat(H[M]),B=c.default.getMessagesSize(F);return B>w||!R.allSame(F,"clientId")||!R.arrEvery(F,function(W){return!W.id})?!1:(k[M]=F,!0)}var N=function(){function k(H,w,T,M){this.options=H,this.host=w,this.mode=T,this.connectionKey=M,this.format=H.useBinaryProtocol?R.Format.msgpack:R.Format.json,this.connectionSerial=void 0,this.timeSerial=void 0}return k.prototype.getConnectParams=function(H){var w=H?R.copy(H):{},T=this.options;switch(this.mode){case"upgrade":w.upgrade=this.connectionKey;break;case"resume":w.resume=this.connectionKey,this.timeSerial!==void 0?w.timeSerial=this.timeSerial:this.connectionSerial!==void 0&&(w.connectionSerial=this.connectionSerial);break;case"recover":{var M=T.recover.split(":");if(M){w.recover=M[0];var F=M[1];isNaN(Number(F))?w.timeSerial=F:w.connectionSerial=F}break}default:}return T.clientId!==void 0&&(w.clientId=T.clientId),T.echoMessages===!1&&(w.echo="false"),this.format!==void 0&&(w.format=this.format),this.stream!==void 0&&(w.stream=this.stream),this.heartbeats!==void 0&&(w.heartbeats=this.heartbeats),w.v=A.default.apiVersion,w.agent=encodeURIComponent(A.default.agent),T.transportParams!==void 0&&R.mixin(w,T.transportParams),w},k.prototype.toString=function(){var H="[mode="+this.mode;return this.host&&(H+=",host="+this.host),this.connectionKey&&(H+=",connectionKey="+this.connectionKey),this.connectionSerial!==void 0&&(H+=",connectionSerial="+this.connectionSerial),this.timeSerial&&(H+=",timeSerial="+this.timeSerial),this.format&&(H+=",format="+this.format),H+="]",H},k}();l.TransportParams=N;var _=function(k){r.__extends(H,k);function H(w,T){var M=k.call(this)||this;M.disconnectedRetryCount=0,H.initTransports(),M.realtime=w,M.options=T;var F=T.timeouts,B=F.preferenceConnectTimeout+F.realtimeRequestTimeout;if(M.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:B,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},synchronizing:{state:"connected",terminal:!1,queueEvents:!0,sendEvents:!1,forceQueueEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:F.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:F.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:F.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},M.state=M.states.initialized,M.errorReason=null,M.queuedMessages=new y.default,M.msgSerial=0,M.connectionDetails=void 0,M.connectionId=void 0,M.connectionKey=void 0,M.timeSerial=void 0,M.connectionSerial=void 0,M.connectionStateTtl=F.connectionStateTtl,M.maxIdleInterval=null,M.transports=R.intersect(T.transports||A.default.defaultTransports,H.supportedTransports),M.baseTransport=R.intersect(A.default.baseTransportOrder,M.transports)[0],M.upgradeTransports=R.intersect(M.transports,A.default.upgradeTransports),M.transportPreference=null,M.httpHosts=A.default.getHosts(T),M.activeProtocol=null,M.proposedTransports=[],M.pendingTransports=[],M.host=null,M.lastAutoReconnectAttempt=null,M.lastActivity=null,M.mostRecentMsg=null,M.forceFallbackHost=!1,M.connectCounter=0,i.default.logAction(i.default.LOG_MINOR,"Realtime.ConnectionManager()","started"),i.default.logAction(i.default.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(T.transports||A.default.defaultTransports)+"]"),i.default.logAction(i.default.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+M.transports+"]"),i.default.logAction(i.default.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+M.httpHosts+"]"),!M.transports.length){var W="no requested transports available";throw i.default.logAction(i.default.LOG_ERROR,"realtime.ConnectionManager()",W),new Error(W)}var K=x.default.Config.addEventListener;return K&&(e()&&typeof T.recover=="function"&&K("beforeunload",M.persistConnection.bind(M)),T.closeOnUnload===!0&&K("beforeunload",function(){i.default.logAction(i.default.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),M.requestState({state:"closing"})}),K("online",function(){(M.state==M.states.disconnected||M.state==M.states.suspended)&&(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager caught browser \u2018online\u2019 event","reattempting connection"),M.requestState({state:"connecting"}))}),K("offline",function(){M.state==M.states.connected&&(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager caught browser \u2018offline\u2019 event","disconnecting active transport"),M.disconnectAllTransports())})),M}return H.initTransports=function(){n.default(H),R.arrForEach(x.default.Transports,function(w){w(H)})},H.prototype.createTransportParams=function(w,T){var M=new N(this.options,w,T,this.connectionKey);return this.timeSerial?M.timeSerial=String(this.timeSerial):this.connectionSerial!==void 0&&(M.connectionSerial=this.connectionSerial),M},H.prototype.getTransportParams=function(w){var T=this,M=function(F){if(T.connectionKey){F("resume");return}if(typeof T.options.recover=="string"){F("recover");return}var B=T.options.recover,W=L();if(W&&typeof B=="function"){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data"),B(W,function(K){K?(T.options.recover=W.recoveryKey,F("recover")):F("clean")});return}F("clean")};M(function(F){var B=T.createTransportParams(null,F);if(F==="recover"){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+T.options.recover);var W=T.options.recover.split(":");W&&W[2]&&(T.msgSerial=Number(W[2]))}else i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+B.toString());w(B)})},H.prototype.tryATransport=function(w,T,M){var F=this;i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+T),s.default.tryConnect(H.supportedTransports[T],this,this.realtime.auth,w,function(B,W){var K=F.state;if(K==F.states.closing||K==F.states.closed||K==F.states.failed){W&&(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+K.state+" while we were attempting the transport; closing "+W),W.close()),M(!0);return}if(B){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+T+" "+B.event+", err: "+B.error.toString()),f.default.isTokenErr(B.error)&&!(F.errorReason&&f.default.isTokenErr(F.errorReason))?(F.errorReason=B.error,F.realtime.auth._forceNewToken(null,null,function(X){if(X){F.actOnErrorFromAuthorize(X);return}F.tryATransport(w,T,M)})):B.event==="failed"?(F.notifyState({state:"failed",error:B.error}),M(!0)):B.event==="disconnected"&&(S.isRetriable(B.error)?M(!1):(F.notifyState({state:F.states.connecting.failState,error:B.error}),M(!0)));return}i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+T+"; setting pending"),F.setTransportPending(W,w),M(null,W)})},H.prototype.setTransportPending=function(w,T){var M=this,F=T.mode;i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+w+"; mode = "+F),R.arrDeleteValue(this.proposedTransports,w),this.pendingTransports.push(w);var B=x.default.Defaults.transportPreferenceOrder[x.default.Defaults.transportPreferenceOrder.length-1];w.once("connected",function(K,X,Y,Z){F=="upgrade"?w.shortName!==B&&R.arrIn(M.getUpgradePossibilities(),B)&&M.activeProtocol?setTimeout(function(){M.scheduleTransportActivation(K,w,X,Y,Z)},M.options.timeouts.parallelUpgradeDelay):M.scheduleTransportActivation(K,w,X,Y,Z):(M.activateTransport(K,w,X,Y,Z),x.default.Config.nextTick(function(){M.connectImpl(T)})),F==="recover"&&M.options.recover&&(M.options.recover=null,M.unpersistConnection())});var W=this;w.on(["disconnected","closed","failed"],function(K){W.deactivateTransport(w,this.event,K)}),this.emit("transport.pending",w)},H.prototype.scheduleTransportActivation=function(w,T,M,F,B){var W=this,K=this.activeProtocol&&this.activeProtocol.getTransport(),X=function(){T.disconnect(),R.arrDeleteValue(W.pendingTransports,T)};if(this.state!==this.states.connected&&this.state!==this.states.connecting){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+this.state.state+(this.state===this.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+T.shortName),X();return}if(K&&!b(T,K)){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+T.shortName+" is no better than current active transport "+K.shortName+" - abandoning upgrade"),X();return}i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Scheduling transport upgrade; transport = "+T);var Y=function(Z){var et;if(Z){i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unable to activate transport; transport = "+T+"; err = "+Z);return}if(!T.isConnected){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Proposed transport "+T.shortName+"is no longer connected; abandoning upgrade"),X();return}if(W.state===W.states.connected)i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Currently connected, so temporarily pausing events until the upgrade is complete"),W.state=W.states.synchronizing,et=W.activeProtocol;else if(W.state!==W.states.connecting){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Current connection state ("+W.state.state+(W.state===W.states.synchronizing?", but with an upgrade already in progress":"")+") is not valid to upgrade in; abandoning upgrade to "+T.shortName),X();return}var Q=M!==W.connectionId,nt=Q?B:W;Q&&i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Upgrade resulted in new connectionId; resetting library connection position from "+(W.timeSerial||W.connectionSerial)+" to "+(nt.timeSerial||nt.connectionSerial)+"; upgrade error was "+w),i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Syncing transport; transport = "+T),W.sync(T,nt,function(st,at,rt){if(st){W.state===W.states.synchronizing&&(i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.scheduleTransportActivation()","Unexpected error attempting to sync transport; transport = "+T+"; err = "+st),W.disconnectAllTransports());return}var lt=function(){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Activating transport; transport = "+T),W.activateTransport(w,T,at,F,rt),W.state===W.states.synchronizing?(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, sending queued messages on upgraded transport; transport = "+T),W.state=W.states.connected):i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.scheduleTransportActivation()","Pre-upgrade protocol idle, but state is now "+W.state.state+", so leaving unchanged"),W.state.sendEvents&&W.sendQueuedMessages()};et?et.onceIdle(lt):lt()})};K?this.realtime.channels.onceNopending(Y):Y()},H.prototype.activateTransport=function(w,T,M,F,B){var W=this;i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+T),w&&i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+w),M&&i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+M),F&&i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(F)),B&&i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.activateTransport()","serial =  "+(B.timeSerial||B.connectionSerial)),this.persistTransportPreference(T);var K=this.state,X=this.states.connected.state;if(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+K.state),K.state==this.states.closing.state||K.state==this.states.closed.state||K.state==this.states.failed.state)return i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),T.disconnect(),!1;if(R.arrDeleteValue(this.pendingTransports,T),!T.isConnected)return i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+T+" since it appears to no longer be connected"),!1;var Y=this.activeProtocol;this.activeProtocol=new O.default(T),this.host=T.params.host;var Z=F.connectionKey;if(Z&&this.connectionKey!=Z&&this.setConnection(M,F,B,!!w),this.onConnectionDetailsUpdate(F,T),x.default.Config.nextTick(function(){T.on("connected",function(Q,nt,st){W.onConnectionDetailsUpdate(st,T),W.emit("update",new g.default(X,X,null,Q))})}),K.state===this.states.connected.state?w&&(this.errorReason=this.realtime.connection.errorReason=w,this.emit("update",new g.default(X,X,null,w))):(this.notifyState({state:"connected",error:w}),this.errorReason=this.realtime.connection.errorReason=w||null),this.emit("transport.active",T),Y)if(Y.messageQueue.count()>0&&i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+Y.transport.shortName+", new one is "+T.shortName+") finishing with "+Y.messageQueue.count()+" messages still pending"),Y.transport===T){var et="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+T.shortName+"; stack = "+new Error().stack;i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.activateTransport()",et)}else Y.finish();return R.safeArrForEach(this.pendingTransports,function(Q){if(Q===T){var nt="Assumption violated: activating a transport that is still marked as a pending transport; transport = "+T.shortName+"; stack = "+new Error().stack;i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.activateTransport()",nt),R.arrDeleteValue(W.pendingTransports,T)}else Q.disconnect()}),R.safeArrForEach(this.proposedTransports,function(Q){Q===T?(i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.activateTransport()","Assumption violated: activating a transport that is still marked as a proposed transport; transport = "+T.shortName+"; stack = "+new Error().stack),R.arrDeleteValue(W.proposedTransports,T)):Q.dispose()}),!0},H.prototype.deactivateTransport=function(w,T,M){var F=this.activeProtocol,B=F&&F.getTransport()===w,W=R.arrDeleteValue(this.pendingTransports,w),K=R.arrDeleteValue(this.proposedTransports,w),X=this.noTransportsScheduledForActivation();if(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+w),i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+T+(B?"; was active":W?"; was pending":K?"; was proposed":"")+(X?"":"; another transport is scheduled for activation")),M&&M.message&&i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+M.message),B&&(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(F.getPendingMessages()),x.default.Config.nextTick(function(){F.clearPendingMessages()}),this.activeProtocol=this.host=null,clearTimeout(this.channelResumeCheckTimer)),this.emit("transport.inactive",w),B&&X||B&&T==="failed"||T==="closed"||F===null&&W&&this.pendingTransports.length===0){if(T==="disconnected"&&M&&M.statusCode>500&&this.httpHosts.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:T,error:M,retryImmediately:!0});return}var Y=T==="failed"&&f.default.isTokenErr(M)?"disconnected":T;this.notifyState({state:Y,error:M});return}B&&T==="disconnected"&&this.state!==this.states.synchronizing&&(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.deactivateTransport()","wasActive but another transport is connected and scheduled for activation, so going into the connecting state until it activates"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),this.notifyState({state:"connecting",error:M}))},H.prototype.noTransportsScheduledForActivation=function(){return R.isEmpty(this.pendingTransports)||this.pendingTransports.every(function(w){return!w.isConnected})},H.prototype.sync=function(w,T,M){var F=setTimeout(function(){w.off("sync"),M(new C.default("Timeout waiting for sync response",5e4,500))},this.options.timeouts.realtimeRequestTimeout),B=P.default.fromValues({action:u.SYNC,connectionKey:this.connectionKey});T.timeSerial?B.timeSerial=T.timeSerial:T.connectionSerial!==void 0&&(B.connectionSerial=T.connectionSerial),w.send(B),w.once("sync",function(W,K){clearTimeout(F),M(null,W,K)})},H.prototype.setConnection=function(w,T,M,F){var B=this,W=this.connectionId,K=W&&W!==w,X=!W&&F;(K||X)&&(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0),this.connectionId!==w?(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),x.default.Config.nextTick(function(){B.realtime.channels.reattach()})):this.options.checkChannelsOnResume&&(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.setConnection()","Same connectionId; checkChannelsOnResume is enabled"),clearTimeout(this.channelResumeCheckTimer),this.realtime.channels.resetAttachedMsgIndicators(),this.channelResumeCheckTimer=setTimeout(function(){B.realtime.channels.checkAttachedMsgIndicators(w)},3e4)),this.realtime.connection.id=this.connectionId=w,this.realtime.connection.key=this.connectionKey=T.connectionKey;var Y=K||!W;this.setConnectionSerial(M,Y,!1)},H.prototype.clearConnection=function(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.clearConnectionSerial(),this.msgSerial=0,this.unpersistConnection()},H.prototype.setConnectionSerial=function(w,T,M){var F=w.timeSerial,B=w.connectionSerial;if(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.setConnectionSerial()","Updating connection serial; serial = "+B+"; timeSerial = "+F+"; force = "+T+"; previous = "+this.connectionSerial),F!==void 0){if(F<=this.timeSerial&&!T)return M&&i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with timeSerial "+F+", but current timeSerial is "+this.timeSerial+"; assuming message is a duplicate and discarding it"),!0;this.realtime.connection.timeSerial=this.timeSerial=F,this.setRecoveryKey();return}if(B!==void 0){if(B<=this.connectionSerial&&!T)return M&&i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.setConnectionSerial()","received message with connectionSerial "+B+", but current connectionSerial is "+this.connectionSerial+"; assuming message is a duplicate and discarding it"),!0;this.realtime.connection.serial=this.connectionSerial=B,this.setRecoveryKey()}},H.prototype.clearConnectionSerial=function(){this.realtime.connection.serial=this.connectionSerial=void 0,this.realtime.connection.timeSerial=this.timeSerial=void 0,this.clearRecoveryKey()},H.prototype.setRecoveryKey=function(){this.realtime.connection.recoveryKey=this.connectionKey+":"+(this.timeSerial||this.connectionSerial)+":"+this.msgSerial},H.prototype.clearRecoveryKey=function(){this.realtime.connection.recoveryKey=null},H.prototype.checkConnectionStateFreshness=function(){if(!(!this.lastActivity||!this.connectionId)){var w=R.now()-this.lastActivity;w>this.connectionStateTtl+this.maxIdleInterval&&(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+w+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended")}},H.prototype.persistConnection=function(){if(e()){var w=this.realtime.connection.recoveryKey;w&&E({recoveryKey:w,disconnectedAt:R.now(),location:d.location,clientId:this.realtime.auth.clientId})}},H.prototype.unpersistConnection=function(){p()},H.prototype.getError=function(){return this.errorReason||this.getStateError()},H.prototype.getStateError=function(){return S.default[this.state.state]},H.prototype.activeState=function(){return this.state.queueEvents||this.state.sendEvents},H.prototype.enactStateChange=function(w){var T=w.current==="failed"?i.default.LOG_ERROR:i.default.LOG_MAJOR;i.default.logAction(T,"Connection state",w.current+(w.reason?"; reason: "+w.reason:"")),i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+w.current+"; reason = "+(w.reason&&w.reason.message));var M=this.state=this.states[w.current];w.reason&&(this.errorReason=w.reason,this.realtime.connection.errorReason=w.reason),(M.terminal||M.state==="suspended")&&this.clearConnection(),this.emit("connectionstate",w)},H.prototype.startTransitionTimer=function(w){var T=this;i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+w.state),this.transitionTimer&&(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer)),this.transitionTimer=setTimeout(function(){T.transitionTimer&&(T.transitionTimer=null,i.default.logAction(i.default.LOG_MINOR,"ConnectionManager "+w.state+" timer expired","requesting new state: "+w.failState),T.notifyState({state:w.failState}))},w.retryDelay)},H.prototype.cancelTransitionTimer=function(){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)},H.prototype.startSuspendTimer=function(){var w=this;this.suspendTimer||(this.suspendTimer=setTimeout(function(){w.suspendTimer&&(w.suspendTimer=null,i.default.logAction(i.default.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),w.states.connecting.failState="suspended",w.notifyState({state:"suspended"}))},this.connectionStateTtl))},H.prototype.checkSuspendTimer=function(w){w!=="disconnected"&&w!=="suspended"&&w!=="connecting"&&this.cancelSuspendTimer()},H.prototype.cancelSuspendTimer=function(){this.states.connecting.failState="disconnected",this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)},H.prototype.startRetryTimer=function(w){var T=this;this.retryTimer=setTimeout(function(){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),T.retryTimer=null,T.requestState({state:"connecting"})},w)},H.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},H.prototype.notifyState=function(w){var T=this,M=w.state,F=M==="disconnected"&&(this.state===this.states.connected||this.state===this.states.synchronizing||w.retryImmediately||this.state===this.states.connecting&&w.error&&f.default.isTokenErr(w.error)&&!(this.errorReason&&f.default.isTokenErr(this.errorReason)));if(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+M+(F?"; will retry connection immediately":"")),M!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(w.state),(M==="suspended"||M==="connected")&&(this.disconnectedRetryCount=0),!this.state.terminal)){var B=this.states[w.state],W=B.retryDelay;B.state==="disconnected"&&(this.disconnectedRetryCount++,W=B.retryDelay*R.getBackoffCoefficient(this.disconnectedRetryCount)*R.getJitterCoefficient());var K=new g.default(this.state.state,B.state,W,w.error||S.default[B.state]);if(F){var X=function(){T.state===T.states.disconnected&&(T.lastAutoReconnectAttempt=R.now(),T.requestState({state:"connecting"}))},Y=this.lastAutoReconnectAttempt&&R.now()-this.lastAutoReconnectAttempt+1;Y&&Y<1e3?(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+Y+"ms ago, waiting another "+(1e3-Y)+"ms before trying again"),setTimeout(X,1e3-Y)):x.default.Config.nextTick(X)}else(M==="disconnected"||M==="suspended")&&this.startRetryTimer(W);(M==="disconnected"&&!F||M==="suspended"||B.terminal)&&x.default.Config.nextTick(function(){T.disconnectAllTransports()}),M=="connected"&&!this.activeProtocol&&i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(K),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(M,K.reason),this.failQueuedMessages(K.reason))}},H.prototype.requestState=function(w){var T=this,M=w.state;if(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+M+"; current state: "+this.state.state),M!=this.state.state&&(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(M),!(M=="connecting"&&this.state.state=="connected")&&!(M=="closing"&&this.state.state=="closed"))){var F=this.states[M],B=new g.default(this.state.state,F.state,null,w.error||S.default[F.state]);this.enactStateChange(B),M=="connecting"&&x.default.Config.nextTick(function(){T.startConnect()}),M=="closing"&&this.closeImpl()}},H.prototype.startConnect=function(){var w=this;if(this.state!==this.states.connecting){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);return}var T=this.realtime.auth,M=++this.connectCounter,F=function(){w.checkConnectionStateFreshness(),w.getTransportParams(function(W){M===w.connectCounter&&w.connectImpl(W,M)})};if(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),T.method==="basic")F();else{var B=function(W){M===w.connectCounter&&(W?w.actOnErrorFromAuthorize(W):F())};this.errorReason&&f.default.isTokenErr(this.errorReason)?T._forceNewToken(null,null,B):T._ensureValidAuthCredentials(!1,B)}},H.prototype.connectImpl=function(w,T){var M=this.state.state;M!==this.states.connecting.state&&M!==this.states.connected.state?i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect (or connected to upgrade), but was "+M):this.pendingTransports.length?i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.connectImpl()","Transports "+this.pendingTransports[0].toString()+" currently pending; taking no action"):M==this.states.connected.state?this.upgradeIfNeeded(w):this.transports.length>1&&this.getTransportPreference()?this.connectPreference(w):this.connectBase(w,T)},H.prototype.connectPreference=function(w){var T=this,M=this.getTransportPreference(),F=!1;R.arrIn(this.transports,M)||(this.unpersistTransportPreference(),this.connectImpl(w)),i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.connectPreference()","Trying to connect with stored transport preference "+M);var B=setTimeout(function(){F=!0,T.state.state!==T.states.connected.state&&(i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.connectPreference()","Shortcircuit connection attempt with "+M+" failed; clearing preference and trying from scratch"),T.disconnectAllTransports(),T.unpersistTransportPreference()),T.connectImpl(w)},this.options.timeouts.preferenceConnectTimeout);w.host=this.httpHosts[0],this.tryATransport(w,M,function(W,K){clearTimeout(B),F&&K?(K.off(),K.disconnect(),R.arrDeleteValue(T.pendingTransports,K)):!K&&!W&&(T.unpersistTransportPreference(),T.connectImpl(w))})},H.prototype.connectBase=function(w,T){var M=this,F=function(Y){M.notifyState({state:M.states.connecting.failState,error:Y})},B=this.httpHosts.slice(),W=function(Y,Z){T===M.connectCounter&&!Z&&!Y&&X()};i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.connectBase()","Trying to connect with base transport "+this.baseTransport);var K=B.shift();if(!K){F(new C.default("Unable to connect (no available host)",80003,404));return}w.host=K;var X=function(){if(!B.length){F(new C.default("Unable to connect (and no more fallback hosts to try)",80003,404));return}if(!M.realtime.http.checkConnectivity){F(new C.default("Internal error: Http.checkConnectivity not set",null,500));return}M.realtime.http.checkConnectivity(function(Y,Z){if(T===M.connectCounter){if(Y){F(Y);return}if(!Z){F(new C.default("Unable to connect (network unreachable)",80003,404));return}w.host=R.arrPopRandomElement(B),M.tryATransport(w,M.baseTransport,W)}})};if(this.forceFallbackHost&&B.length){this.forceFallbackHost=!1,X();return}this.tryATransport(w,this.baseTransport,W)},H.prototype.getUpgradePossibilities=function(){var w=this.activeProtocol.getTransport().shortName,T=R.arrIndexOf(this.upgradeTransports,w);return this.upgradeTransports.slice(T+1)},H.prototype.upgradeIfNeeded=function(w){var T=this,M=this.getUpgradePossibilities();i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.upgradeIfNeeded()","upgrade possibilities: "+x.default.Config.inspect(M)),M.length&&R.arrForEach(M,function(F){var B=T.createTransportParams(w.host,"upgrade");T.tryATransport(B,F,v)})},H.prototype.closeImpl=function(){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),R.safeArrForEach(this.pendingTransports,function(w){i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+w),w&&w.close()}),R.safeArrForEach(this.proposedTransports,function(w){i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.closeImpl()","Disposing of proposed transport: "+w),w&&w.dispose()}),this.activeProtocol&&(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})},H.prototype.onAuthUpdated=function(w,T){var M=this,F;switch(this.state.state){case"connected":{if(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport"),(this.pendingTransports.length||this.proposedTransports.length)&&this.state!==this.states.synchronizing){this.disconnectAllTransports(!0);var B=this.activeProtocol.getTransport().params;x.default.Config.nextTick(function(){M.state.state==="connected"&&M.upgradeIfNeeded(B)})}var W=(F=this.activeProtocol)===null||F===void 0?void 0:F.getTransport();W&&W.onAuthUpdated&&W.onAuthUpdated(w);var K=P.default.fromValues({action:u.AUTH,auth:{accessToken:w.token}});this.send(K);var X=function(){M.off(Y),T(null,w)},Y=function(et){et.current==="failed"&&(M.off(X),M.off(Y),T(et.reason||M.getStateError()))};this.once("connectiondetails",X),this.on("connectionstate",Y);break}case"connecting":i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");var Z=function(et){switch(et.current){case"connected":M.off(Z),T(null,w);break;case"failed":case"closed":case"suspended":M.off(Z),T(et.reason||M.getStateError());break;default:break}};this.on("connectionstate",Z),this.state.state==="connecting"?this.startConnect():this.requestState({state:"connecting"})}}},H.prototype.disconnectAllTransports=function(w){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"+(w?" except the active transport":"")),this.connectCounter++,R.safeArrForEach(this.pendingTransports,function(T){i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+T),T&&T.disconnect()}),this.pendingTransports=[],R.safeArrForEach(this.proposedTransports,function(T){i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disposing of proposed transport: "+T),T&&T.dispose()}),this.proposedTransports=[],this.activeProtocol&&!w&&(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())},H.prototype.send=function(w,T,M){M=M||v;var F=this.state;if(F.sendEvents){i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new O.PendingMessage(w,M));return}var B=T&&F.queueEvents||F.forceQueueEvents;if(!B){var W="rejecting event, queueEvent was "+T+", state was "+F.state;i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.send()",W),M(this.errorReason||new C.default(W,9e4,400));return}i.default.shouldLog(i.default.LOG_MICRO)&&i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+P.default.stringify(w)),this.queue(w,M)},H.prototype.sendImpl=function(w){var T=w.message;w.ackRequired&&!w.sendAttempted&&(T.msgSerial=this.msgSerial++,this.setRecoveryKey());try{this.activeProtocol.send(w)}catch(M){i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+M.stack)}},H.prototype.queue=function(w,T){i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.queue()","queueing event");var M=this.queuedMessages.last(),F=this.options.maxMessageSize;M&&!M.sendAttempted&&G(M.message,w,F)?(M.merged||(M.callback=h.default.create([M.callback]),M.merged=!0),M.callback.push(T)):this.queuedMessages.push(new O.PendingMessage(w,T))},H.prototype.sendQueuedMessages=function(){i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");for(var w;w=this.queuedMessages.shift();)this.sendImpl(w)},H.prototype.queuePendingMessages=function(w){w&&w.length&&(i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+w.length+" pending messages"),this.queuedMessages.prepend(w))},H.prototype.failQueuedMessages=function(w){var T=this.queuedMessages.count();T>0&&(i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+T+" queued messages, err = "+R.inspectError(w)),this.queuedMessages.completeAllMessages(w))},H.prototype.onChannelMessage=function(w,T){var M=this.activeProtocol&&T===this.activeProtocol.getTransport(),F=R.arrIn(this.pendingTransports,T)&&this.state==this.states.synchronizing,B=w.action===u.MESSAGE||w.action===u.PRESENCE;if(M||F){if(B){var W=this.setConnectionSerial(w,!1,!0);if(W)return;if(P.default.isDuplicate(w,this.mostRecentMsg)){i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.onChannelMessage()","received message with different connectionSerial, but same message id as a previous; discarding; id = "+w.id);return}this.mostRecentMsg=w}this.realtime.channels.onChannelMessage(w)}else R.arrIndexOf([u.ACK,u.NACK,u.ERROR],w.action)>-1?this.realtime.channels.onChannelMessage(w):i.default.logAction(i.default.LOG_MICRO,"ConnectionManager.onChannelMessage()","received message "+JSON.stringify(w)+"on defunct transport; discarding")},H.prototype.ping=function(w,T){var M=this;if(w){i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.ping()","transport = "+w);var F=function(){w.off("heartbeat",K),T(new C.default("Timeout waiting for heartbeat response",5e4,500))},B=R.now(),W=R.cheapRandStr(),K=function(Q){if(Q===W){w.off("heartbeat",K),clearTimeout(X);var nt=R.now()-B;T(null,nt)}},X=setTimeout(F,this.options.timeouts.realtimeRequestTimeout);w.on("heartbeat",K),w.ping(W);return}if(this.state.state!=="connected"){T(new C.default("Unable to ping service; not connected",4e4,400));return}var Y=!1,Z=function(Q,nt){M.off("transport.active",et),Y||(Y=!0,T(Q,nt))},et=function(){Y||(Y=!0,x.default.Config.nextTick(function(){M.ping(null,T)}))};this.on("transport.active",et),this.ping(this.activeProtocol.getTransport(),Z)},H.prototype.abort=function(w){this.activeProtocol.getTransport().fail(w)},H.prototype.registerProposedTransport=function(w){this.proposedTransports.push(w)},H.prototype.getTransportPreference=function(){var w,T;return this.transportPreference||a()&&((T=(w=x.default.WebStorage)===null||w===void 0?void 0:w.get)===null||T===void 0?void 0:T.call(w,I))},H.prototype.persistTransportPreference=function(w){var T,M;R.arrIn(A.default.upgradeTransports,w.shortName)&&(this.transportPreference=w.shortName,a()&&((M=(T=x.default.WebStorage)===null||T===void 0?void 0:T.set)===null||M===void 0||M.call(T,I,w.shortName)))},H.prototype.unpersistTransportPreference=function(){var w,T;this.transportPreference=null,a()&&((T=(w=x.default.WebStorage)===null||w===void 0?void 0:w.remove)===null||T===void 0||T.call(w,I))},H.prototype.actOnErrorFromAuthorize=function(w){if(w.code===40171)this.notifyState({state:"failed",error:w});else if(w.statusCode===o.default.Forbidden){var T="Client configured authentication provider returned 403; failing the connection";i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",T),this.notifyState({state:"failed",error:new C.default(T,80019,403,w)})}else{var T="Client configured authentication provider request failed";i.default.logAction(i.default.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",T),this.notifyState({state:this.state.failState,error:new C.default(T,80019,401,w)})}},H.prototype.onConnectionDetailsUpdate=function(w,T){if(!!w){this.connectionDetails=w,w.maxMessageSize&&(this.options.maxMessageSize=w.maxMessageSize);var M=w.clientId;if(M){var F=this.realtime.auth._uncheckedSetClientId(M);if(F){i.default.logAction(i.default.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",F.message),T.fail(F);return}}var B=w.connectionStateTtl;B&&(this.connectionStateTtl=B),this.maxIdleInterval=w.maxIdleInterval,this.emit("connectiondetails",w)}},H.supportedTransports={},H}(m.default);l.default=_}).call(this,t(12))},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(10)),P=d.__importStar(t(2)),R=d.__importDefault(t(7)),O=d.__importDefault(t(3)),A=d.__importDefault(t(19)),x=d.__importDefault(t(5)),m=d.__importDefault(t(0)),y=r.default.Action,i=r.default.fromValues({action:y.CLOSE}),g=r.default.fromValues({action:y.DISCONNECT}),S=function(C){d.__extends(f,C);function f(c,h,n,s){var o=C.call(this)||this;return s&&(n.format=void 0,n.heartbeats=!0),o.connectionManager=c,c.registerProposedTransport(o),o.auth=h,o.params=n,o.timeouts=n.options.timeouts,o.format=n.format,o.isConnected=!1,o.isFinished=!1,o.isDisposed=!1,o.maxIdleInterval=null,o.idleTimer=null,o.lastActivity=null,o}return f.prototype.connect=function(){},f.prototype.close=function(){this.isConnected&&this.requestClose(),this.finish("closed",A.default.closed)},f.prototype.disconnect=function(c){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",c||A.default.disconnected)},f.prototype.fail=function(c){this.isConnected&&this.requestDisconnect(),this.finish("failed",c||A.default.failed)},f.prototype.finish=function(c,h){var n;this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout((n=this.idleTimer)!==null&&n!==void 0?n:void 0),this.idleTimer=null,this.emit(c,h),this.dispose())},f.prototype.onProtocolMessage=function(c){switch(O.default.shouldLog(O.default.LOG_MICRO)&&O.default.logAction(O.default.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+r.default.stringify(c)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),c.action){case y.HEARTBEAT:O.default.logAction(O.default.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",c.id);break;case y.CONNECTED:this.onConnect(c),this.emit("connected",c.error,c.connectionId,c.connectionDetails,c);break;case y.CLOSED:this.onClose(c);break;case y.DISCONNECTED:this.onDisconnect(c);break;case y.ACK:this.emit("ack",c.msgSerial,c.count);break;case y.NACK:this.emit("nack",c.msgSerial,c.count,c.error);break;case y.SYNC:if(c.connectionId!==void 0){this.emit("sync",c.connectionId,c);break}this.connectionManager.onChannelMessage(c,this);break;case y.AUTH:this.auth.authorize(function(h){h&&O.default.logAction(O.default.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+P.inspectError(h))});break;case y.ERROR:if(O.default.logAction(O.default.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+m.default.Config.inspect(c.error)+(c.channel?", channel: "+c.channel:"")),c.channel===void 0){this.onFatalError(c);break}this.connectionManager.onChannelMessage(c,this);break;default:this.connectionManager.onChannelMessage(c,this)}},f.prototype.onConnect=function(c){if(this.isConnected=!0,!c.connectionDetails)throw new Error("Transport.onConnect(): Connect message recieved without connectionDetails");var h=c.connectionDetails.maxIdleInterval;h&&(this.maxIdleInterval=h+this.timeouts.realtimeRequestTimeout,this.onActivity())},f.prototype.onDisconnect=function(c){var h=c&&c.error;O.default.logAction(O.default.LOG_MINOR,"Transport.onDisconnect()","err = "+P.inspectError(h)),this.finish("disconnected",h)},f.prototype.onFatalError=function(c){var h=c&&c.error;O.default.logAction(O.default.LOG_MINOR,"Transport.onFatalError()","err = "+P.inspectError(h)),this.finish("failed",h)},f.prototype.onClose=function(c){var h=c&&c.error;O.default.logAction(O.default.LOG_MINOR,"Transport.onClose()","err = "+P.inspectError(h)),this.finish("closed",h)},f.prototype.requestClose=function(){O.default.logAction(O.default.LOG_MINOR,"Transport.requestClose()",""),this.send(i)},f.prototype.requestDisconnect=function(){O.default.logAction(O.default.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(g)},f.prototype.ping=function(c){var h={action:r.default.Action.HEARTBEAT};c&&(h.id=c),this.send(r.default.fromValues(h))},f.prototype.dispose=function(){O.default.logAction(O.default.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()},f.prototype.onActivity=function(){!this.maxIdleInterval||(this.lastActivity=this.connectionManager.lastActivity=P.now(),this.setIdleTimer(this.maxIdleInterval+100))},f.prototype.setIdleTimer=function(c){var h=this;this.idleTimer||(this.idleTimer=setTimeout(function(){h.onIdleTimerExpire()},c))},f.prototype.onIdleTimerExpire=function(){if(!this.lastActivity||!this.maxIdleInterval)throw new Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;var c=P.now()-this.lastActivity,h=this.maxIdleInterval-c;if(h<=0){var n="No activity seen from realtime in "+c+"ms; assuming connection has dropped";O.default.logAction(O.default.LOG_ERROR,"Transport.onIdleTimerExpire()",n),this.disconnect(new x.default(n,80003,408))}else this.setIdleTimer(h+100)},f.tryConnect=function(c,h,n,s,o){var a=new c(h,n,s),e,u=function(I){clearTimeout(e),o({event:this.event,error:I})},v=h.options.timeouts.realtimeRequestTimeout;e=setTimeout(function(){a.off(["preconnect","disconnected","failed"]),a.dispose(),u.call({event:"disconnected"},new x.default("Timeout waiting for transport to indicate itself viable",5e4,500))},v),a.on(["failed","disconnected"],u),a.on("preconnect",function(){O.default.logAction(O.default.LOG_MINOR,"Transport.tryConnect()","viable transport "+a),clearTimeout(e),a.off(["failed","disconnected"],u),o(null,a)}),a.connect()},f}(R.default);l.default=S},function(D,l,t){(function(d,r){D.exports=l=r(t(6),t(39),t(23))})(this,function(d){return function(){var r=d,P=r.lib,R=P.Base,O=P.WordArray,A=r.algo,x=A.MD5,m=A.EvpKDF=R.extend({cfg:R.extend({keySize:128/32,hasher:x,iterations:1}),init:function(y){this.cfg=this.cfg.extend(y)},compute:function(y,i){for(var g,S=this.cfg,C=S.hasher.create(),f=O.create(),c=f.words,h=S.keySize,n=S.iterations;c.length<h;){g&&C.update(g),g=C.update(y).finalize(i),C.reset();for(var s=1;s<n;s++)g=C.finalize(g),C.reset();f.concat(g)}return f.sigBytes=h*4,f}});r.EvpKDF=function(y,i,g){return m.create(g).compute(y,i)}}(),d.EvpKDF})},function(D,l,t){(function(d,r){D.exports=l=r(t(6),t(27))})(this,function(d){d.lib.Cipher||function(r){var P=d,R=P.lib,O=R.Base,A=R.WordArray,x=R.BufferedBlockAlgorithm,m=P.enc,y=m.Utf8,i=m.Base64,g=P.algo,S=g.EvpKDF,C=R.Cipher=x.extend({cfg:O.extend(),createEncryptor:function(p,b){return this.create(this._ENC_XFORM_MODE,p,b)},createDecryptor:function(p,b){return this.create(this._DEC_XFORM_MODE,p,b)},init:function(p,b,G){this.cfg=this.cfg.extend(G),this._xformMode=p,this._key=b,this.reset()},reset:function(){x.reset.call(this),this._doReset()},process:function(p){return this._append(p),this._process()},finalize:function(p){p&&this._append(p);var b=this._doFinalize();return b},keySize:128/32,ivSize:128/32,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function p(b){return typeof b=="string"?E:I}return function(b){return{encrypt:function(G,N,_){return p(N).encrypt(b,G,N,_)},decrypt:function(G,N,_){return p(N).decrypt(b,G,N,_)}}}}()}),f=R.StreamCipher=C.extend({_doFinalize:function(){var p=this._process(!0);return p},blockSize:1}),c=P.mode={},h=R.BlockCipherMode=O.extend({createEncryptor:function(p,b){return this.Encryptor.create(p,b)},createDecryptor:function(p,b){return this.Decryptor.create(p,b)},init:function(p,b){this._cipher=p,this._iv=b}}),n=c.CBC=function(){var p=h.extend();p.Encryptor=p.extend({processBlock:function(G,N){var _=this._cipher,k=_.blockSize;b.call(this,G,N,k),_.encryptBlock(G,N),this._prevBlock=G.slice(N,N+k)}}),p.Decryptor=p.extend({processBlock:function(G,N){var _=this._cipher,k=_.blockSize,H=G.slice(N,N+k);_.decryptBlock(G,N),b.call(this,G,N,k),this._prevBlock=H}});function b(G,N,_){var k,H=this._iv;H?(k=H,this._iv=r):k=this._prevBlock;for(var w=0;w<_;w++)G[N+w]^=k[w]}return p}(),s=P.pad={},o=s.Pkcs7={pad:function(p,b){for(var G=b*4,N=G-p.sigBytes%G,_=N<<24|N<<16|N<<8|N,k=[],H=0;H<N;H+=4)k.push(_);var w=A.create(k,N);p.concat(w)},unpad:function(p){var b=p.words[p.sigBytes-1>>>2]&255;p.sigBytes-=b}},a=R.BlockCipher=C.extend({cfg:C.cfg.extend({mode:n,padding:o}),reset:function(){var p;C.reset.call(this);var b=this.cfg,G=b.iv,N=b.mode;this._xformMode==this._ENC_XFORM_MODE?p=N.createEncryptor:(p=N.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==p?this._mode.init(this,G&&G.words):(this._mode=p.call(N,this,G&&G.words),this._mode.__creator=p)},_doProcessBlock:function(p,b){this._mode.processBlock(p,b)},_doFinalize:function(){var p,b=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(b.pad(this._data,this.blockSize),p=this._process(!0)):(p=this._process(!0),b.unpad(p)),p},blockSize:128/32}),e=R.CipherParams=O.extend({init:function(p){this.mixIn(p)},toString:function(p){return(p||this.formatter).stringify(this)}}),u=P.format={},v=u.OpenSSL={stringify:function(p){var b,G=p.ciphertext,N=p.salt;return N?b=A.create([1398893684,1701076831]).concat(N).concat(G):b=G,b.toString(i)},parse:function(p){var b,G=i.parse(p),N=G.words;return N[0]==1398893684&&N[1]==1701076831&&(b=A.create(N.slice(2,4)),N.splice(0,4),G.sigBytes-=16),e.create({ciphertext:G,salt:b})}},I=R.SerializableCipher=O.extend({cfg:O.extend({format:v}),encrypt:function(p,b,G,N){N=this.cfg.extend(N);var _=p.createEncryptor(G,N),k=_.finalize(b),H=_.cfg;return e.create({ciphertext:k,key:G,iv:H.iv,algorithm:p,mode:H.mode,padding:H.padding,blockSize:p.blockSize,formatter:N.format})},decrypt:function(p,b,G,N){N=this.cfg.extend(N),b=this._parse(b,N.format);var _=p.createDecryptor(G,N).finalize(b.ciphertext);return _},_parse:function(p,b){return typeof p=="string"?b.parse(p,this):p}}),U=P.kdf={},L=U.OpenSSL={execute:function(p,b,G,N){N||(N=A.random(64/8));var _=S.create({keySize:b+G}).compute(p,N),k=A.create(_.words.slice(b),G*4);return _.sigBytes=b*4,e.create({key:_,iv:k,salt:N})}},E=R.PasswordBasedCipher=I.extend({cfg:I.cfg.extend({kdf:L}),encrypt:function(p,b,G,N){N=this.cfg.extend(N);var _=N.kdf.execute(G,p.keySize,p.ivSize);N.iv=_.iv;var k=I.encrypt.call(this,p,b,_.key,N);return k.mixIn(_),k},decrypt:function(p,b,G,N){N=this.cfg.extend(N),b=this._parse(b,N.format);var _=N.kdf.execute(G,p.keySize,p.ivSize,b.salt);N.iv=_.iv;var k=I.decrypt.call(this,p,b,_.key,N);return k}})}()})},function(D,l,t){"use strict";l.__esModule=!0,l.Request=l.createRequest=void 0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(11)),R=d.__importDefault(t(0)),O=d.__importDefault(t(7)),A=d.__importDefault(t(5)),x=d.__importDefault(t(8)),m=d.__importDefault(t(3)),y=d.__importDefault(t(20)),i=r.getGlobalObject(),g=function(){},S=i._ablyjs_jsonp={};S._=function(o){return S["_"+o]||g};var C=1,f="jsonp";function c(o,a,e,u,v,I,U){return I=I||x.default.TIMEOUTS,new n(void 0,o,a,r.copy(e),u,v,I,U)}l.createRequest=c;var h=function(o){d.__extends(a,o);function a(e,u,v){var I=o.call(this,e,u,v)||this;return I.shortName=f,v.stream=!1,I}return a.isAvailable=function(){return R.default.Config.jsonpSupported&&R.default.Config.allowComet},a.prototype.toString=function(){return"JSONPTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},a.prototype.createRequest=function(e,u,v,I,U,L,E){return L=(this===null||this===void 0?void 0:this.timeouts)||L||x.default.TIMEOUTS,c(e,u,v,I,U,L,E)},a}(P.default),n=function(o){d.__extends(a,o);function a(e,u,v,I,U,L,E,p){var b=o.call(this)||this;return e===void 0&&(e=C++),b.id=e,b.uri=u,b.params=I||{},b.params.rnd=r.cheapRandStr(),v&&(v["X-Ably-Version"]&&(b.params.v=v["X-Ably-Version"]),v["X-Ably-Lib"]&&(b.params.lib=v["X-Ably-Lib"])),b.body=U,b.method=p,b.requestMode=L,b.timeouts=E,b.requestComplete=!1,b}return a.prototype.exec=function(){var e=this,u=this.id,v=this.body,I=this.method,U=this.uri,L=this.params;L.callback="_ablyjs_jsonp._("+u+")",L.envelope="jsonp",v&&(L.body=v),I&&I!=="get"&&(L.method=I);var E=this.script=document.createElement("script"),p=U+r.toQueryString(L);E.src=p,E.src.split("/").slice(-1)[0]!==p.split("/").slice(-1)[0]&&m.default.logAction(m.default.LOG_ERROR,"JSONP Request.exec()","Warning: the browser appears to have truncated the script URI. This will likely result in the request failing due to an unparseable body param"),E.async=!0,E.type="text/javascript",E.charset="UTF-8",E.onerror=function(N){e.complete(new A.default("JSONP script error (event: "+R.default.Config.inspect(N)+")",null,400))},S["_"+u]=function(N){if(N.statusCode){var _=N.response;if(N.statusCode==204)e.complete(null,null,null,N.statusCode);else if(!_)e.complete(new A.default("Invalid server response: no envelope detected",null,500));else if(N.statusCode<400||r.isArray(_))e.complete(null,_,N.headers,N.statusCode);else{var k=_.error||new A.default("Error response received from server",null,N.statusCode);e.complete(k)}}else e.complete(null,N)};var b=this.requestMode==y.default.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout;this.timer=setTimeout(this.abort.bind(this),b);var G=document.getElementsByTagName("head")[0];G.insertBefore(E,G.firstChild)},a.prototype.complete=function(e,u,v,I){if(v=v||{},!this.requestComplete){this.requestComplete=!0;var U=void 0;u&&(U=typeof u=="string"?"text/plain":"application/json",v["content-type"]=U,this.emit("data",u)),this.emit("complete",e,u,v,!0,I),this.dispose()}},a.prototype.abort=function(){this.dispose()},a.prototype.dispose=function(){var e=this.timer;e&&(clearTimeout(e),this.timer=null);var u=this.script;u.parentNode&&u.parentNode.removeChild(u),delete S[this.id],this.emit("disposed")},a}(O.default);l.Request=n;function s(o){return i.JSONPTransport=h,h.isAvailable()&&(o.supportedTransports[f]=h),h}l.default=s},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(3)),R=d.__importDefault(t(8)),O=d.__importDefault(t(16)),A=d.__importDefault(t(45)),x=d.__importDefault(t(18)),m=d.__importDefault(t(33)),y=d.__importDefault(t(5)),i=d.__importDefault(t(48)),g=d.__importDefault(t(17)),S=d.__importDefault(t(0)),C=function(){},f=function(){function h(n){if(!n){var s="no options provided";throw P.default.logAction(P.default.LOG_ERROR,"Rest()",s),new Error(s)}var o=R.default.objectifyOptions(n);o.log&&P.default.setLog(o.log.level,o.log.handler),P.default.logAction(P.default.LOG_MICRO,"Rest()","initialized with clientOptions "+S.default.Config.inspect(n));var a=this.options=R.default.normaliseOptions(o);if(a.key){var e=a.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!e){var s="invalid key parameter";throw P.default.logAction(P.default.LOG_ERROR,"Rest()",s),new y.default(s,40400,404)}a.keyName=e[1],a.keySecret=e[2]}if("clientId"in a)if(typeof a.clientId=="string"||a.clientId===null){if(a.clientId==="*")throw new y.default('Can\u2019t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}else throw new y.default("clientId must be either a string or null",40012,400);P.default.logAction(P.default.LOG_MINOR,"Rest()","started; version = "+R.default.version),this.baseUri=this.authority=function(u){return R.default.getHttpScheme(a)+u+":"+R.default.getPort(a,!1)},this._currentFallback=null,this.serverTimeOffset=null,this.http=new S.default.Http,this.auth=new O.default(this,a),this.channels=new c(this),this.push=new A.default(this)}return h.prototype.stats=function(n,s){if(s===void 0)if(typeof n=="function")s=n,n=null;else{if(this.options.promises)return r.promisify(this,"stats",arguments);s=C}var o=r.defaultGetHeaders(),a=this.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,e=this.http.supportsLinkHeaders?void 0:a;this.options.headers&&r.mixin(o,this.options.headers),new x.default(this,"/stats",o,e,function(u,v,I){for(var U=I?u:JSON.parse(u),L=0;L<U.length;L++)U[L]=i.default.fromValues(U[L]);return U}).get(n,s)},h.prototype.time=function(n,s){var o=this;if(s===void 0){if(typeof n=="function")s=n,n=null;else if(this.options.promises)return r.promisify(this,"time",arguments)}var a=s||C,e=r.defaultGetHeaders();this.options.headers&&r.mixin(e,this.options.headers);var u=function(v){return o.authority(v)+"/time"};this.http.do(g.default.Get,this,u,e,null,n,function(v,I,U,L){if(v){a(v);return}L||(I=JSON.parse(I));var E=I[0];if(!E){a(new y.default("Internal error (unexpected result type from GET /time)",5e4,500));return}o.serverTimeOffset=E-r.now(),a(null,E)})},h.prototype.request=function(n,s,o,a,e,u){var v=this.options.useBinaryProtocol,I=v?S.default.Config.msgpack.encode:JSON.stringify,U=v?S.default.Config.msgpack.decode:JSON.parse,L=v?r.Format.msgpack:r.Format.json,E=this.http.supportsLinkHeaders?void 0:L;o=o||{};var p=n.toLowerCase(),b=p=="get"?r.defaultGetHeaders(L):r.defaultPostHeaders(L);if(u===void 0){if(this.options.promises)return r.promisify(this,"request",arguments);u=C}typeof a!="string"&&(a=I(a)),this.options.headers&&r.mixin(b,this.options.headers),e&&r.mixin(b,e);var G=new x.default(this,s,b,E,function(N,_,k){return r.ensureArray(k?N:U(N))},!0);if(!r.arrIn(S.default.Http.methods,p))throw new y.default("Unsupported method "+p,40500,405);r.arrIn(S.default.Http.methodsWithBody,p)?G[p](o,a,u):G[p](o,u)},h.prototype.setLog=function(n){P.default.setLog(n.level,n.handler)},h.Promise=function(n){return n=R.default.objectifyOptions(n),n.promises=!0,new h(n)},h.Callbacks=h,h.Platform=S.default,h}(),c=function(){function h(n){this.rest=n,this.all={}}return h.prototype.get=function(n,s){n=String(n);var o=this.all[n];return o?s&&o.setOptions(s):this.all[n]=o=new m.default(this.rest,n,s),o},h.prototype.release=function(n){delete this.all[String(n)]},h}();l.default=f},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){return function(r){var P=d,R=P.lib,O=R.WordArray,A=R.Hasher,x=P.algo,m=[],y=[];(function(){function S(h){for(var n=r.sqrt(h),s=2;s<=n;s++)if(!(h%s))return!1;return!0}function C(h){return(h-(h|0))*4294967296|0}for(var f=2,c=0;c<64;)S(f)&&(c<8&&(m[c]=C(r.pow(f,1/2))),y[c]=C(r.pow(f,1/3)),c++),f++})();var i=[],g=x.SHA256=A.extend({_doReset:function(){this._hash=new O.init(m.slice(0))},_doProcessBlock:function(S,C){for(var f=this._hash.words,c=f[0],h=f[1],n=f[2],s=f[3],o=f[4],a=f[5],e=f[6],u=f[7],v=0;v<64;v++){if(v<16)i[v]=S[C+v]|0;else{var I=i[v-15],U=(I<<25|I>>>7)^(I<<14|I>>>18)^I>>>3,L=i[v-2],E=(L<<15|L>>>17)^(L<<13|L>>>19)^L>>>10;i[v]=U+i[v-7]+E+i[v-16]}var p=o&a^~o&e,b=c&h^c&n^h&n,G=(c<<30|c>>>2)^(c<<19|c>>>13)^(c<<10|c>>>22),N=(o<<26|o>>>6)^(o<<21|o>>>11)^(o<<7|o>>>25),_=u+N+p+y[v]+i[v],k=G+b;u=e,e=a,a=o,o=s+_|0,s=n,n=h,h=c,c=_+k|0}f[0]=f[0]+c|0,f[1]=f[1]+h|0,f[2]=f[2]+n|0,f[3]=f[3]+s|0,f[4]=f[4]+o|0,f[5]=f[5]+a|0,f[6]=f[6]+e|0,f[7]=f[7]+u|0},_doFinalize:function(){var S=this._data,C=S.words,f=this._nDataBytes*8,c=S.sigBytes*8;return C[c>>>5]|=128<<24-c%32,C[(c+64>>>9<<4)+14]=r.floor(f/4294967296),C[(c+64>>>9<<4)+15]=f,S.sigBytes=C.length*4,this._process(),this._hash},clone:function(){var S=A.clone.call(this);return S._hash=this._hash.clone(),S}});P.SHA256=A._createHelper(g),P.HmacSHA256=A._createHmacHelper(g)}(Math),d.SHA256})},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){return d.enc.Utf8})},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(7)),R=d.__importDefault(t(3)),O=d.__importDefault(t(34)),A=d.__importDefault(t(9)),x=d.__importDefault(t(5)),m=d.__importDefault(t(18)),y=d.__importDefault(t(24)),i=d.__importDefault(t(0));function g(){}var S=9;function C(h){return r.arrEvery(h,function(n){return!n.id})}function f(h){var n=h||{};if(n.cipher){if(!i.default.Crypto)throw new Error("Encryption not enabled; use ably.encryption.js instead");var s=i.default.Crypto.getCipher(n.cipher);n.cipher=s.cipherParams,n.channelCipher=s.cipher}else"cipher"in n&&(n.cipher=void 0,n.channelCipher=null);return n}var c=function(h){d.__extends(n,h);function n(s,o,a){var e=h.call(this)||this;return R.default.logAction(R.default.LOG_MINOR,"Channel()","started; name = "+o),e.rest=s,e.name=o,e.basePath="/channels/"+encodeURIComponent(o),e.presence=new O.default(e),e.channelOptions=f(a),e}return n.prototype.setOptions=function(s){this.channelOptions=f(s)},n.prototype.history=function(s,o){if(R.default.logAction(R.default.LOG_MICRO,"Channel.history()","channel = "+this.name),o===void 0)if(typeof s=="function")o=s,s=null;else{if(this.rest.options.promises)return r.promisify(this,"history",arguments);o=g}this._history(s,o)},n.prototype._history=function(s,o){var a=this.rest,e=a.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,u=this.rest.http.supportsLinkHeaders?void 0:e,v=r.defaultGetHeaders(e);a.options.headers&&r.mixin(v,a.options.headers);var I=this.channelOptions;new m.default(a,this.basePath+"/messages",v,u,function(U,L,E){return A.default.fromResponseBody(U,I,E?void 0:e)}).get(s,o)},n.prototype.publish=function(){var s=this,o=arguments.length,a=arguments[0],e=arguments[1],u=arguments[o-1],v,I;if(typeof u!="function"){if(this.rest.options.promises)return r.promisify(this,"publish",arguments);u=g}if(typeof a=="string"||a===null)v=[A.default.fromValues({name:a,data:e})],I=arguments[2];else if(r.isObject(a))v=[A.default.fromValues(a)],I=arguments[1];else if(r.isArray(a))v=A.default.fromValuesArray(a),I=arguments[1];else throw new x.default("The single-argument form of publish() expects a message object or an array of message objects",40013,400);(typeof I!="object"||!I)&&(I={});var U=this.rest,L=U.options,E=L.useBinaryProtocol?r.Format.msgpack:r.Format.json,p=U.options.idempotentRestPublishing,b=r.defaultPostHeaders(E);if(L.headers&&r.mixin(b,L.headers),p&&C(v)){var G=r.randomString(S);r.arrForEach(v,function(N,_){N.id=G+":"+_.toString()})}A.default.encodeArray(v,this.channelOptions,function(N){if(N){u(N);return}var _=A.default.getMessagesSize(v),k=L.maxMessageSize;if(_>k){u(new x.default("Maximum size of messages that can be published at once exceeded ( was "+_+" bytes; limit is "+k+" bytes)",40009,400));return}s._publish(A.default.serialize(v,E),b,I,u)})},n.prototype._publish=function(s,o,a,e){y.default.post(this.rest,this.basePath+"/messages",s,o,a,null,e)},n.prototype.status=function(s){if(typeof s!="function"&&this.rest.options.promises)return r.promisify(this,"status",[]);var o=this.rest.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,a=r.defaultPostHeaders(o);y.default.get(this.rest,this.basePath,a,{},o,s||g)},n}(P.default);l.default=c},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(7)),R=d.__importDefault(t(3)),O=d.__importDefault(t(18)),A=d.__importDefault(t(14));function x(){}var m=function(y){d.__extends(i,y);function i(g){var S=y.call(this)||this;return S.channel=g,S.basePath=g.basePath+"/presence",S}return i.prototype.get=function(g,S){if(R.default.logAction(R.default.LOG_MICRO,"Presence.get()","channel = "+this.channel.name),S===void 0)if(typeof g=="function")S=g,g=null;else{if(this.channel.rest.options.promises)return r.promisify(this,"get",arguments);S=x}var C=this.channel.rest,f=C.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,c=this.channel.rest.http.supportsLinkHeaders?void 0:f,h=r.defaultGetHeaders(f);C.options.headers&&r.mixin(h,C.options.headers);var n=this.channel.channelOptions;new O.default(C,this.basePath,h,c,function(s,o,a){return A.default.fromResponseBody(s,n,a?void 0:f)}).get(g,S)},i.prototype.history=function(g,S){R.default.logAction(R.default.LOG_MICRO,"Presence.history()","channel = "+this.channel.name),this._history(g,S)},i.prototype._history=function(g,S){if(S===void 0)if(typeof g=="function")S=g,g=null;else{if(this.channel.rest.options.promises)return r.promisify(this,"_history",arguments);S=x}var C=this.channel.rest,f=C.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,c=this.channel.rest.http.supportsLinkHeaders?void 0:f,h=r.defaultGetHeaders(f);C.options.headers&&r.mixin(h,C.options.headers);var n=this.channel.channelOptions;new O.default(C,this.basePath+"/history",h,c,function(s,o,a){return A.default.fromResponseBody(s,n,a?void 0:f)}).get(g,S)},i}(P.default);l.default=m},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(7)),P=d.__importDefault(t(3)),R=function(O){d.__extends(A,O);function A(){var x=O.call(this)||this;return x.messages=[],x}return A.prototype.count=function(){return this.messages.length},A.prototype.push=function(x){this.messages.push(x)},A.prototype.shift=function(){return this.messages.shift()},A.prototype.last=function(){return this.messages[this.messages.length-1]},A.prototype.copyAll=function(){return this.messages.slice()},A.prototype.append=function(x){this.messages.push.apply(this.messages,x)},A.prototype.prepend=function(x){this.messages.unshift.apply(this.messages,x)},A.prototype.completeMessages=function(x,m,y){P.default.logAction(P.default.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+x+"; count = "+m),y=y||null;var i=this.messages;if(i.length===0)throw new Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");var g=i[0];if(g){var S=g.message.msgSerial,C=x+m;if(C>S)for(var f=i.splice(0,C-S),c=0,h=f;c<h.length;c++){var n=h[c];n.callback(y)}i.length==0&&this.emit("idle")}},A.prototype.completeAllMessages=function(x){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,x)},A.prototype.clear=function(){P.default.logAction(P.default.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")},A}(r.default);l.default=R},function(D,l,t){"use strict";l.__esModule=!0;var d=function(){function r(P,R,O,A){this.previous=P,this.current=R,O&&(this.retryIn=O),A&&(this.reason=A)}return r}();l.default=d},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(10)),P=d.__importDefault(t(7)),R=d.__importStar(t(2)),O=d.__importDefault(t(33)),A=d.__importDefault(t(3)),x=d.__importDefault(t(54)),m=d.__importDefault(t(9)),y=d.__importDefault(t(38)),i=d.__importDefault(t(5)),g=d.__importDefault(t(14)),S=d.__importDefault(t(19)),C=r.default.Action,f=function(){},c="statechange",h="sync";function n(o){if(o&&"params"in o&&!R.isObject(o.params))return new i.default("options.params must be an object",4e4,400);if(o&&"modes"in o){if(!R.isArray(o.modes))return new i.default("options.modes must be an array",4e4,400);for(var a=0;a<o.modes.length;a++){var e=o.modes[a];if(!e||typeof e!="string"||!R.arrIn(r.default.channelModes,String.prototype.toUpperCase.call(e)))return new i.default("Invalid channel mode: "+e,4e4,400)}}}var s=function(o){d.__extends(a,o);function a(e,u,v){var I=o.call(this,e,u,v)||this;return I.retryCount=0,I.history=function(U,L){if(A.default.logAction(A.default.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name),L===void 0)if(typeof U=="function")L=U,U=null;else{if(this.rest.options.promises)return R.promisify(this,"history",arguments);L=f}if(U&&U.untilAttach){if(this.state!=="attached"){L(new i.default("option untilAttach requires the channel to be attached",4e4,400));return}if(!this.properties.attachSerial){L(new i.default("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400));return}delete U.untilAttach,U.from_serial=this.properties.attachSerial}O.default.prototype._history.call(this,U,L)},I.whenState=function(U,L){return P.default.prototype.whenState.call(I,U,I.state,L)},A.default.logAction(A.default.LOG_MINOR,"RealtimeChannel()","started; name = "+u),I.realtime=e,I.presence=new x.default(I),I.connectionManager=e.connection.connectionManager,I.state="initialized",I.subscriptions=new P.default,I.syncChannelSerial=void 0,I.properties={attachSerial:void 0},I.setOptions(v),I.errorReason=null,I._requestedFlags=null,I._mode=null,I._attachedMsgIndicator=!1,I._attachResume=!1,I._decodingContext={channelOptions:I.channelOptions,plugins:e.options.plugins||{},baseEncodedPreviousPayload:void 0},I._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},I._allChannelChanges=new P.default,I}return a.invalidStateError=function(e){return{statusCode:400,code:90001,message:"Channel operation failed as channel state is "+e}},a.processListenerArgs=function(e){return e=Array.prototype.slice.call(e),typeof e[0]=="function"&&e.unshift(null),e[e.length-1]==null&&e.pop(),e},a.prototype.setOptions=function(e,u){if(!u&&this.rest.options.promises)return R.promisify(this,"setOptions",arguments);var v=u||function(U){U&&A.default.logAction(A.default.LOG_ERROR,"RealtimeChannel.setOptions()","Set options failed: "+U.toString())},I=n(e);if(I){v(I);return}O.default.prototype.setOptions.call(this,e),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(e)?(this.attachImpl(),this._allChannelChanges.once(function(U){switch(this.event){case"update":case"attached":v==null||v(null);return;default:v==null||v(U.reason);return}})):v()},a.prototype._shouldReattachToSetOptions=function(e){return(this.state==="attached"||this.state==="attaching")&&(e.params||e.modes)},a.prototype.publish=function(){for(var e=this,u=[],v=0;v<arguments.length;v++)u[v]=arguments[v];var I=u[0],U=u.length,L=u[U-1];if(typeof L!="function"){if(this.realtime.options.promises)return R.promisify(this,"publish",arguments);L=f,++U}if(!this.connectionManager.activeState()){L(this.connectionManager.getError());return}if(U==2)if(R.isObject(I))I=[m.default.fromValues(I)];else if(R.isArray(I))I=m.default.fromValuesArray(I);else throw new i.default("The single-argument form of publish() expects a message object or an array of message objects",40013,400);else I=[m.default.fromValues({name:u[0],data:u[1]})];var E=this.realtime.options.maxMessageSize;m.default.encodeArray(I,this.channelOptions,function(p){if(p){L(p);return}var b=m.default.getMessagesSize(I);if(b>E){L(new i.default("Maximum size of messages that can be published at once exceeded ( was "+b+" bytes; limit is "+E+" bytes)",40009,400));return}e.__publish(I,L)})},a.prototype.__publish=function(e,u){A.default.logAction(A.default.LOG_MICRO,"RealtimeChannel.publish()","message count = "+e.length);var v=this.state;switch(v){case"failed":case"suspended":u(i.default.fromValues(a.invalidStateError(v)));break;default:{A.default.logAction(A.default.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+v);var I=new r.default;I.action=C.MESSAGE,I.channel=this.name,I.messages=e,this.sendMessage(I,u);break}}},a.prototype.onEvent=function(e){A.default.logAction(A.default.LOG_MICRO,"RealtimeChannel.onEvent()","received message");for(var u=this.subscriptions,v=0;v<e.length;v++){var I=e[v];u.emit(I.name,I)}},a.prototype.attach=function(e,u){var v;if(typeof e=="function"?(u=e,v=null):v=e,!u){if(this.realtime.options.promises)return R.promisify(this,"attach",arguments);u=function(I){I&&A.default.logAction(A.default.LOG_MAJOR,"RealtimeChannel.attach()","Channel attach failed: "+I.toString())}}if(v)A.default.deprecated("channel.attach() with flags","channel.setOptions() with channelOptions.params"),this._requestedFlags=v;else if(this.state==="attached"){u();return}this._attach(!1,null,u)},a.prototype._attach=function(e,u,v){v||(v=function(U){U&&A.default.logAction(A.default.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+U.toString())});var I=this.connectionManager;if(!I.activeState()){v(I.getError());return}(this.state!=="attaching"||e)&&this.requestState("attaching",u),this.once(function(U){switch(this.event){case"attached":v==null||v();break;case"detached":case"suspended":case"failed":v==null||v(U.reason||I.getError()||new i.default("Unable to attach; reason unknown; state = "+this.event,9e4,500));break;case"detaching":v==null||v(new i.default("Attach request superseded by a subsequent detach request",9e4,409));break}})},a.prototype.attachImpl=function(){A.default.logAction(A.default.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message"),this.setInProgress(c,!0);var e=r.default.fromValues({action:C.ATTACH,channel:this.name,params:this.channelOptions.params});this._requestedFlags?e.encodeModesToFlags(this._requestedFlags):this.channelOptions.modes&&e.encodeModesToFlags(R.allToUpperCase(this.channelOptions.modes)),this._attachResume&&e.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(e.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(e,f)},a.prototype.detach=function(e){if(!e){if(this.realtime.options.promises)return R.promisify(this,"detach",arguments);e=f}var u=this.connectionManager;if(!u.activeState()){e(u.getError());return}switch(this.state){case"suspended":this.notifyState("detached"),e();break;case"detached":e();break;case"failed":e(new i.default("Unable to detach; channel state = failed",90001,400));break;default:this.requestState("detaching");case"detaching":this.once(function(v){switch(this.event){case"detached":e();break;case"attached":case"suspended":case"failed":e(v.reason||u.getError()||new i.default("Unable to detach; reason unknown; state = "+this.event,9e4,500));break;case"attaching":e(new i.default("Detach request superseded by a subsequent attach request",9e4,409));break}})}},a.prototype.detachImpl=function(e){this.connectionManager.mostRecentMsg&&this.connectionManager.mostRecentMsg.channel===this.name&&(this.connectionManager.mostRecentMsg=null),A.default.logAction(A.default.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message"),this.setInProgress(c,!0);var u=r.default.fromValues({action:C.DETACH,channel:this.name});this.sendMessage(u,e||f)},a.prototype.subscribe=function(){for(var e=[],u=0;u<arguments.length;u++)e[u]=arguments[u];var v=a.processListenerArgs(e),I=v[0],U=v[1],L=v[2];if(!L&&this.realtime.options.promises)return R.promisify(this,"subscribe",[I,U]);if(this.state==="failed"){L==null||L(i.default.fromValues(a.invalidStateError("failed")));return}return I&&typeof I=="object"&&!Array.isArray(I)?this._subscribeFilter(I,U):this.subscriptions.on(I,U),this.attach(L||f)},a.prototype._subscribeFilter=function(e,u){var v=function(I){var U,L,E,p,b,G,N={name:I.name,refTimeserial:(L=(U=I.extras)===null||U===void 0?void 0:U.ref)===null||L===void 0?void 0:L.timeserial,refType:(p=(E=I.extras)===null||E===void 0?void 0:E.ref)===null||p===void 0?void 0:p.type,isRef:!!(!((G=(b=I.extras)===null||b===void 0?void 0:b.ref)===null||G===void 0)&&G.timeserial),clientId:I.clientId};Object.entries(e).find(function(_){var k=_[0],H=_[1];return H!==void 0?N[k]!==H:!1})||u(I)};this._addFilteredSubscription(e,u,v),this.subscriptions.on(v)},a.prototype._addFilteredSubscription=function(e,u,v){var I;if(this.filteredSubscriptions||(this.filteredSubscriptions=new Map),this.filteredSubscriptions.has(u)){var U=this.filteredSubscriptions.get(u);U.set(e,((I=U==null?void 0:U.get(e))===null||I===void 0?void 0:I.concat(v))||[v])}else this.filteredSubscriptions.set(u,new Map([[e,[v]]]))},a.prototype._getAndDeleteFilteredSubscriptions=function(e,u){var v=this;if(!this.filteredSubscriptions)return[];if(!u&&e)return Array.from(this.filteredSubscriptions.entries()).map(function(E){var p,b=E[0],G=E[1],N=G.get(e);return G.delete(e),G.size===0&&((p=v.filteredSubscriptions)===null||p===void 0||p.delete(b)),N}).reduce(function(E,p){var b;return p?(b=E).concat.apply(b,p):E},[]);if(!u||!this.filteredSubscriptions.has(u))return[];var I=this.filteredSubscriptions.get(u);if(!e){var U=Array.from(I.values()).reduce(function(E,p){return E.concat.apply(E,p)},[]);return this.filteredSubscriptions.delete(u),U}var L=I.get(e);return I.delete(e),L||[]},a.prototype.unsubscribe=function(){for(var e=this,u,v=[],I=0;I<arguments.length;I++)v[I]=arguments[I];var U=a.processListenerArgs(v),L=U[0],E=U[1];if(typeof L=="object"&&!E||((u=this.filteredSubscriptions)===null||u===void 0?void 0:u.has(E))){this._getAndDeleteFilteredSubscriptions(L,E).forEach(function(p){return e.subscriptions.off(p)});return}this.subscriptions.off(L,E)},a.prototype.sync=function(){switch(this.state){case"initialized":case"detaching":case"detached":throw new i.default("Unable to sync to channel; not attached",4e4);default:}var e=this.connectionManager;if(!e.activeState())throw e.getError();var u=r.default.fromValues({action:C.SYNC,channel:this.name});this.syncChannelSerial&&(u.channelSerial=this.syncChannelSerial),e.send(u)},a.prototype.sendMessage=function(e,u){this.connectionManager.send(e,this.realtime.options.queueMessages,u)},a.prototype.sendPresence=function(e,u){var v=r.default.fromValues({action:C.PRESENCE,channel:this.name,presence:R.isArray(e)?g.default.fromValuesArray(e):[g.default.fromValues(e)]});this.sendMessage(v,u)},a.prototype.onMessage=function(e){var u,v=!1;switch(e.action){case C.ATTACHED:{this._attachedMsgIndicator=!0,this.properties.attachSerial=e.channelSerial,this._mode=e.getMode(),this.params=e.params||{};var I=e.decodeModesFromFlags();this.modes=I&&R.allToLowerCase(I)||void 0;var U=e.hasFlag("RESUMED"),L=e.hasFlag("HAS_PRESENCE");if(this.state==="attached"){this.setInProgress(c,!1),U||this.presence.onAttached(L);var E=new y.default(this.state,this.state,U,e.error);this._allChannelChanges.emit("update",E),(!U||this.channelOptions.updateOnAttached)&&this.emit("update",E)}else this.state==="detaching"?this.checkPendingState():this.notifyState("attached",e.error,U,L);break}case C.DETACHED:{var p=e.error?i.default.fromValues(e.error):new i.default("Channel detached",90001,404);this.state==="detaching"?this.notifyState("detached",p):this.state==="attaching"?this.notifyState("suspended",p):this.requestState("attaching",p);break}case C.SYNC:if(v=!0,u=this.syncChannelSerial=e.channelSerial,!e.presence)break;case C.PRESENCE:{for(var b=e.presence,G=e.id,N=e.connectionId,_=e.timestamp,k=this.channelOptions,H=void 0,w=0;w<b.length;w++)try{H=b[w],g.default.decode(H,k),H.connectionId||(H.connectionId=N),H.timestamp||(H.timestamp=_),H.id||(H.id=G+":"+w)}catch(K){A.default.logAction(A.default.LOG_ERROR,"RealtimeChannel.onMessage()",K.toString())}this.presence.setPresence(b,v,u);break}case C.MESSAGE:{if(this.state!=="attached"){A.default.logAction(A.default.LOG_MAJOR,"RealtimeChannel.onMessage()",'Message "'+e.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');return}var T=e.messages,M=T[0],F=T[T.length-1],G=e.id,N=e.connectionId,_=e.timestamp;if(M.extras&&M.extras.delta&&M.extras.delta.from!==this._lastPayload.messageId){var B='Delta message decode failure - previous message not available for message "'+e.id+'" on this channel "'+this.name+'".';A.default.logAction(A.default.LOG_ERROR,"RealtimeChannel.onMessage()",B),this._startDecodeFailureRecovery(new i.default(B,40018,400));break}for(var w=0;w<T.length;w++){var B=T[w];try{m.default.decode(B,this._decodingContext)}catch(Q){switch(A.default.logAction(A.default.LOG_ERROR,"RealtimeChannel.onMessage()",Q.toString()),Q.code){case 40018:this._startDecodeFailureRecovery(Q);return;case 40019:case 40021:this.notifyState("failed",Q);return}}B.connectionId||(B.connectionId=N),B.timestamp||(B.timestamp=_),B.id||(B.id=G+":"+w)}this._lastPayload.messageId=F.id,this._lastPayload.protocolMessageChannelSerial=e.channelSerial,this.onEvent(T);break}case C.ERROR:{var W=e.error;W&&W.code==80016?this.checkPendingState():this.notifyState("failed",i.default.fromValues(W));break}default:A.default.logAction(A.default.LOG_ERROR,"RealtimeChannel.onMessage()","Fatal protocol error: unrecognised action ("+e.action+")"),this.connectionManager.abort(S.default.unknownChannelErr)}},a.prototype._startDecodeFailureRecovery=function(e){var u=this;this._lastPayload.decodeFailureRecoveryInProgress||(A.default.logAction(A.default.LOG_MAJOR,"RealtimeChannel.onMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,e,function(){u._lastPayload.decodeFailureRecoveryInProgress=!1}))},a.prototype.onAttached=function(){A.default.logAction(A.default.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)},a.prototype.notifyState=function(e,u,v,I){if(A.default.logAction(A.default.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+e),this.clearStateTimer(),e!==this.state){this.presence.actOnChannelState(e,I,u),e==="suspended"&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),u&&(this.errorReason=u);var U=new y.default(this.state,e,v,u),L=e==="failed"?A.default.LOG_ERROR:A.default.LOG_MAJOR;A.default.logAction(L,'Channel state for channel "'+this.name+'"',e+(u?"; reason: "+u:"")),e!=="attaching"&&e!=="suspended"&&(this.retryCount=0),e==="attached"?(this.onAttached(),this.setInProgress(h,I),this.setInProgress(c,!1)):(e==="detached"||e==="failed"||e==="suspended")&&(this.setInProgress(c,!1),this.setInProgress(h,!1)),e==="attached"?this._attachResume=!0:(e==="detaching"||e==="failed")&&(this._attachResume=!1),this.state=e,this._allChannelChanges.emit(e,U),this.emit(e,U)}},a.prototype.requestState=function(e,u){A.default.logAction(A.default.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+e),this.notifyState(e,u),this.checkPendingState()},a.prototype.checkPendingState=function(){var e=this.connectionManager.state;if(!(e.sendEvents||e.forceQueueEvents)){A.default.logAction(A.default.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);return}switch(A.default.logAction(A.default.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync();break;default:break}},a.prototype.timeoutPendingState=function(){switch(this.state){case"attaching":{var e=new i.default("Channel attach timed out",90007,408);this.notifyState("suspended",e);break}case"detaching":{var e=new i.default("Channel detach timed out",90007,408);this.notifyState("attached",e);break}default:this.checkPendingState();break}},a.prototype.startStateTimerIfNotRunning=function(){var e=this;this.stateTimer||(this.stateTimer=setTimeout(function(){A.default.logAction(A.default.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),e.stateTimer=null,e.timeoutPendingState()},this.realtime.options.timeouts.realtimeRequestTimeout))},a.prototype.clearStateTimer=function(){var e=this.stateTimer;e&&(clearTimeout(e),this.stateTimer=null)},a.prototype.startRetryTimer=function(){var e=this;if(!this.retryTimer){this.retryCount++;var u=this.realtime.options.timeouts.channelRetryTimeout*R.getJitterCoefficient()*R.getBackoffCoefficient(this.retryCount);this.retryTimer=setTimeout(function(){e.state==="suspended"&&e.connectionManager.state.sendEvents&&(e.retryTimer=null,A.default.logAction(A.default.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),e.requestState("attaching"))},u)}},a.prototype.cancelRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},a.prototype.setInProgress=function(e,u){this.rest.channels.setInProgress(this,e,u)},a.prototype.getReleaseErr=function(){var e=this.state;return e==="initialized"||e==="detached"||e==="failed"?null:new i.default("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+e,90001,400)},a.progressOps={statechange:c,sync:h},a}(O.default);l.default=s},function(D,l,t){"use strict";l.__esModule=!0;var d=function(){function r(P,R,O,A){this.previous=P,this.current=R,R==="attached"&&(this.resumed=O),A&&(this.reason=A)}return r}();l.default=d},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){return function(){var r=d,P=r.lib,R=P.WordArray,O=P.Hasher,A=r.algo,x=[],m=A.SHA1=O.extend({_doReset:function(){this._hash=new R.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(y,i){for(var g=this._hash.words,S=g[0],C=g[1],f=g[2],c=g[3],h=g[4],n=0;n<80;n++){if(n<16)x[n]=y[i+n]|0;else{var s=x[n-3]^x[n-8]^x[n-14]^x[n-16];x[n]=s<<1|s>>>31}var o=(S<<5|S>>>27)+h+x[n];n<20?o+=(C&f|~C&c)+1518500249:n<40?o+=(C^f^c)+1859775393:n<60?o+=(C&f|C&c|f&c)-1894007588:o+=(C^f^c)-899497514,h=c,c=f,f=C<<30|C>>>2,C=S,S=o}g[0]=g[0]+S|0,g[1]=g[1]+C|0,g[2]=g[2]+f|0,g[3]=g[3]+c|0,g[4]=g[4]+h|0},_doFinalize:function(){var y=this._data,i=y.words,g=this._nDataBytes*8,S=y.sigBytes*8;return i[S>>>5]|=128<<24-S%32,i[(S+64>>>9<<4)+14]=Math.floor(g/4294967296),i[(S+64>>>9<<4)+15]=g,y.sigBytes=i.length*4,this._process(),this._hash},clone:function(){var y=O.clone.call(this);return y._hash=this._hash.clone(),y}});r.SHA1=O._createHelper(m),r.HmacSHA1=O._createHmacHelper(m)}(),d.SHA1})},function(D,l,t){"use strict";l.__esModule=!0;function d(n){if(n===void 0)return"undefined";var s,o;if(n instanceof ArrayBuffer?(o="ArrayBuffer",s=new DataView(n)):n instanceof DataView&&(o="DataView",s=n),!s)return JSON.stringify(n);for(var a=[],e=0;e<n.byteLength;e++){if(e>20){a.push("...");break}var u=s.getUint8(e).toString(16);u.length===1&&(u="0"+u),a.push(u)}return"<"+o+" "+a.join(" ")+">"}function r(n,s,o){for(var a=0,e=o.length;a<e;a++){var u=o.charCodeAt(a);if(u<128){n.setUint8(s++,u>>>0&127|0);continue}if(u<2048){n.setUint8(s++,u>>>6&31|192),n.setUint8(s++,u>>>0&63|128);continue}if(u<65536){n.setUint8(s++,u>>>12&15|224),n.setUint8(s++,u>>>6&63|128),n.setUint8(s++,u>>>0&63|128);continue}if(u<1114112){n.setUint8(s++,u>>>18&7|240),n.setUint8(s++,u>>>12&63|128),n.setUint8(s++,u>>>6&63|128),n.setUint8(s++,u>>>0&63|128);continue}throw new Error("bad codepoint "+u)}}function P(n,s,o){for(var a="",e=s,u=s+o;e<u;e++){var v=n.getUint8(e);if((v&128)===0){a+=String.fromCharCode(v);continue}if((v&224)===192){a+=String.fromCharCode((v&15)<<6|n.getUint8(++e)&63);continue}if((v&240)===224){a+=String.fromCharCode((v&15)<<12|(n.getUint8(++e)&63)<<6|(n.getUint8(++e)&63)<<0);continue}if((v&248)===240){a+=String.fromCharCode((v&7)<<18|(n.getUint8(++e)&63)<<12|(n.getUint8(++e)&63)<<6|(n.getUint8(++e)&63)<<0);continue}throw new Error("Invalid byte "+v.toString(16))}return a}function R(n){for(var s=0,o=0,a=n.length;o<a;o++){var e=n.charCodeAt(o);if(e<128){s+=1;continue}if(e<2048){s+=2;continue}if(e<65536){s+=3;continue}if(e<1114112){s+=4;continue}throw new Error("bad codepoint "+e)}return s}function O(n,s){var o=h(n,s);if(o!==0){var a=new ArrayBuffer(o),e=new DataView(a);return c(n,e,0,s),a}}var A=(1<<16)*(1<<16),x=1/A;function m(n,s){return s=s||0,n.getInt32(s)*A+n.getUint32(s+4)}function y(n,s){return s=s||0,n.getUint32(s)*A+n.getUint32(s+4)}function i(n,s,o){o<9223372036854776e3?(n.setInt32(s,Math.floor(o*x)),n.setInt32(s+4,o&-1)):(n.setUint32(s,2147483647),n.setUint32(s+4,2147483647))}function g(n,s,o){o<18446744073709552e3?(n.setUint32(s,Math.floor(o*x)),n.setInt32(s+4,o&-1)):(n.setUint32(s,4294967295),n.setUint32(s+4,4294967295))}var S=function(){function n(s,o){var a=this;this.map=function(e){for(var u={},v=0;v<e;v++){var I=a.parse();u[I]=a.parse()}return u},this.bin=function(e){var u=new ArrayBuffer(e);return new Uint8Array(u).set(new Uint8Array(a.view.buffer,a.offset,e),0),a.offset+=e,u},this.buf=this.bin,this.str=function(e){var u=P(a.view,a.offset,e);return a.offset+=e,u},this.array=function(e){for(var u=new Array(e),v=0;v<e;v++)u[v]=a.parse();return u},this.ext=function(e){return a.offset+=e,{type:a.view.getInt8(a.offset),data:a.buf(e)}},this.parse=function(){var e=a.view.getUint8(a.offset),u,v;if((e&128)===0)return a.offset++,e;if((e&240)===128)return v=e&15,a.offset++,a.map(v);if((e&240)===144)return v=e&15,a.offset++,a.array(v);if((e&224)===160)return v=e&31,a.offset++,a.str(v);if((e&224)===224)return u=a.view.getInt8(a.offset),a.offset++,u;switch(e){case 192:return a.offset++,null;case 193:a.offset++;return;case 194:return a.offset++,!1;case 195:return a.offset++,!0;case 196:return v=a.view.getUint8(a.offset+1),a.offset+=2,a.bin(v);case 197:return v=a.view.getUint16(a.offset+1),a.offset+=3,a.bin(v);case 198:return v=a.view.getUint32(a.offset+1),a.offset+=5,a.bin(v);case 199:return v=a.view.getUint8(a.offset+1),a.offset+=2,a.ext(v);case 200:return v=a.view.getUint16(a.offset+1),a.offset+=3,a.ext(v);case 201:return v=a.view.getUint32(a.offset+1),a.offset+=5,a.ext(v);case 202:return u=a.view.getFloat32(a.offset+1),a.offset+=5,u;case 203:return u=a.view.getFloat64(a.offset+1),a.offset+=9,u;case 204:return u=a.view.getUint8(a.offset+1),a.offset+=2,u;case 205:return u=a.view.getUint16(a.offset+1),a.offset+=3,u;case 206:return u=a.view.getUint32(a.offset+1),a.offset+=5,u;case 207:return u=y(a.view,a.offset+1),a.offset+=9,u;case 208:return u=a.view.getInt8(a.offset+1),a.offset+=2,u;case 209:return u=a.view.getInt16(a.offset+1),a.offset+=3,u;case 210:return u=a.view.getInt32(a.offset+1),a.offset+=5,u;case 211:return u=m(a.view,a.offset+1),a.offset+=9,u;case 212:return v=1,a.offset++,a.ext(v);case 213:return v=2,a.offset++,a.ext(v);case 214:return v=4,a.offset++,a.ext(v);case 215:return v=8,a.offset++,a.ext(v);case 216:return v=16,a.offset++,a.ext(v);case 217:return v=a.view.getUint8(a.offset+1),a.offset+=2,a.str(v);case 218:return v=a.view.getUint16(a.offset+1),a.offset+=3,a.str(v);case 219:return v=a.view.getUint32(a.offset+1),a.offset+=5,a.str(v);case 220:return v=a.view.getUint16(a.offset+1),a.offset+=3,a.array(v);case 221:return v=a.view.getUint32(a.offset+1),a.offset+=5,a.array(v);case 222:return v=a.view.getUint16(a.offset+1),a.offset+=3,a.map(v);case 223:return v=a.view.getUint32(a.offset+1),a.offset+=5,a.map(v)}throw new Error("Unknown type 0x"+e.toString(16))},this.offset=o||0,this.view=s}return n}();function C(n){var s=new DataView(n),o=new S(s),a=o.parse();if(o.offset!==n.byteLength)throw new Error(n.byteLength-o.offset+" trailing bytes");return a}function f(n,s){return Object.keys(n).filter(function(o){var a=n[o],e=typeof a;return(!s||a!=null)&&(e!=="function"||!!a.toJSON)})}function c(n,s,o,a){var e=typeof n;if(typeof n=="string"){var u=R(n);if(u<32)return s.setUint8(o,u|160),r(s,o+1,n),1+u;if(u<256)return s.setUint8(o,217),s.setUint8(o+1,u),r(s,o+2,n),2+u;if(u<65536)return s.setUint8(o,218),s.setUint16(o+1,u),r(s,o+3,n),3+u;if(u<4294967296)return s.setUint8(o,219),s.setUint32(o+1,u),r(s,o+5,n),5+u}if(ArrayBuffer.isView&&ArrayBuffer.isView(n)&&(n=n.buffer),n instanceof ArrayBuffer){var v=n.byteLength;if(v<256)return s.setUint8(o,196),s.setUint8(o+1,v),new Uint8Array(s.buffer).set(new Uint8Array(n),o+2),2+v;if(v<65536)return s.setUint8(o,197),s.setUint16(o+1,v),new Uint8Array(s.buffer).set(new Uint8Array(n),o+3),3+v;if(v<4294967296)return s.setUint8(o,198),s.setUint32(o+1,v),new Uint8Array(s.buffer).set(new Uint8Array(n),o+5),5+v}if(typeof n=="number"){if(Math.floor(n)!==n)return s.setUint8(o,203),s.setFloat64(o+1,n),9;if(n>=0){if(n<128)return s.setUint8(o,n),1;if(n<256)return s.setUint8(o,204),s.setUint8(o+1,n),2;if(n<65536)return s.setUint8(o,205),s.setUint16(o+1,n),3;if(n<4294967296)return s.setUint8(o,206),s.setUint32(o+1,n),5;if(n<18446744073709552e3)return s.setUint8(o,207),g(s,o+1,n),9;throw new Error("Number too big 0x"+n.toString(16))}if(n>=-32)return s.setInt8(o,n),1;if(n>=-128)return s.setUint8(o,208),s.setInt8(o+1,n),2;if(n>=-32768)return s.setUint8(o,209),s.setInt16(o+1,n),3;if(n>=-2147483648)return s.setUint8(o,210),s.setInt32(o+1,n),5;if(n>=-9223372036854776e3)return s.setUint8(o,211),i(s,o+1,n),9;throw new Error("Number too small -0x"+(-n).toString(16).substr(1))}if(e==="undefined")return a?0:(s.setUint8(o,212),s.setUint8(o+1,0),s.setUint8(o+2,0),3);if(n===null)return a?0:(s.setUint8(o,192),1);if(e==="boolean")return s.setUint8(o,n?195:194),1;if(typeof n.toJSON=="function")return c(n.toJSON(),s,o,a);if(e==="object"){var I,U=0,L=void 0,E=Array.isArray(n);if(E?I=n.length:(L=f(n,a),I=L.length),I<16?(s.setUint8(o,I|(E?144:128)),U=1):I<65536?(s.setUint8(o,E?220:222),s.setUint16(o+1,I),U=3):I<4294967296&&(s.setUint8(o,E?221:223),s.setUint32(o+1,I),U=5),E)for(var p=0;p<I;p++)U+=c(n[p],s,o+U,a);else if(L)for(var p=0;p<I;p++){var b=L[p];U+=c(b,s,o+U),U+=c(n[b],s,o+U,a)}return U}if(e==="function")return 0;throw new Error("Unknown type "+e)}function h(n,s){var o=typeof n;if(o==="string"){var a=R(n);if(a<32)return 1+a;if(a<256)return 2+a;if(a<65536)return 3+a;if(a<4294967296)return 5+a}if(ArrayBuffer.isView&&ArrayBuffer.isView(n)&&(n=n.buffer),n instanceof ArrayBuffer){var e=n.byteLength;if(e<256)return 2+e;if(e<65536)return 3+e;if(e<4294967296)return 5+e}if(typeof n=="number"){if(Math.floor(n)!==n)return 9;if(n>=0){if(n<128)return 1;if(n<256)return 2;if(n<65536)return 3;if(n<4294967296)return 5;if(n<18446744073709552e3)return 9;throw new Error("Number too big 0x"+n.toString(16))}if(n>=-32)return 1;if(n>=-128)return 2;if(n>=-32768)return 3;if(n>=-2147483648)return 5;if(n>=-9223372036854776e3)return 9;throw new Error("Number too small -0x"+n.toString(16).substr(1))}if(o==="boolean")return 1;if(n===null)return s?0:1;if(n===void 0)return s?0:3;if(typeof n.toJSON=="function")return h(n.toJSON(),s);if(o==="object"){var u,v=0;if(Array.isArray(n)){u=n.length;for(var I=0;I<u;I++)v+=h(n[I],s)}else{var U=f(n,s);u=U.length;for(var I=0;I<u;I++){var L=U[I];v+=h(L)+h(n[L],s)}}if(u<16)return 1+v;if(u<65536)return 3+v;if(u<4294967296)return 5+v;throw new Error("Array or object too long 0x"+u.toString(16))}if(o==="function")return 0;throw new Error("Unknown type "+o)}l.default={encode:O,decode:C,inspect:d,utf8Write:r,utf8Read:P,utf8ByteCount:R}},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(30)),P=d.__importDefault(t(49)),R=d.__importDefault(t(0)),O=d.__importDefault(t(55)),A=d.__importDefault(t(57)),x=d.__importDefault(t(62)),m=d.__importDefault(t(63)),y=d.__importDefault(t(67)),i=d.__importDefault(t(3)),g=t(8),S=d.__importDefault(t(25)),C=d.__importDefault(t(64)),f=d.__importDefault(t(65)),c=d.__importDefault(t(40)),h=d.__importDefault(t(9)),n=d.__importDefault(t(14));R.default.Crypto=A.default,R.default.BufferUtils=O.default,R.default.Http=x.default,R.default.Config=m.default,R.default.Transports=y.default,R.default.WebStorage=C.default,r.default.Crypto=A.default,P.default.Crypto=A.default,r.default.Message=h.default,P.default.Message=h.default,r.default.PresenceMessage=n.default,P.default.PresenceMessage=n.default,P.default.ConnectionManager=S.default,i.default.initLogHandlers(),R.default.Defaults=g.getDefaults(f.default),R.default.Config.agent&&(R.default.Defaults.agent+=" "+R.default.Config.agent),R.default.Config.noUpgrade&&(R.default.Defaults.upgradeTransports=[]),l.default={Rest:r.default,Realtime:P.default,msgpack:c.default}},function(D){D.exports=JSON.parse('{"name":"ably","description":"Realtime client library for Ably, the realtime messaging service","version":"1.2.29","license":"Apache-2.0","bugs":{"url":"https://github.com/ably/ably-js/issues","email":"support@ably.com"},"main":"./build/ably-node.js","typings":"./ably.d.ts","react-native":{"./build/ably-node.js":"./build/ably-reactnative.js"},"browser":{"./build/ably-node.js":"./build/ably-commonjs.js"},"files":["build/**","ably.d.ts","callbacks.d.ts","callbacks.js","promises.d.ts","promises.js","resources/**"],"dependencies":{"@ably/msgpack-js":"^0.4.0","got":"^11.8.2","ws":"^5.1"},"devDependencies":{"@ably/vcdiff-decoder":"1.0.4","@types/crypto-js":"^4.0.1","@types/node":"^15.0.0","@types/request":"^2.48.7","@types/ws":"^8.2.0","@typescript-eslint/eslint-plugin":"^5.14.0","@typescript-eslint/parser":"^5.14.0","async":"ably-forks/async#requirejs","aws-sdk":"^2.1075.0","chai":"^4.2.0","copy-webpack-plugin":"^6.4.1","cors":"~2.7","crypto-js":"ably-forks/crypto-js#crypto-lite","eslint":"^7.13.0","eslint-plugin-security":"^1.4.0","express":"^4.17.1","glob":"~4.4","google-closure-compiler":"^20180610.0.1","grunt":"^1.4.1","grunt-bump":"^0.3.1","grunt-cli":"~1.2.0","grunt-closure-tools":"^1.0.0","grunt-contrib-concat":"~0.5","grunt-shell":"~1.1","grunt-webpack":"^4.0.2","hexy":"~0.2","kexec":"ably-forks/node-kexec#update-for-node-12","minimist":"^1.2.5","mocha":"^8.1.3","null-loader":"^4.0.1","playwright":"^1.10.0","prettier":"^2.5.1","requirejs":"~2.1","shelljs":"~0.8","source-map-explorer":"^2.5.2","ts-loader":"^8.2.0","tsconfig-paths-webpack-plugin":"^3.5.2","tslib":"^2.3.1","typescript":"^4.2.4","webpack":"^4.44.2","webpack-cli":"^4.2.0"},"engines":{"node":">=5.10.x"},"repository":"ably/ably-js","jspm":{"registry":"npm","directories":{"lib":"browser/static"},"main":"ably"},"scripts":{"grunt":"grunt","test":"grunt test","test:node":"grunt test:node","test:webserver":"grunt test:webserver","test:playwright":"node test/support/runPlaywrightTests.js","concat":"grunt concat","build":"grunt build:all","build:node":"grunt build:node","build:browser":"grunt build:browser","requirejs":"grunt requirejs","lint":"eslint .","lint:fix":"eslint --fix .","check-closure-compiler":"grunt check-closure-compiler","prepare":"npm run build","format":"prettier --write --ignore-path .gitignore src test ably.d.ts webpack.config.js Gruntfile.js scripts/cdn_deploy.js","format:check":"prettier --check --ignore-path .gitignore src test ably.d.ts webpack.config.js Gruntfile.js scripts/cdn_deploy.js","sourcemap":"source-map-explorer build/ably.min.js","sourcemap:noencryption":"source-map-explorer build/ably.noencryption.min.js"}}')},function(D,l,t){(function(d,r){D.exports=l=r(t(6),t(31),t(23))})(this,function(d){return d.HmacSHA256})},function(D,l){},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(46)),R=d.__importDefault(t(24)),O=d.__importDefault(t(18)),A=d.__importDefault(t(5)),x=d.__importDefault(t(47)),m=function(){},y=function(){function C(f){this.rest=f,this.admin=new i(f)}return C}(),i=function(){function C(f){this.rest=f,this.deviceRegistrations=new g(f),this.channelSubscriptions=new S(f)}return C.prototype.publish=function(f,c,h){var n=this.rest,s=n.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,o=r.defaultPostHeaders(s),a={},e=r.mixin({recipient:f},c);if(typeof h!="function"){if(this.rest.options.promises)return r.promisify(this,"publish",arguments);h=m}n.options.headers&&r.mixin(o,n.options.headers),n.options.pushFullWait&&r.mixin(a,{fullWait:"true"});var u=r.encodeBody(e,s);R.default.post(n,"/push/publish",u,o,a,null,function(v){return h(v)})},C}(),g=function(){function C(f){this.rest=f}return C.prototype.save=function(f,c){var h=this.rest,n=P.default.fromValues(f),s=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,o=r.defaultPostHeaders(s),a={};if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"save",arguments);c=m}h.options.headers&&r.mixin(o,h.options.headers),h.options.pushFullWait&&r.mixin(a,{fullWait:"true"});var e=r.encodeBody(n,s);R.default.put(h,"/push/deviceRegistrations/"+encodeURIComponent(f.id),e,o,a,null,function(u,v,I,U){c(u,u?void 0:P.default.fromResponseBody(v,U?void 0:s))})},C.prototype.get=function(f,c){var h=this.rest,n=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,s=r.defaultGetHeaders(n),o=f.id||f;if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"get",arguments);c=m}if(typeof o!="string"||!o.length){c(new A.default("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400));return}h.options.headers&&r.mixin(s,h.options.headers),R.default.get(h,"/push/deviceRegistrations/"+encodeURIComponent(o),s,{},null,function(a,e,u,v){c(a,a?void 0:P.default.fromResponseBody(e,v?void 0:n))})},C.prototype.list=function(f,c){var h=this.rest,n=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,s=this.rest.http.supportsLinkHeaders?void 0:n,o=r.defaultGetHeaders(n);if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"list",arguments);c=m}h.options.headers&&r.mixin(o,h.options.headers),new O.default(h,"/push/deviceRegistrations",o,s,function(a,e,u){return P.default.fromResponseBody(a,u?void 0:n)}).get(f,c)},C.prototype.remove=function(f,c){var h=this.rest,n=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,s=r.defaultGetHeaders(n),o={},a=f.id||f;if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"remove",arguments);c=m}if(typeof a!="string"||!a.length){c(new A.default("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400));return}h.options.headers&&r.mixin(s,h.options.headers),h.options.pushFullWait&&r.mixin(o,{fullWait:"true"}),R.default.delete(h,"/push/deviceRegistrations/"+encodeURIComponent(a),s,o,null,function(e){return c(e)})},C.prototype.removeWhere=function(f,c){var h=this.rest,n=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,s=r.defaultGetHeaders(n);if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"removeWhere",arguments);c=m}h.options.headers&&r.mixin(s,h.options.headers),h.options.pushFullWait&&r.mixin(f,{fullWait:"true"}),R.default.delete(h,"/push/deviceRegistrations",s,f,null,function(o){return c(o)})},C}(),S=function(){function C(f){this.remove=C.prototype.removeWhere,this.rest=f}return C.prototype.save=function(f,c){var h=this.rest,n=x.default.fromValues(f),s=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,o=r.defaultPostHeaders(s),a={};if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"save",arguments);c=m}h.options.headers&&r.mixin(o,h.options.headers),h.options.pushFullWait&&r.mixin(a,{fullWait:"true"});var e=r.encodeBody(n,s);R.default.post(h,"/push/channelSubscriptions",e,o,a,null,function(u,v,I,U){c(u,!u&&x.default.fromResponseBody(v,U?void 0:s))})},C.prototype.list=function(f,c){var h=this.rest,n=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,s=this.rest.http.supportsLinkHeaders?void 0:n,o=r.defaultGetHeaders(n);if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"list",arguments);c=m}h.options.headers&&r.mixin(o,h.options.headers),new O.default(h,"/push/channelSubscriptions",o,s,function(a,e,u){return x.default.fromResponseBody(a,u?void 0:n)}).get(f,c)},C.prototype.removeWhere=function(f,c){var h=this.rest,n=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,s=r.defaultGetHeaders(n);if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"removeWhere",arguments);c=m}h.options.headers&&r.mixin(s,h.options.headers),h.options.pushFullWait&&r.mixin(f,{fullWait:"true"}),R.default.delete(h,"/push/channelSubscriptions",s,f,null,function(o){return c(o)})},C.prototype.listChannels=function(f,c){var h=this.rest,n=h.options.useBinaryProtocol?r.Format.msgpack:r.Format.json,s=this.rest.http.supportsLinkHeaders?void 0:n,o=r.defaultGetHeaders(n);if(typeof c!="function"){if(this.rest.options.promises)return r.promisify(this,"listChannels",arguments);c=m}h.options.headers&&r.mixin(o,h.options.headers),h.options.pushFullWait&&r.mixin(f,{fullWait:"true"}),new O.default(h,"/push/channels",o,s,function(a,e,u){for(var v=!u&&n?r.decodeBody(a,n):a,I=0;I<v.length;I++)v[I]=String(v[I]);return v}).get(f,c)},C}();l.default=y},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(5)),R;(function(x){x.Phone="phone",x.Tablet="tablet",x.Desktop="desktop",x.TV="tv",x.Watch="watch",x.Car="car",x.Embedded="embedded",x.Other="other"})(R||(R={}));var O;(function(x){x.Android="android",x.IOS="ios",x.Browser="browser"})(O||(O={}));var A=function(){function x(){}return x.prototype.toJSON=function(){var m,y,i;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:(m=this.push)===null||m===void 0?void 0:m.recipient,state:(y=this.push)===null||y===void 0?void 0:y.state,error:(i=this.push)===null||i===void 0?void 0:i.error}}},x.prototype.toString=function(){var m,y,i,g,S="[DeviceDetails";return this.id&&(S+="; id="+this.id),this.platform&&(S+="; platform="+this.platform),this.formFactor&&(S+="; formFactor="+this.formFactor),this.clientId&&(S+="; clientId="+this.clientId),this.metadata&&(S+="; metadata="+this.metadata),this.deviceIdentityToken&&(S+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),!((m=this.push)===null||m===void 0)&&m.recipient&&(S+="; push.recipient="+JSON.stringify(this.push.recipient)),!((y=this.push)===null||y===void 0)&&y.state&&(S+="; push.state="+this.push.state),!((i=this.push)===null||i===void 0)&&i.error&&(S+="; push.error="+JSON.stringify(this.push.error)),!((g=this.push)===null||g===void 0)&&g.metadata&&(S+="; push.metadata="+this.push.metadata),S+="]",S},x.fromResponseBody=function(m,y){return y&&(m=r.decodeBody(m,y)),r.isArray(m)?x.fromValuesArray(m):x.fromValues(m)},x.fromValues=function(m){return m.error=m.error&&P.default.fromValues(m.error),Object.assign(new x,m)},x.fromValuesArray=function(m){for(var y=m.length,i=new Array(y),g=0;g<y;g++)i[g]=x.fromValues(m[g]);return i},x.toRequestBody=r.encodeBody,x}();l.default=A},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=function(){function R(){}return R.prototype.toJSON=function(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}},R.prototype.toString=function(){var O="[PushChannelSubscription";return this.channel&&(O+="; channel="+this.channel),this.deviceId&&(O+="; deviceId="+this.deviceId),this.clientId&&(O+="; clientId="+this.clientId),O+="]",O},R.fromResponseBody=function(O,A){return A&&(O=r.decodeBody(O,A)),r.isArray(O)?R.fromValuesArray(O):R.fromValues(O)},R.fromValues=function(O){return Object.assign(new R,O)},R.fromValuesArray=function(O){for(var A=O.length,x=new Array(A),m=0;m<A;m++)x[m]=R.fromValues(O[m]);return x},R.toRequestBody=r.encodeBody,R}();l.default=P},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=function(){function h(n){this.count=n&&n.count||0,this.data=n&&n.data||0,this.uncompressedData=n&&n.uncompressedData||0,this.failed=n&&n.failed||0,this.refused=n&&n.refused||0}return h}(),R=function(h){d.__extends(n,h);function n(s){var o=h.call(this,s)||this;return s&&s.category&&(o.category={},r.forInOwnNonNullProperties(s.category,function(a){o.category[a]=new P(s.category[a])})),o}return n}(P),O=function(){function h(n){this.peak=n&&n.peak||0,this.min=n&&n.min||0,this.mean=n&&n.mean||0,this.opened=n&&n.opened||0,this.refused=n&&n.refused||0}return h}(),A=function(){function h(n){this.succeeded=n&&n.succeeded||0,this.failed=n&&n.failed||0,this.refused=n&&n.refused||0}return h}(),x=function(){function h(n){this.plain=new O(n&&n.plain),this.tls=new O(n&&n.tls),this.all=new O(n&&n.all)}return h}(),m=function(){function h(n){this.messages=new R(n&&n.messages),this.presence=new R(n&&n.presence),this.all=new R(n&&n.all)}return h}(),y=function(){function h(n){this.realtime=new m(n&&n.realtime),this.rest=new m(n&&n.rest),this.webhook=new m(n&&n.webhook),this.sharedQueue=new m(n&&n.sharedQueue),this.externalQueue=new m(n&&n.externalQueue),this.httpEvent=new m(n&&n.httpEvent),this.push=new m(n&&n.push),this.all=new m(n&&n.all)}return h}(),i=function(){function h(n){this.all=new m(n&&n.all),this.inbound=new y(n&&n.inbound),this.outbound=new y(n&&n.outbound)}return h}(),g=function(){function h(n){this.all=new m(n&&n.all),this.producerPaid=new i(n&&n.producerPaid),this.consumerPaid=new i(n&&n.consumerPaid)}return h}(),S=function(){function h(n){this.messages=n&&n.messages||0;var s=n&&n.notifications;this.notifications={invalid:s&&s.invalid||0,attempted:s&&s.attempted||0,successful:s&&s.successful||0,failed:s&&s.failed||0},this.directPublishes=n&&n.directPublishes||0}return h}(),C=function(){function h(n){this.succeeded=n&&n.succeeded||0,this.skipped=n&&n.skipped||0,this.failed=n&&n.failed||0}return h}(),f=function(){function h(n){var s=this;this.delta=void 0,n&&n.delta&&(this.delta={},r.forInOwnNonNullProperties(n.delta,function(o){s.delta[o]=new C(n.delta[o])}))}return h}(),c=function(h){d.__extends(n,h);function n(s){var o=h.call(this,s)||this;return o.persisted=new m(s&&s.persisted),o.connections=new x(s&&s.connections),o.channels=new O(s&&s.channels),o.apiRequests=new A(s&&s.apiRequests),o.tokenRequests=new A(s&&s.tokenRequests),o.xchgProducer=new g(s&&s.xchgProducer),o.xchgConsumer=new g(s&&s.xchgConsumer),o.push=new S(s&&s.pushStats),o.processed=new f(s&&s.processed),o.inProgress=s&&s.inProgress||void 0,o.unit=s&&s.unit||void 0,o.intervalId=s&&s.intervalId||void 0,o}return n.fromValues=function(s){return new n(s)},n}(i);l.default=c},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(30)),R=d.__importDefault(t(7)),O=d.__importDefault(t(3)),A=d.__importDefault(t(50)),x=d.__importDefault(t(37)),m=d.__importDefault(t(8)),y=d.__importDefault(t(5)),i=d.__importDefault(t(10)),g=d.__importDefault(t(25)),S=d.__importDefault(t(0)),C=d.__importDefault(t(9)),f=function(h){d.__extends(n,h);function n(s){var o=h.call(this,s)||this;return O.default.logAction(O.default.LOG_MINOR,"Realtime()",""),o.connection=new A.default(o,o.options),o.channels=new c(o),s.autoConnect!==!1&&o.connect(),o}return n.prototype.connect=function(){O.default.logAction(O.default.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()},n.prototype.close=function(){O.default.logAction(O.default.LOG_MINOR,"Realtime.close()",""),this.connection.close()},n.Promise=function(s){return s=m.default.objectifyOptions(s),s.promises=!0,new n(s)},n.Callbacks=n,n.Utils=r,n.ConnectionManager=g.default,n.Platform=S.default,n.ProtocolMessage=i.default,n.Message=C.default,n}(P.default),c=function(h){d.__extends(n,h);function n(s){var o=h.call(this)||this;return o.realtime=s,o.all={},o.inProgress={},s.connection.connectionManager.on("transport.active",function(){o.onTransportActive()}),o}return n.prototype.onChannelMessage=function(s){var o=s.channel;if(o===void 0){O.default.logAction(O.default.LOG_ERROR,"Channels.onChannelMessage()","received event unspecified channel, action = "+s.action);return}var a=this.all[o];if(!a){O.default.logAction(O.default.LOG_ERROR,"Channels.onChannelMessage()","received event for non-existent channel: "+o);return}a.onMessage(s)},n.prototype.onTransportActive=function(){for(var s in this.all){var o=this.all[s];o.state==="attaching"||o.state==="detaching"?o.checkPendingState():o.state==="suspended"&&o.attach()}},n.prototype.reattach=function(s){for(var o in this.all){var a=this.all[o];a.state==="attached"&&a.requestState("attaching",s)}},n.prototype.resetAttachedMsgIndicators=function(){for(var s in this.all){var o=this.all[s];o.state==="attached"&&(o._attachedMsgIndicator=!1)}},n.prototype.checkAttachedMsgIndicators=function(s){for(var o in this.all){var a=this.all[o];if(a.state==="attached"&&a._attachedMsgIndicator===!1){var e="30s after a resume, found channel which has not received an attached; channelId = "+o+"; connectionId = "+s;O.default.logAction(O.default.LOG_ERROR,"Channels.checkAttachedMsgIndicators()",e),a.requestState("attaching")}}},n.prototype.propogateConnectionInterruption=function(s,o){var a={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"},e=["attaching","attached","detaching","suspended"],u=a[s];for(var v in this.all){var I=this.all[v];r.arrIn(e,I.state)&&I.notifyState(u,o)}},n.prototype.get=function(s,o){s=String(s);var a=this.all[s];if(!a)a=this.all[s]=new x.default(this.realtime,s,o);else if(o){if(a._shouldReattachToSetOptions(o))throw new y.default("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);a.setOptions(o)}return a},n.prototype.release=function(s){s=String(s);var o=this.all[s];if(!!o){var a=o.getReleaseErr();if(a)throw a;delete this.all[s],delete this.inProgress[s]}},n.prototype.setInProgress=function(s,o,a){this.inProgress[s.name]=this.inProgress[s.name]||{},this.inProgress[s.name][o]=a,!a&&this.hasNopending()&&this.emit("nopending")},n.prototype.onceNopending=function(s){if(this.hasNopending()){s();return}this.once("nopending",s)},n.prototype.hasNopending=function(){return r.arrEvery(r.valuesArray(this.inProgress,!0),function(s){return!r.containsValue(s,!0)})},n}(R.default);l.default=f},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(7)),R=d.__importDefault(t(25)),O=d.__importDefault(t(3)),A=d.__importDefault(t(36)),x=d.__importDefault(t(0));function m(){}var y=function(i){d.__extends(g,i);function g(S,C){var f=i.call(this)||this;return f.whenState=function(c,h){return P.default.prototype.whenState.call(f,c,f.state,h,new A.default(void 0,c))},f.ably=S,f.connectionManager=new R.default(S,C),f.state=f.connectionManager.state.state,f.key=void 0,f.id=void 0,f.serial=void 0,f.timeSerial=void 0,f.recoveryKey=void 0,f.errorReason=null,f.connectionManager.on("connectionstate",function(c){var h=f.state=c.current;x.default.Config.nextTick(function(){f.emit(h,c)})}),f.connectionManager.on("update",function(c){x.default.Config.nextTick(function(){f.emit("update",c)})}),f}return g.prototype.connect=function(){O.default.logAction(O.default.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})},g.prototype.ping=function(S){if(O.default.logAction(O.default.LOG_MINOR,"Connection.ping()",""),!S){if(this.ably.options.promises)return r.promisify(this,"ping",arguments);S=m}this.connectionManager.ping(null,S)},g.prototype.close=function(){O.default.logAction(O.default.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})},g}(P.default);l.default=y},function(D,l,t){"use strict";l.__esModule=!0,l.PendingMessage=void 0;var d=t(1),r=d.__importDefault(t(10)),P=d.__importStar(t(2)),R=d.__importDefault(t(7)),O=d.__importDefault(t(3)),A=d.__importDefault(t(35)),x=d.__importDefault(t(5)),m=r.default.Action,y=function(){function g(S,C){this.message=S,this.callback=C,this.merged=!1;var f=S.action;this.sendAttempted=!1,this.ackRequired=f==m.MESSAGE||f==m.PRESENCE}return g}();l.PendingMessage=y;var i=function(g){d.__extends(S,g);function S(C){var f=g.call(this)||this;return f.transport=C,f.messageQueue=new A.default,C.on("ack",function(c,h){f.onAck(c,h)}),C.on("nack",function(c,h,n){f.onNack(c,h,n)}),f}return S.prototype.onAck=function(C,f){O.default.logAction(O.default.LOG_MICRO,"Protocol.onAck()","serial = "+C+"; count = "+f),this.messageQueue.completeMessages(C,f)},S.prototype.onNack=function(C,f,c){O.default.logAction(O.default.LOG_ERROR,"Protocol.onNack()","serial = "+C+"; count = "+f+"; err = "+P.inspectError(c)),c||(c=new x.default("Unable to send message; channel not responding",50001,500)),this.messageQueue.completeMessages(C,f,c)},S.prototype.onceIdle=function(C){var f=this.messageQueue;if(f.count()===0){C();return}f.once("idle",C)},S.prototype.send=function(C){C.ackRequired&&this.messageQueue.push(C),O.default.shouldLog(O.default.LOG_MICRO)&&O.default.logAction(O.default.LOG_MICRO,"Protocol.send()","sending msg; "+r.default.stringify(C.message)),C.sendAttempted=!0,this.transport.send(C.message)},S.prototype.getTransport=function(){return this.transport},S.prototype.getPendingMessages=function(){return this.messageQueue.copyAll()},S.prototype.clearPendingMessages=function(){return this.messageQueue.clear()},S.prototype.finish=function(){var C=this.transport;this.onceIdle(function(){C.disconnect()})},S}(R.default);l.default=i},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(0)),P=d.__importStar(t(2)),R=d.__importDefault(t(26)),O=d.__importDefault(t(8)),A=d.__importDefault(t(3)),x=d.__importDefault(t(10)),m=d.__importDefault(t(5)),y="web_socket";function i(C){return!!C.on}var g=function(C){d.__extends(f,C);function f(c,h,n){var s=C.call(this,c,h,n)||this;return s.shortName=y,n.heartbeats=r.default.Config.useProtocolHeartbeats,s.wsHost=O.default.getHost(n.options,n.host,!0),s}return f.isAvailable=function(){return!!r.default.Config.WebSocket},f.prototype.createWebSocket=function(c,h){var n=0;if(h)for(var s in h)c+=(n++?"&":"?")+s+"="+h[s];return this.uri=c,new r.default.Config.WebSocket(c)},f.prototype.toString=function(){return"WebSocketTransport; uri="+this.uri},f.prototype.connect=function(){A.default.logAction(A.default.LOG_MINOR,"WebSocketTransport.connect()","starting"),R.default.prototype.connect.call(this);var c=this,h=this.params,n=h.options,s=n.tls?"wss://":"ws://",o=s+this.wsHost+":"+O.default.getPort(n)+"/";A.default.logAction(A.default.LOG_MINOR,"WebSocketTransport.connect()","uri: "+o),this.auth.getAuthParams(function(a,e){if(!c.isDisposed){var u="";for(var v in e)u+=" "+v+": "+e[v]+";";if(A.default.logAction(A.default.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+u+" err: "+a),a){c.disconnect(a);return}var I=h.getConnectParams(e);try{var U=c.wsConnection=c.createWebSocket(o,I);U.binaryType=r.default.Config.binaryType,U.onopen=function(){c.onWsOpen()},U.onclose=function(L){c.onWsClose(L)},U.onmessage=function(L){c.onWsData(L.data)},U.onerror=function(L){c.onWsError(L)},i(U)&&U.on("ping",function(){c.onActivity()})}catch(L){A.default.logAction(A.default.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(L.stack||L.message)),c.disconnect(L)}}})},f.prototype.send=function(c){var h=this.wsConnection;if(!h){A.default.logAction(A.default.LOG_ERROR,"WebSocketTransport.send()","No socket connection");return}try{h.send(x.default.serialize(c,this.params.format))}catch(s){var n="Exception from ws connection when trying to send: "+P.inspectError(s);A.default.logAction(A.default.LOG_ERROR,"WebSocketTransport.send()",n),this.finish("disconnected",new m.default(n,5e4,500))}},f.prototype.onWsData=function(c){A.default.logAction(A.default.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+c.length+"; type = "+typeof c);try{this.onProtocolMessage(x.default.deserialize(c,this.format))}catch(h){A.default.logAction(A.default.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+h.stack)}},f.prototype.onWsOpen=function(){A.default.logAction(A.default.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")},f.prototype.onWsClose=function(c){var h,n;if(typeof c=="object"?(n=c.code,h=c.wasClean||n===1e3):(n=c,h=n==1e3),delete this.wsConnection,h){A.default.logAction(A.default.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");var s=new m.default("Websocket closed",80003,400);this.finish("disconnected",s)}else{var o="Unclean disconnection of WebSocket ; code = "+n,s=new m.default(o,80003,400);A.default.logAction(A.default.LOG_MINOR,"WebSocketTransport.onWsClose()",o),this.finish("disconnected",s)}this.emit("disposed")},f.prototype.onWsError=function(c){var h=this;A.default.logAction(A.default.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+c.message),r.default.Config.nextTick(function(){h.disconnect(Error(c.message))})},f.prototype.dispose=function(){A.default.logAction(A.default.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;var c=this.wsConnection;c&&(c.onmessage=function(){},delete this.wsConnection,r.default.Config.nextTick(function(){if(A.default.logAction(A.default.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!c)throw new Error("WebSocketTransport.dispose(): wsConnection is not defined");c.close()}))},f}(R.default);function S(C){return g.isAvailable()&&(C.supportedTransports[y]=g),g}l.default=S},function(D,l,t){"use strict";l.__esModule=!0,l.isSuccessCode=void 0;var d;(function(P){P[P.Success=200]="Success",P[P.NoContent=204]="NoContent",P[P.BadRequest=400]="BadRequest",P[P.Unauthorized=401]="Unauthorized",P[P.Forbidden=403]="Forbidden",P[P.RequestTimeout=408]="RequestTimeout",P[P.InternalServerError=500]="InternalServerError"})(d||(d={}));function r(P){return P>=d.Success&&P<d.BadRequest}l.isSuccessCode=r,l.default=d},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importStar(t(2)),P=d.__importDefault(t(34)),R=d.__importDefault(t(7)),O=d.__importDefault(t(3)),A=d.__importDefault(t(14)),x=d.__importDefault(t(5)),m=d.__importDefault(t(37)),y=d.__importDefault(t(22)),i=d.__importDefault(t(38)),g=function(){};function S(o){return o.clientId+":"+o.connectionId}function C(o){return o.channel.realtime.auth.clientId}function f(o){var a=o.channel.realtime,e=a.auth.clientId;return(!e||e==="*")&&a.connection.state==="connected"}function c(o,a,e){switch(o.state){case"attached":case"suspended":e();break;case"initialized":case"detached":case"detaching":case"attaching":o.attach(function(u){u?a(u):e()});break;default:a(x.default.fromValues(m.default.invalidStateError(o.state)))}}function h(o,a){if(o.isSynthesized()||a.isSynthesized())return o.timestamp>a.timestamp;var e=o.parseId(),u=a.parseId();return e.msgSerial===u.msgSerial?e.index>u.index:e.msgSerial>u.msgSerial}var n=function(o){d.__extends(a,o);function a(e){var u=o.call(this,e)||this;return u.channel=e,u.syncComplete=!1,u.members=new s(u),u._myMembers=new s(u),u.subscriptions=new R.default,u.pendingPresence=[],u}return a.prototype.enter=function(e,u){if(f(this))throw new x.default("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,e,"enter",u)},a.prototype.update=function(e,u){if(f(this))throw new x.default("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,e,"update",u)},a.prototype.enterClient=function(e,u,v){return this._enterOrUpdateClient(e,u,"enter",v)},a.prototype.updateClient=function(e,u,v){return this._enterOrUpdateClient(e,u,"update",v)},a.prototype._enterOrUpdateClient=function(e,u,v,I){var U=this;if(!I)if(typeof u=="function")I=u,u=null;else{if(this.channel.realtime.options.promises)return r.promisify(this,"_enterOrUpdateClient",[e,u,v]);I=g}var L=this.channel;if(!L.connectionManager.activeState()){I(L.connectionManager.getError());return}O.default.logAction(O.default.LOG_MICRO,"RealtimePresence."+v+"Client()","channel = "+L.name+", client = "+(e||"(implicit) "+C(this)));var E=A.default.fromValues({action:v,data:u});e&&(E.clientId=e),A.default.encode(E,L.channelOptions,function(p){if(p){I(p);return}switch(L.state){case"attached":L.sendPresence(E,I);break;case"initialized":case"detached":L.attach();case"attaching":U.pendingPresence.push({presence:E,callback:I});break;default:p=new x.default("Unable to "+v+" presence channel while in "+L.state+" state",90001),p.code=90001,I(p)}})},a.prototype.leave=function(e,u){if(f(this))throw new x.default("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,e,u)},a.prototype.leaveClient=function(e,u,v){if(!v)if(typeof u=="function")v=u,u=null;else{if(this.channel.realtime.options.promises)return r.promisify(this,"leaveClient",[e,u]);v=g}var I=this.channel;if(!I.connectionManager.activeState()){v==null||v(I.connectionManager.getError());return}O.default.logAction(O.default.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+e);var U=A.default.fromValues({action:"leave",data:u});switch(e&&(U.clientId=e),I.state){case"attached":I.sendPresence(U,v);break;case"attaching":this.pendingPresence.push({presence:U,callback:v});break;case"initialized":case"failed":{var L=new x.default("Unable to leave presence channel (incompatible state)",90001);v==null||v(L);break}default:v==null||v(m.default.invalidStateError(I.state))}},a.prototype.get=function(e,u){var v=this,I=Array.prototype.slice.call(arguments);I.length==1&&typeof I[0]=="function"&&I.unshift(null),e=I[0],u=I[1];var U=!e||("waitForSync"in e?e.waitForSync:!0);if(!u){if(this.channel.realtime.options.promises)return r.promisify(this,"get",I);u=g}function L(E){u(null,e?E.list(e):E.values())}if(this.channel.state==="suspended"){U?u(x.default.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):L(this.members);return}c(this.channel,u,function(){var E=v.members;U?E.waitSync(function(){L(E)}):L(E)})},a.prototype.history=function(e,u){if(O.default.logAction(O.default.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name),u===void 0)if(typeof e=="function")u=e,e=null;else{if(this.channel.realtime.options.promises)return r.promisify(this,"history",arguments);u=g}e&&e.untilAttach&&(this.channel.state==="attached"?(delete e.untilAttach,e.from_serial=this.channel.properties.attachSerial):u(new x.default("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400))),P.default.prototype._history.call(this,e,u)},a.prototype.setPresence=function(e,u,v){O.default.logAction(O.default.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+e.length+" participants; syncChannelSerial = "+v);var I,U,L=this.members,E=this._myMembers,p=[],b=this.channel.connectionManager.connectionId;u&&(this.members.startSync(),v&&(U=v.match(/^[\w-]+:(.*)$/))&&(I=U[1]));for(var G=0;G<e.length;G++){var N=A.default.fromValues(e[G]);switch(N.action){case"leave":L.remove(N)&&p.push(N),N.connectionId===b&&!N.isSynthesized()&&E.remove(N);break;case"enter":case"present":case"update":L.put(N)&&p.push(N),N.connectionId===b&&E.put(N);break}}u&&!I&&(L.endSync(),this._ensureMyMembersPresent(),this.channel.setInProgress(m.default.progressOps.sync,!1),this.channel.syncChannelSerial=null);for(var G=0;G<p.length;G++){var N=p[G];this.subscriptions.emit(N.action,N)}},a.prototype.onAttached=function(e){O.default.logAction(O.default.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+e),e?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear(),this._ensureMyMembersPresent());var u=this.pendingPresence,v=u.length;if(v){this.pendingPresence=[];var I=[],U=y.default.create();O.default.logAction(O.default.LOG_MICRO,"RealtimePresence.onAttached","sending "+v+" queued presence messages");for(var L=0;L<v;L++){var E=u[L];I.push(E.presence),U.push(E.callback)}this.channel.sendPresence(I,U)}},a.prototype.actOnChannelState=function(e,u,v){switch(e){case"attached":this.onAttached(u);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(v);break}},a.prototype.failPendingPresence=function(e){if(this.pendingPresence.length){O.default.logAction(O.default.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+r.inspectError(e));for(var u=0;u<this.pendingPresence.length;u++)try{this.pendingPresence[u].callback(e)}catch(v){}this.pendingPresence=[]}},a.prototype._clearMyMembers=function(){this._myMembers.clear()},a.prototype._ensureMyMembersPresent=function(){var e=this,u=this.members,v=this._myMembers,I=function(E){if(E){var p="Presence auto-re-enter failed: "+E.toString(),b=new x.default(p,91004,400);O.default.logAction(O.default.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()",p);var G=new i.default(e.channel.state,e.channel.state,!0,b);e.channel.emit("update",G)}};for(var U in v.map)if(!(U in u.map)){var L=v.map[U];O.default.logAction(O.default.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+L.clientId+'" into the presence set'),this._enterOrUpdateClient(L.clientId,L.data,"enter",I),delete v.map[U]}},a.prototype._synthesizeLeaves=function(e){var u=this.subscriptions;r.arrForEach(e,function(v){var I=A.default.fromValues({action:"leave",connectionId:v.connectionId,clientId:v.clientId,data:v.data,encoding:v.encoding,timestamp:r.now()});u.emit("leave",I)})},a.prototype.on=function(){for(var e=[],u=0;u<arguments.length;u++)e[u]=arguments[u];O.default.deprecated("presence.on","presence.subscribe"),this.subscribe.apply(this,e)},a.prototype.off=function(){for(var e=[],u=0;u<arguments.length;u++)e[u]=arguments[u];O.default.deprecated("presence.off","presence.unsubscribe"),this.unsubscribe.apply(this,e)},a.prototype.subscribe=function(){for(var e=[],u=0;u<arguments.length;u++)e[u]=arguments[u];var v=m.default.processListenerArgs(e),I=v[0],U=v[1],L=v[2],E=this.channel;if(!L){if(this.channel.realtime.options.promises)return r.promisify(this,"subscribe",[I,U]);L=g}if(E.state==="failed"){L(x.default.fromValues(m.default.invalidStateError("failed")));return}this.subscriptions.on(I,U),E.attach(L)},a.prototype.unsubscribe=function(){for(var e=[],u=0;u<arguments.length;u++)e[u]=arguments[u];var v=m.default.processListenerArgs(e),I=v[0],U=v[1];this.subscriptions.off(I,U)},a}(P.default),s=function(o){d.__extends(a,o);function a(e){var u=o.call(this)||this;return u.presence=e,u.map={},u.syncInProgress=!1,u.residualMembers=null,u}return a.prototype.get=function(e){return this.map[e]},a.prototype.getClient=function(e){var u=this.map,v=[];for(var I in u){var U=u[I];U.clientId==e&&U.action!="absent"&&v.push(U)}return v},a.prototype.list=function(e){var u=this.map,v=e&&e.clientId,I=e&&e.connectionId,U=[];for(var L in u){var E=u[L];E.action!=="absent"&&(v&&v!=E.clientId||I&&I!=E.connectionId||U.push(E))}return U},a.prototype.put=function(e){(e.action==="enter"||e.action==="update")&&(e=A.default.fromValues(e),e.action="present");var u=this.map,v=S(e);this.residualMembers&&delete this.residualMembers[v];var I=u[v];return I&&!h(e,I)?!1:(u[v]=e,!0)},a.prototype.values=function(){var e=this.map,u=[];for(var v in e){var I=e[v];I.action!="absent"&&u.push(I)}return u},a.prototype.remove=function(e){var u=this.map,v=S(e),I=u[v];return I&&!h(e,I)?!1:(this.syncInProgress?(e=A.default.fromValues(e),e.action="absent",u[v]=e):delete u[v],!0)},a.prototype.startSync=function(){var e=this.map,u=this.syncInProgress;O.default.logAction(O.default.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+u),this.syncInProgress||(this.residualMembers=r.copy(e),this.setInProgress(!0))},a.prototype.endSync=function(){var e=this.map,u=this.syncInProgress;if(O.default.logAction(O.default.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+u),u){for(var v in e){var I=e[v];I.action==="absent"&&delete e[v]}this.presence._synthesizeLeaves(r.valuesArray(this.residualMembers));for(var U in this.residualMembers)delete e[U];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")},a.prototype.waitSync=function(e){var u=this.syncInProgress;if(O.default.logAction(O.default.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+u),!u){e();return}this.once("sync",e)},a.prototype.clear=function(){this.map={},this.setInProgress(!1),this.residualMembers=null},a.prototype.setInProgress=function(e){O.default.logAction(O.default.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+e),this.syncInProgress=e,this.presence.syncComplete=!e},a}(R.default);l.default=n},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=t(56),P=t(32),R=t(13),O=d.__importDefault(t(4)),A=d.__importDefault(t(0)),x=function(){function m(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}return m.prototype.isWordArray=function(y){return y!=null&&y.sigBytes!==void 0},m.prototype.isArrayBuffer=function(y){return y!=null&&y.constructor===ArrayBuffer},m.prototype.isTypedArray=function(y){return!!ArrayBuffer&&ArrayBuffer.isView&&ArrayBuffer.isView(y)},m.prototype.uint8ViewToBase64=function(y){for(var i="",g=this.base64CharSet,S=y.byteLength,C=S%3,f=S-C,c,h,n,s,o,a=0;a<f;a=a+3)o=y[a]<<16|y[a+1]<<8|y[a+2],c=(o&16515072)>>18,h=(o&258048)>>12,n=(o&4032)>>6,s=o&63,i+=g[c]+g[h]+g[n]+g[s];return C==1?(o=y[f],c=(o&252)>>2,h=(o&3)<<4,i+=g[c]+g[h]+"=="):C==2&&(o=y[f]<<8|y[f+1],c=(o&64512)>>10,h=(o&1008)>>4,n=(o&15)<<2,i+=g[c]+g[h]+g[n]+"="),i},m.prototype.base64ToArrayBuffer=function(y){for(var i=atob==null?void 0:atob(y),g=i.length,S=new Uint8Array(g),C=0;C<g;C++){var f=i.charCodeAt(C);S[C]=f}return S.buffer},m.prototype.isBuffer=function(y){return this.isArrayBuffer(y)||this.isWordArray(y)||this.isTypedArray(y)},m.prototype.toBuffer=function(y){if(!ArrayBuffer)throw new Error("Can't convert to Buffer: browser does not support the necessary types");if(this.isArrayBuffer(y))return new Uint8Array(y);if(this.isTypedArray(y))return new Uint8Array(y.buffer);if(this.isWordArray(y)){for(var i=new ArrayBuffer(y.sigBytes),g=new Uint8Array(i),S=0;S<y.sigBytes;S++)g[S]=y.words[S>>>2]>>>24-S%4*8&255;return g}throw new Error("BufferUtils.toBuffer expected an arraybuffer, typed array, or CryptoJS wordarray")},m.prototype.toArrayBuffer=function(y){return this.isArrayBuffer(y)?y:this.toBuffer(y).buffer},m.prototype.toWordArray=function(y){return this.isTypedArray(y)&&(y=y.buffer),this.isWordArray(y)?y:O.default.create(y)},m.prototype.base64Encode=function(y){return this.isWordArray(y)?R.stringify(y):this.uint8ViewToBase64(this.toBuffer(y))},m.prototype.base64Decode=function(y){return ArrayBuffer&&A.default.Config.atob?this.base64ToArrayBuffer(y):R.parse(y)},m.prototype.hexEncode=function(y){return r.stringify(this.toWordArray(y))},m.prototype.hexDecode=function(y){var i=r.parse(y);return ArrayBuffer?this.toArrayBuffer(i):i},m.prototype.utf8Encode=function(y){return TextEncoder?new TextEncoder().encode(y).buffer:P.parse(y)},m.prototype.utf8Decode=function(y){if(!this.isBuffer(y))throw new Error("Expected input of utf8decode to be an arraybuffer, typed array, or CryptoJS wordarray");return TextDecoder&&!this.isWordArray(y)?new TextDecoder().decode(y):(y=this.toWordArray(y),P.stringify(y))},m.prototype.bufferCompare=function(y,i){if(!y)return-1;if(!i)return 1;var g=this.toWordArray(y),S=this.toWordArray(i);g.clamp(),S.clamp();var C=g.sigBytes-S.sigBytes;if(C!=0)return C;for(var f=g.words,c=S.words,h=0;h<f.length;h++)if(C=f[h]-c[h],C!=0)return C;return 0},m.prototype.byteLength=function(y){return this.isArrayBuffer(y)||this.isTypedArray(y)?y.byteLength:this.isWordArray(y)?y.sigBytes:-1},m.prototype.typedArrayToBuffer=function(y){return y.buffer},m}();l.default=new x},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){return d.enc.Hex})},function(D,l,t){"use strict";t.r(l);var d=t(4),r=t.n(d),P=t(13),R=t.n(P),O=t(21),A=t.n(O),x=t(0),m=t.n(x),y=t(3),i=t.n(y),g=function(){var S="aes",C=256,f="cbc",c=16,h=4,n=4294967296,s=2147483648,o;if(m.a.getRandomWordArray)o=m.a.getRandomWordArray;else if(typeof Uint32Array!="undefined"&&m.a.getRandomValues){var a=new Uint32Array(h);o=function(p,b){var G=p/4,N=G==h?a:new Uint32Array(G);m.a.getRandomValues(N,function(_){b(_,m.a.BufferUtils.toWordArray(N))})}}else o=function(p,b){i.a.logAction(i.a.LOG_MAJOR,"Ably.Crypto.generateRandom()","Warning: the browser you are using does not support secure cryptographically secure randomness generation; falling back to insecure Math.random()");for(var G=p/4,N=new Array(G),_=0;_<G;_++)N[_]=Math.floor(Math.random()*n)-s;b(null,r.a.create(N))};function e(p){return p+c&-c}function u(p){if(p.algorithm==="aes"&&p.mode==="cbc"){if(p.keyLength===128||p.keyLength===256)return;throw new Error("Unsupported key length "+p.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}}function v(p){return p.replace("_","/").replace("-","+")}var I=[r.a.create([269488144,269488144,269488144,269488144],16),r.a.create([16777216],1),r.a.create([33685504],2),r.a.create([50529024],3),r.a.create([67372036],4),r.a.create([84215045,83886080],5),r.a.create([101058054,101056512],6),r.a.create([117901063,117901056],7),r.a.create([134744072,134744072],8),r.a.create([151587081,151587081,150994944],9),r.a.create([168430090,168430090,168427520],10),r.a.create([185273099,185273099,185273088],11),r.a.create([202116108,202116108,202116108],12),r.a.create([218959117,218959117,218959117,218103808],13),r.a.create([235802126,235802126,235802126,235798528],14),r.a.create([252645135,252645135,252645135,252645135],15),r.a.create([269488144,269488144,269488144,269488144],16)];function U(){}function L(){this.algorithm=null,this.keyLength=null,this.mode=null,this.key=null}U.CipherParams=L,U.getDefaultParams=function(p){var b;if(typeof p=="function"||typeof p=="string"){if(i.a.deprecated("Crypto.getDefaultParams(key, callback)","Crypto.getDefaultParams({key: key})"),typeof p=="function")U.generateRandomKey(function(N){p(null,U.getDefaultParams({key:N}))});else if(typeof arguments[1]=="function")arguments[1](null,U.getDefaultParams({key:p}));else throw new Error("Invalid arguments for Crypto.getDefaultParams");return}if(!p.key)throw new Error("Crypto.getDefaultParams: a key is required");typeof p.key=="string"?b=Object(P.parse)(v(p.key)):b=m.a.BufferUtils.toWordArray(p.key);var G=new L;if(G.key=b,G.algorithm=p.algorithm||S,G.keyLength=b.words.length*(4*8),G.mode=p.mode||f,p.keyLength&&p.keyLength!==G.keyLength)throw new Error("Crypto.getDefaultParams: a keyLength of "+p.keyLength+" was specified, but the key actually has length "+G.keyLength);return u(G),G},U.generateRandomKey=function(p,b){arguments.length==1&&typeof p=="function"&&(b=p,p=void 0),o((p||C)/8,b)},U.getCipher=function(p){var b=p instanceof L?p:U.getDefaultParams(p);return{cipherParams:b,cipher:new E(b,h,p.iv)}};function E(p,b,G){this.algorithm=p.algorithm+"-"+String(p.keyLength)+"-"+p.mode,this.cjsAlgorithm=p.algorithm.toUpperCase().replace(/-\d+$/,""),this.key=m.a.BufferUtils.toWordArray(p.key),G&&(this.iv=m.a.BufferUtils.toWordArray(G).clone()),this.blockLengthWords=b}return E.prototype.encrypt=function(p,b){i.a.logAction(i.a.LOG_MICRO,"CBCCipher.encrypt()",""),p=m.a.BufferUtils.toWordArray(p);var G=p.sigBytes,N=e(G),_=this,k=function(){_.getIv(function(H,w){if(H){b(H);return}var T=_.encryptCipher.process(p.concat(I[N-G])),M=w.concat(T);b(null,M)})};this.encryptCipher?k():this.iv?(this.encryptCipher=A.a.algo[this.cjsAlgorithm].createEncryptor(this.key,{iv:this.iv}),k()):o(c,function(H,w){if(H){b(H);return}_.encryptCipher=A.a.algo[_.cjsAlgorithm].createEncryptor(_.key,{iv:w}),_.iv=w,k()})},E.prototype.decrypt=function(p){i.a.logAction(i.a.LOG_MICRO,"CBCCipher.decrypt()",""),p=m.a.BufferUtils.toWordArray(p);var b=this.blockLengthWords,G=p.words,N=r.a.create(G.slice(0,b)),_=r.a.create(G.slice(b)),k=A.a.algo[this.cjsAlgorithm].createDecryptor(this.key,{iv:N}),H=k.process(_),w=k.finalize();return k.reset(),w&&w.sigBytes&&H.concat(w),H},E.prototype.getIv=function(p){if(this.iv){var b=this.iv;this.iv=null,p(null,b);return}var G=this;o(c,function(N,_){if(N){p(N);return}p(null,G.encryptCipher.process(_))})},U}();l.default=g},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){return function(){var r=d,P=r.lib,R=P.WordArray,O=r.enc,A=O.Utf16=O.Utf16BE={stringify:function(m){for(var y=m.words,i=m.sigBytes,g=[],S=0;S<i;S+=2){var C=y[S>>>2]>>>16-S%4*8&65535;g.push(String.fromCharCode(C))}return g.join("")},parse:function(m){for(var y=m.length,i=[],g=0;g<y;g++)i[g>>>1]|=m.charCodeAt(g)<<16-g%2*16;return R.create(i,y*2)}};O.Utf16LE={stringify:function(m){for(var y=m.words,i=m.sigBytes,g=[],S=0;S<i;S+=2){var C=x(y[S>>>2]>>>16-S%4*8&65535);g.push(String.fromCharCode(C))}return g.join("")},parse:function(m){for(var y=m.length,i=[],g=0;g<y;g++)i[g>>>1]|=x(m.charCodeAt(g)<<16-g%2*16);return R.create(i,y*2)}};function x(m){return m<<8&4278255360|m>>>8&16711935}}(),d.enc.Utf16})},function(D,l,t){(function(d,r){D.exports=l=r(t(6),t(28))})(this,function(d){return function(r){var P=d,R=P.lib,O=R.CipherParams,A=P.enc,x=A.Hex,m=P.format,y=m.Hex={stringify:function(i){return i.ciphertext.toString(x)},parse:function(i){var g=x.parse(i);return O.create({ciphertext:g})}}}(),d.format.Hex})},function(D,l,t){(function(d,r){D.exports=l=r(t(6),t(13),t(61),t(27),t(28))})(this,function(d){return function(){var r=d,P=r.lib,R=P.BlockCipher,O=r.algo,A=[],x=[],m=[],y=[],i=[],g=[],S=[],C=[],f=[],c=[];(function(){for(var s=[],o=0;o<256;o++)o<128?s[o]=o<<1:s[o]=o<<1^283;for(var a=0,e=0,o=0;o<256;o++){var u=e^e<<1^e<<2^e<<3^e<<4;u=u>>>8^u&255^99,A[a]=u,x[u]=a;var v=s[a],I=s[v],U=s[I],L=s[u]*257^u*16843008;m[a]=L<<24|L>>>8,y[a]=L<<16|L>>>16,i[a]=L<<8|L>>>24,g[a]=L;var L=U*16843009^I*65537^v*257^a*16843008;S[u]=L<<24|L>>>8,C[u]=L<<16|L>>>16,f[u]=L<<8|L>>>24,c[u]=L,a?(a=v^s[s[s[U^v]]],e^=s[s[e]]):a=e=1}})();var h=[0,1,2,4,8,16,32,64,128,27,54],n=O.AES=R.extend({_doReset:function(){var s;if(!(this._nRounds&&this._keyPriorReset===this._key)){for(var o=this._keyPriorReset=this._key,a=o.words,e=o.sigBytes/4,u=this._nRounds=e+6,v=(u+1)*4,I=this._keySchedule=[],U=0;U<v;U++)U<e?I[U]=a[U]:(s=I[U-1],U%e?e>6&&U%e==4&&(s=A[s>>>24]<<24|A[s>>>16&255]<<16|A[s>>>8&255]<<8|A[s&255]):(s=s<<8|s>>>24,s=A[s>>>24]<<24|A[s>>>16&255]<<16|A[s>>>8&255]<<8|A[s&255],s^=h[U/e|0]<<24),I[U]=I[U-e]^s);for(var L=this._invKeySchedule=[],E=0;E<v;E++){var U=v-E;if(E%4)var s=I[U];else var s=I[U-4];E<4||U<=4?L[E]=s:L[E]=S[A[s>>>24]]^C[A[s>>>16&255]]^f[A[s>>>8&255]]^c[A[s&255]]}}},encryptBlock:function(s,o){this._doCryptBlock(s,o,this._keySchedule,m,y,i,g,A)},decryptBlock:function(s,o){var a=s[o+1];s[o+1]=s[o+3],s[o+3]=a,this._doCryptBlock(s,o,this._invKeySchedule,S,C,f,c,x);var a=s[o+1];s[o+1]=s[o+3],s[o+3]=a},_doCryptBlock:function(s,o,a,e,u,v,I,U){for(var L=this._nRounds,E=s[o]^a[0],p=s[o+1]^a[1],b=s[o+2]^a[2],G=s[o+3]^a[3],N=4,_=1;_<L;_++){var k=e[E>>>24]^u[p>>>16&255]^v[b>>>8&255]^I[G&255]^a[N++],H=e[p>>>24]^u[b>>>16&255]^v[G>>>8&255]^I[E&255]^a[N++],w=e[b>>>24]^u[G>>>16&255]^v[E>>>8&255]^I[p&255]^a[N++],T=e[G>>>24]^u[E>>>16&255]^v[p>>>8&255]^I[b&255]^a[N++];E=k,p=H,b=w,G=T}var k=(U[E>>>24]<<24|U[p>>>16&255]<<16|U[b>>>8&255]<<8|U[G&255])^a[N++],H=(U[p>>>24]<<24|U[b>>>16&255]<<16|U[G>>>8&255]<<8|U[E&255])^a[N++],w=(U[b>>>24]<<24|U[G>>>16&255]<<16|U[E>>>8&255]<<8|U[p&255])^a[N++],T=(U[G>>>24]<<24|U[E>>>16&255]<<16|U[p>>>8&255]<<8|U[b&255])^a[N++];s[o]=k,s[o+1]=H,s[o+2]=w,s[o+3]=T},keySize:256/32});r.AES=R._createHelper(n)}(),d.AES})},function(D,l,t){(function(d,r){D.exports=l=r(t(6))})(this,function(d){return function(r){var P=d,R=P.lib,O=R.WordArray,A=R.Hasher,x=P.algo,m=[];(function(){for(var f=0;f<64;f++)m[f]=r.abs(r.sin(f+1))*4294967296|0})();var y=x.MD5=A.extend({_doReset:function(){this._hash=new O.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(f,c){for(var h=0;h<16;h++){var n=c+h,s=f[n];f[n]=(s<<8|s>>>24)&16711935|(s<<24|s>>>8)&4278255360}var o=this._hash.words,a=f[c+0],e=f[c+1],u=f[c+2],v=f[c+3],I=f[c+4],U=f[c+5],L=f[c+6],E=f[c+7],p=f[c+8],b=f[c+9],G=f[c+10],N=f[c+11],_=f[c+12],k=f[c+13],H=f[c+14],w=f[c+15],T=o[0],M=o[1],F=o[2],B=o[3];T=i(T,M,F,B,a,7,m[0]),B=i(B,T,M,F,e,12,m[1]),F=i(F,B,T,M,u,17,m[2]),M=i(M,F,B,T,v,22,m[3]),T=i(T,M,F,B,I,7,m[4]),B=i(B,T,M,F,U,12,m[5]),F=i(F,B,T,M,L,17,m[6]),M=i(M,F,B,T,E,22,m[7]),T=i(T,M,F,B,p,7,m[8]),B=i(B,T,M,F,b,12,m[9]),F=i(F,B,T,M,G,17,m[10]),M=i(M,F,B,T,N,22,m[11]),T=i(T,M,F,B,_,7,m[12]),B=i(B,T,M,F,k,12,m[13]),F=i(F,B,T,M,H,17,m[14]),M=i(M,F,B,T,w,22,m[15]),T=g(T,M,F,B,e,5,m[16]),B=g(B,T,M,F,L,9,m[17]),F=g(F,B,T,M,N,14,m[18]),M=g(M,F,B,T,a,20,m[19]),T=g(T,M,F,B,U,5,m[20]),B=g(B,T,M,F,G,9,m[21]),F=g(F,B,T,M,w,14,m[22]),M=g(M,F,B,T,I,20,m[23]),T=g(T,M,F,B,b,5,m[24]),B=g(B,T,M,F,H,9,m[25]),F=g(F,B,T,M,v,14,m[26]),M=g(M,F,B,T,p,20,m[27]),T=g(T,M,F,B,k,5,m[28]),B=g(B,T,M,F,u,9,m[29]),F=g(F,B,T,M,E,14,m[30]),M=g(M,F,B,T,_,20,m[31]),T=S(T,M,F,B,U,4,m[32]),B=S(B,T,M,F,p,11,m[33]),F=S(F,B,T,M,N,16,m[34]),M=S(M,F,B,T,H,23,m[35]),T=S(T,M,F,B,e,4,m[36]),B=S(B,T,M,F,I,11,m[37]),F=S(F,B,T,M,E,16,m[38]),M=S(M,F,B,T,G,23,m[39]),T=S(T,M,F,B,k,4,m[40]),B=S(B,T,M,F,a,11,m[41]),F=S(F,B,T,M,v,16,m[42]),M=S(M,F,B,T,L,23,m[43]),T=S(T,M,F,B,b,4,m[44]),B=S(B,T,M,F,_,11,m[45]),F=S(F,B,T,M,w,16,m[46]),M=S(M,F,B,T,u,23,m[47]),T=C(T,M,F,B,a,6,m[48]),B=C(B,T,M,F,E,10,m[49]),F=C(F,B,T,M,H,15,m[50]),M=C(M,F,B,T,U,21,m[51]),T=C(T,M,F,B,_,6,m[52]),B=C(B,T,M,F,v,10,m[53]),F=C(F,B,T,M,G,15,m[54]),M=C(M,F,B,T,e,21,m[55]),T=C(T,M,F,B,p,6,m[56]),B=C(B,T,M,F,w,10,m[57]),F=C(F,B,T,M,L,15,m[58]),M=C(M,F,B,T,k,21,m[59]),T=C(T,M,F,B,I,6,m[60]),B=C(B,T,M,F,N,10,m[61]),F=C(F,B,T,M,u,15,m[62]),M=C(M,F,B,T,b,21,m[63]),o[0]=o[0]+T|0,o[1]=o[1]+M|0,o[2]=o[2]+F|0,o[3]=o[3]+B|0},_doFinalize:function(){var f=this._data,c=f.words,h=this._nDataBytes*8,n=f.sigBytes*8;c[n>>>5]|=128<<24-n%32;var s=r.floor(h/4294967296),o=h;c[(n+64>>>9<<4)+15]=(s<<8|s>>>24)&16711935|(s<<24|s>>>8)&4278255360,c[(n+64>>>9<<4)+14]=(o<<8|o>>>24)&16711935|(o<<24|o>>>8)&4278255360,f.sigBytes=(c.length+1)*4,this._process();for(var a=this._hash,e=a.words,u=0;u<4;u++){var v=e[u];e[u]=(v<<8|v>>>24)&16711935|(v<<24|v>>>8)&4278255360}return a},clone:function(){var f=A.clone.call(this);return f._hash=this._hash.clone(),f}});function i(f,c,h,n,s,o,a){var e=f+(c&h|~c&n)+s+a;return(e<<o|e>>>32-o)+c}function g(f,c,h,n,s,o,a){var e=f+(c&n|h&~n)+s+a;return(e<<o|e>>>32-o)+c}function S(f,c,h,n,s,o,a){var e=f+(c^h^n)+s+a;return(e<<o|e>>>32-o)+c}function C(f,c,h,n,s,o,a){var e=f+(h^(c|~n))+s+a;return(e<<o|e>>>32-o)+c}P.MD5=A._createHelper(y),P.HmacMD5=A._createHmacHelper(y)}(Math),d.MD5})},function(D,l,t){"use strict";var d;l.__esModule=!0;var r=t(1),P=r.__importDefault(t(0)),R=r.__importStar(t(2)),O=r.__importDefault(t(8)),A=r.__importDefault(t(5)),x=r.__importDefault(t(17)),m=r.__importDefault(t(15)),y=r.__importDefault(t(20)),i=r.__importDefault(t(3)),g=t(29);function S(c){var h=c.statusCode;return h===408&&!c.code||h===400&&!c.code||h>=500&&h<=504}function C(c){var h=c.connection,n=h&&h.connectionManager.host;return n?[n].concat(O.default.getFallbackHosts(c.options)):O.default.getHosts(c.options)}var f=(d=function(){function c(){this.checksInProgress=null,this.checkConnectivity=void 0,this.supportsAuthHeaders=!1,this.supportsLinkHeaders=!1,this._getHosts=C,P.default.Config.xhrSupported?(this.supportsAuthHeaders=!0,this.Request=function(h,n,s,o,a,e,u){var v=m.default.createRequest(s,o,a,e,y.default.REQ_SEND,n&&n.options.timeouts,h);return v.once("complete",u),v.exec(),v},this.checkConnectivity=function(h){var n=O.default.internetUpUrl;i.default.logAction(i.default.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+n),this.doUri(x.default.Get,null,n,null,null,null,function(s,o){var a,e=!s&&((a=o)===null||a===void 0?void 0:a.replace(/\n/,""))=="yes";i.default.logAction(i.default.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+e),h(null,e)})}):P.default.Config.jsonpSupported&&(this.Request=function(h,n,s,o,a,e,u){var v=g.createRequest(s,o,a,e,y.default.REQ_SEND,n&&n.options.timeouts,h);return v.once("complete",u),P.default.Config.nextTick(function(){v.exec()}),v},this.checkConnectivity=function(h){var n=this,s=O.default.jsonpInternetUpUrl;if(this.checksInProgress){this.checksInProgress.push(h);return}this.checksInProgress=[h],i.default.logAction(i.default.LOG_MICRO,"(JSONP)Http.checkConnectivity()","Sending; "+s);var o=new g.Request("isTheInternetUp",s,null,null,null,y.default.REQ_SEND,O.default.TIMEOUTS);o.once("complete",function(a,e){var u=!a&&e;i.default.logAction(i.default.LOG_MICRO,"(JSONP)Http.checkConnectivity()","Result: "+u);for(var v=0;v<n.checksInProgress.length;v++)n.checksInProgress[v](null,u);n.checksInProgress=null}),P.default.Config.nextTick(function(){o.exec()})})}return c.prototype.do=function(h,n,s,o,a,e,u){var v=this,I=typeof s=="function"?s:function(p){return n.baseUri(p)+s},U=n._currentFallback;if(U)if(U.validUntil>R.now()){if(!this.Request){u==null||u(new A.default("Request invoked before assigned to",null,500));return}this.Request(h,n,I(U.host),o,e,a,function(p){for(var b=[],G=1;G<arguments.length;G++)b[G-1]=arguments[G];if(p&&S(p)){n._currentFallback=null,v.do(h,n,s,o,a,e,u);return}u==null||u.apply(void 0,r.__spreadArray([p],b))});return}else n._currentFallback=null;var L=C(n);if(L.length===1){this.doUri(h,n,I(L[0]),o,a,e,u);return}var E=function(p,b){var G=p.shift();v.doUri(h,n,I(G),o,a,e,function(N){for(var _=[],k=1;k<arguments.length;k++)_[k-1]=arguments[k];if(N&&S(N)&&p.length){E(p,!0);return}b&&(n._currentFallback={host:G,validUntil:R.now()+n.options.timeouts.fallbackRetryTimeout}),u==null||u.apply(void 0,r.__spreadArray([N],_))})};E(L)},c.prototype.doUri=function(h,n,s,o,a,e,u){if(!this.Request){u(new A.default("Request invoked before assigned to",null,500));return}this.Request(h,n,s,o,e,a,u)},c}(),d.methods=[x.default.Get,x.default.Delete,x.default.Post,x.default.Put,x.default.Patch],d.methodsWithoutBody=[x.default.Get,x.default.Delete],d.methodsWithBody=[x.default.Post,x.default.Put,x.default.Patch],d);l.default=f},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(40)),P=d.__importStar(t(2)),R=P.getGlobalObject();function O(){var y=R.location;return!R.WebSocket||!y||!y.origin||y.origin.indexOf("http")>-1}var A=R.navigator&&R.navigator.userAgent.toString(),x=R.location&&R.location.href,m={agent:"browser",logTimestamps:!0,userAgent:A,currentUrl:x,noUpgrade:A&&!!A.match(/MSIE\s8\.0/),binaryType:"arraybuffer",WebSocket:R.WebSocket,xhrSupported:R.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,jsonpSupported:typeof document!="undefined",allowComet:O(),streamingSupported:!0,useProtocolHeartbeats:!0,createHmac:null,msgpack:r.default,supportsBinary:!!R.TextDecoder,preferBinary:!1,ArrayBuffer:R.ArrayBuffer,atob:R.atob,nextTick:typeof R.setImmediate!="undefined"?R.setImmediate.bind(R):function(y){setTimeout(y,0)},addEventListener:R.addEventListener,inspect:JSON.stringify,stringByteSize:function(y){return R.TextDecoder&&new R.TextEncoder().encode(y).length||y.length},TextEncoder:R.TextEncoder,TextDecoder:R.TextDecoder,Promise:R.Promise,getRandomValues:function(y){if(y!==void 0)return function(i,g){y.getRandomValues(i),g&&g(null)}}(R.crypto||msCrypto)};l.default=m},function(D,l,t){"use strict";(function(d){l.__esModule=!0;var r=t(1),P=r.__importStar(t(2)),R="ablyjs-storage-test",O=function(){function A(){try{d.sessionStorage.setItem(R,R),d.sessionStorage.removeItem(R),this.sessionSupported=!0}catch(x){this.sessionSupported=!1}try{d.localStorage.setItem(R,R),d.localStorage.removeItem(R),this.localSupported=!0}catch(x){this.localSupported=!1}}return A.prototype.get=function(x){return this._get(x,!1)},A.prototype.getSession=function(x){return this._get(x,!0)},A.prototype.remove=function(x){return this._remove(x,!1)},A.prototype.removeSession=function(x){return this._remove(x,!0)},A.prototype.set=function(x,m,y){return this._set(x,m,y,!1)},A.prototype.setSession=function(x,m,y){return this._set(x,m,y,!0)},A.prototype._set=function(x,m,y,i){var g={value:m};return y&&(g.expires=P.now()+y),this.storageInterface(i).setItem(x,JSON.stringify(g))},A.prototype._get=function(x,m){if(m&&!this.sessionSupported)throw new Error("Session Storage not supported");if(!m&&!this.localSupported)throw new Error("Local Storage not supported");var y=this.storageInterface(m).getItem(x);if(!y)return null;var i=JSON.parse(y);return i.expires&&i.expires<P.now()?(this.storageInterface(m).removeItem(x),null):i.value},A.prototype._remove=function(x,m){return this.storageInterface(m).removeItem(x)},A.prototype.storageInterface=function(x){return x?d.sessionStorage:d.localStorage},A}();l.default=new O}).call(this,t(12))},function(D,l,t){"use strict";l.__esModule=!0;var d=t(1),r=d.__importDefault(t(66)),P={internetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",jsonpInternetUpUrl:"https://internet-up.ably-realtime.com/is-the-internet-up-0-9.js",defaultTransports:[r.default.XhrPolling,r.default.XhrStreaming,r.default.JsonP,r.default.WebSocket],baseTransportOrder:[r.default.XhrPolling,r.default.XhrStreaming,r.default.JsonP,r.default.WebSocket],transportPreferenceOrder:[r.default.JsonP,r.default.XhrPolling,r.default.XhrStreaming,r.default.WebSocket],upgradeTransports:[r.default.XhrStreaming,r.default.WebSocket]};l.default=P},function(D,l,t){"use strict";l.__esModule=!0;var d;(function(r){r.WebSocket="web_socket",r.Comet="comet",r.XhrStreaming="xhr_streaming",r.XhrPolling="xhr_polling",r.JsonP="jsonp"})(d||(d={})),l.default=d},function(D,l,t){"use strict";t.r(l);var d=t(29),r=t.n(d),P=t(2),R=t(0),O=t.n(R),A=t(11),x=t.n(A),m=t(15),y=t.n(m),i=function(c){var h="xhr_polling";function n(s,o,a){a.stream=!1,x.a.call(this,s,o,a),this.shortName=h}return P.inherits(n,x.a),n.isAvailable=function(){return O.a.Config.xhrSupported&&O.a.Config.allowComet},n.prototype.toString=function(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},n.prototype.createRequest=function(s,o,a,e,u){return y.a.createRequest(s,o,a,e,u,this.timeouts)},typeof c!="undefined"&&n.isAvailable()&&(c.supportedTransports[h]=n),n},g=i,S=function(c){var h="xhr_streaming";function n(s,o,a){x.a.call(this,s,o,a),this.shortName=h}return P.inherits(n,x.a),n.isAvailable=function(){return O.a.Config.xhrSupported&&O.a.Config.streamingSupported&&O.a.Config.allowComet},n.prototype.toString=function(){return"XHRStreamingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected},n.prototype.createRequest=function(s,o,a,e,u){return y.a.createRequest(s,o,a,e,u,this.timeouts)},typeof c!="undefined"&&n.isAvailable()&&(c.supportedTransports[h]=n),n},C=S,f=l.default=[r.a,g,C]}]).default})});J();J();J();var Yt=At($t()),ft=class{constructor(l){this.debug=(0,Yt.default)(l)}log(l,...t){this.debug(l,...t)}};J();J();J();J();var we=At(Lt());var ot=class{constructor(l={}){this.subscribe=l=>{this.callbacks.push(l)};this.unsubscribe=l=>{this.callbacks=this.callbacks.filter(t=>t!==l)};this.publish=(...l)=>{!this.callbacks||this.callbacks.forEach(t=>{this.callListener(t,l).catch(d=>{this.logger.log("superviz-sdk:observer-helper:publish:error",`
            Failed to execute callback on publish value.
            Callback: ${t}
            Event: ${JSON.stringify(l)}
            Error: ${d}
          `)})})};this.reset=()=>{this.callbacks=[]};this.destroy=()=>{delete this.logger,delete this.callbacks};this.callListener=(l,t)=>new Promise((d,r)=>{try{let P=l(...t);d(P)}catch(P){r(P)}});let{logger:t,throttleTime:d}=l;this.logger=t!=null?t:new ft("@superviz/sdk/observer-helper"),this.throttle=d,this.callbacks=[],this.throttle&&(this.publish=(0,we.default)(this.publish,this.throttle))}};var It=class{constructor(l){this.observers=new Map;this.subscribe=(l,t)=>{this.logger.log("pubsub service @ subscribe",{event:l,callback:t}),this.observers.has(l)||this.observers.set(l,new ot),this.observers.get(l).subscribe(t)};this.unsubscribe=(l,t)=>{this.logger.log("pubsub service @ unsubscribe",{event:l,callback:t}),this.observers.has(l)&&(this.observers.get(l).reset(),this.observers.delete(l))};this.publish=(l,t)=>{this.logger.log("pubsub service @ publish",{event:l,data:t}),this.realtime.setSyncProperty(l,t)};this.publishEventToClient=(l,t)=>{this.logger.log("pubsub service @ publishEventToClient",{event:l,data:t}),this.observers.has(l)&&this.observers.get(l).publish(t)};this.onSyncPropertiesChange=l=>{this.logger.log("pubsub service @ onSyncPropertiesChange",{properties:l}),Object.entries(l).forEach(([t,d])=>{this.publishEventToClient(t,d)})};this.logger=new ft("@superviz/sdk/pubsub"),this.realtime=l,this.realtime.syncPropertiesObserver.subscribe(this.onSyncPropertiesChange),this.logger.log("PubSub created")}fetchHistory(l){return this.realtime.fetchSyncClientProperty(l)}};J();J();var _t=At(xe()),Ot=At(Lt());J();J();J();var Ut=(A=>(A[A.DISCONNECTED=0]="DISCONNECTED",A[A.INITIALIZING=1]="INITIALIZING",A[A.READY_TO_JOIN=2]="READY_TO_JOIN",A[A.CONNECTING=3]="CONNECTING",A[A.CONNECTED=4]="CONNECTED",A[A.JOINED=5]="JOINED",A[A.FAILED=-1]="FAILED",A[A.RETRYING=-2]="RETRYING",A))(Ut||{});J();J();var Gt=(c=>(c[c.yellow=0]="yellow",c[c.turquoise=1]="turquoise",c[c.orange=2]="orange",c[c.blue=3]="blue",c[c.pink=4]="pink",c[c.purple=5]="purple",c[c.green=6]="green",c[c.red=7]="red",c[c.bluedark=8]="bluedark",c[c.pinklight=9]="pinklight",c[c.purplelight=10]="purplelight",c[c.greenlight=11]="greenlight",c[c.orangelight=12]="orangelight",c[c.bluelight=13]="bluelight",c[c.redlight=14]="redlight",c[c.brown=15]="brown",c[c.gray=16]="gray",c))(Gt||{}),Bt=(D=>(D[D["#FFEF33"]=0]="#FFEF33",D[D["#31E0B0"]=1]="#31E0B0",D[D["#FF5E10"]=2]="#FF5E10",D[D["#00ABF7"]=3]="#00ABF7",D[D["#FF00BB"]=4]="#FF00BB",D[D["#9C29FF"]=5]="#9C29FF",D[D["#6FDD00"]=6]="#6FDD00",D[D["#E30000"]=7]="#E30000",D[D["#304AFF"]=8]="#304AFF",D[D["#FF89C4"]=9]="#FF89C4",D[D["#D597FF"]=10]="#D597FF",D[D["#C6EC5C"]=11]="#C6EC5C",D[D["#FFA115"]=12]="#FFA115",D[D["#75DEFE"]=13]="#75DEFE",D[D["#FAA291"]=14]="#FAA291",D[D["#BB813F"]=15]="#BB813F",D[D["#878291"]=16]="#878291",D))(Bt||{});var Pt=class{constructor(){this.participantObservers=[],this.logger=new ft("@superviz/sdk/realtime-service"),this.participantsObserver=new ot({logger:this.logger}),this.participantJoinedObserver=new ot({logger:this.logger}),this.participantLeaveObserver=new ot({logger:this.logger}),this.syncPropertiesObserver=new ot({logger:this.logger}),this.reconnectObserver=new ot({logger:this.logger}),this.roomInfoUpdatedObserver=new ot({logger:this.logger}),this.roomListUpdatedObserver=new ot({logger:this.logger}),this.hostObserver=new ot({logger:this.logger}),this.realtimeStateObserver=new ot({logger:this.logger}),this.kickAllParticipantsObserver=new ot({logger:this.logger}),this.authenticationObserver=new ot({logger:this.logger})}subscribeToParticipantUpdate(l,t){this.participantObservers[l]||(this.participantObservers[l]=new ot({logger:this.logger})),this.participantObservers[l].subscribe(t)}unsubscribeFromParticipantUpdate(l,t){this.participantObservers[l]&&this.participantObservers[l].unsubscribe(t)}getSlotColor(l){let t=l!=null?l:16;return{color:Bt[t],name:Gt[t]}}};var Jn=1e3*60,Qn=6e4,$n=1e4,Yn=1e3,Ft=null,yt=class extends Pt{constructor(t,d){super();this.participants={};this.hostParticipantId=null;this.myParticipant=null;this.supervizChannel=null;this.clientSyncChannel=null;this.clientRoomStateChannel=null;this.broadcastChannel=null;this.clientRoomState={};this.clientSyncPropertiesQueue={};this.clientSyncPropertiesTimeOut=null;this.isReconnecting=!1;this.isJoinedRoom=!1;this.currentReconnectAttempt=0;this.localRoomProperties=null;this.enableSync=!0;this.isSyncFrozen=!1;this.left=!1;this.state=0;this.setHost=t=>{if(!t)return;let d=this.participants[t];this.updateRoomProperties({hostClientId:d.clientId})};this.freezeSync=t=>{var d,r;if(this.isSyncFrozen=t,t){this.supervizChannel.detach(),this.clientSyncChannel.detach(),(d=this.broadcastChannel)==null||d.detach(),this.supervizChannel.unsubscribe(),this.clientSyncChannel.unsubscribe(),(r=this.broadcastChannel)==null||r.unsubscribe();return}this.join()};this.setParticipantData=t=>{this.myParticipant.data=Object.assign({},this.myParticipant.data,t)};this.publishClientSyncProperties=()=>{this.state===4&&(Object.keys(this.clientSyncPropertiesQueue).forEach(t=>{let d=this.clientSyncPropertiesQueue[t];this.clientSyncPropertiesQueue[t]=[],d.length&&this.clientSyncChannel.publish(t,d)}),clearTimeout(this.clientSyncPropertiesTimeOut),this.clientSyncPropertiesTimeOut=null)};this.saveClientRoomState=(t,d)=>{this.clientRoomState[t]=d[d.length-1],this.clientRoomStateChannel.publish("update",this.clientRoomState),this.logger.log("REALTIME","setting new room state backup")};this.updateLocalRoomState=t=>ht(this,null,function*(){this.localRoomProperties=Object.assign({},this.localRoomProperties,t),this.roomInfoUpdatedObserver.publish(this.localRoomProperties),t.hostClientId?(t==null?void 0:t.hostClientId)!==this.hostParticipantId&&this.updateHostInfo(t.hostClientId):this.hostPassingHandle(),this.updateParticipants()});this.updateMyProperties=(0,Ot.default)(t=>{let d=t;if(!(this.isMessageTooBig(t)||this.left||!this.enableSync||this.isSyncFrozen)&&(d.avatar===void 0&&delete d.avatar,this.myParticipant.data=dt(dt({},this.myParticipant.data),t),!!this.isJoinedRoom))return this.supervizChannel.presence.update(this.myParticipant.data)},Yn);this.updateRoomProperties=t=>{if(this.isMessageTooBig(t)||this.isSyncFrozen||this.left)return;let d=dt(dt({},this.localRoomProperties),t);this.supervizChannel.publish("update",d)};this.updateParticipants=()=>{let t={};this.supervizChannel.presence.get((d,r)=>{r.forEach(P=>{t[P.clientId]=dt({},P)}),this.participants=t,this.participantsObserver.publish(this.participants)})};this.updateHostInfo=t=>{let d=[];if(this.supervizChannel.presence.get((P,R)=>{R.forEach(O=>{P||d.push(O.clientId)})}),!t||!d.includes(t)){this.hostPassingHandle();return}Ft&&clearTimeout(Ft);let r=this.hostParticipantId;this.hostParticipantId=t,this.hostObserver.publish({oldHostParticipantId:r,newHostParticipantId:this.hostParticipantId}),this.logger.log("REALTIME",`Master participant has been changed. New Master Participant: ${this.hostParticipantId}`)};this.initializeRoomProperties=()=>{var d;let t={isGridModeEnable:!1,hostClientId:null,followParticipantId:null,gather:!1,drawing:null};((d=this.myParticipant)==null?void 0:d.data.type)==="host"&&(t.hostClientId=this.myParticipant.data.participantId),this.updateParticipants(),this.updateRoomProperties(t)};this.hostPassingHandle=(0,Ot.default)(()=>ht(this,null,function*(){this.localRoomProperties=yield this.fetchRoomProperties(),this.supervizChannel.presence.get((t,d)=>{let r=d.filter(R=>R.data.type==="host").map(R=>R.clientId);if(this.shouldKickParticipantsOnHostLeave&&r.length===0){Ft=setTimeout(()=>{this.kickAllParticipantsObserver.publish(!0)},Jn);return}let P=r[0];P===this.localParticipantId&&this.setHost(P)})}),1e3);this.findSlotIndex=t=>{let d=t,r=Array.apply(null,{length:15}).map(Number.call,Number);if(this.supervizChannel.presence.get((O,A)=>{if(O){r=[];return}A.forEach(x=>{x.connectionId===d.connectionId&&(d=x),x.connectionId!==d.connectionId&&x.data.hasOwnProperty("slotIndex")&&r.splice(r.indexOf(x.data.slotIndex),1)})}),r.length===0)return;let P=r[0];this.myParticipant.data.slotIndex=P,this.updateMyProperties({slotIndex:P});let R=Math.floor(Math.random()*500);setTimeout(()=>{this.confirmSlot(d)},R)};this.confirmSlot=(0,Ot.default)(t=>ht(this,null,function*(){let d=[],r=t;if(this.supervizChannel.presence.get((P,R)=>{R.forEach(O=>{O.connectionId===r.connectionId&&(r=O),O.connectionId!==r.connectionId&&O.data.slotIndex!==void 0&&d.push(O.data.slotIndex)})}),this.myParticipant.data.slotIndex===void 0||d.includes(this.myParticipant.data.slotIndex))this.findSlotIndex(r);else{let P=yield this.fetchRoomProperties();this.updateRoomProperties(P)}}),1e3);this.onParticipantJoin=t=>{this.updateParticipants(),this.participantJoinedObserver.publish(t),this.updateMyProperties({})};this.syncBroadcast=(0,Ot.default)(()=>{let t=btoa(this.ablyKey),d=`https://rest.ably.io/channels/${this.roomId.toLowerCase()}/presence`;fetch(d,{headers:{Authorization:`Basic ${t}`}}).then(r=>r.json()).then(r=>{this.broadcastChannel.publish("update",r)})},1e3);this.isMessageTooBig=(t,d=Qn)=>{let r=JSON.stringify(t);return new TextEncoder().encode(r).length>d?(this.logger.log("Message too long, the message limit size is 60kb."),!0):!1};this.ablyKey=d,this.apiUrl=t,this.onAblyPresenceEnter=this.onAblyPresenceEnter.bind(this),this.onAblyPresenceUpdate=this.onAblyPresenceUpdate.bind(this),this.onAblyPresenceLeave=this.onAblyPresenceLeave.bind(this),this.onAblyRoomUpdate=this.onAblyRoomUpdate.bind(this),this.onClientSyncChannelUpdate=this.onClientSyncChannelUpdate.bind(this),this.onAblyChannelStateChange=this.onAblyChannelStateChange.bind(this),this.onAblyConnectionStateChange=this.onAblyConnectionStateChange.bind(this),this.onReceiveBroadcastSync=this.onReceiveBroadcastSync.bind(this),this.getParticipantSlot=this.getParticipantSlot.bind(this),this.auth=this.auth.bind(this)}get roomProperties(){return this.localRoomProperties}get getMyParticipant(){return this.myParticipant}get hostClientId(){var t;return(t=this.roomProperties)==null?void 0:t.hostClientId}get isLocalParticipantHost(){return this.hostClientId===this.localParticipantId}get getParticipants(){return this.participants}get participant(){return this.myParticipant}get localParticipantId(){var t,d;return(d=(t=this.myParticipant.data)==null?void 0:t.participantId)!=null?d:null}get isBroadcast(){return Object.values(this.participants).some(t=>t.data.type==="audience")}start({participant:t,roomId:d,apiKey:r,shouldKickParticipantsOnHostLeave:P}){this.myParticipant={data:zt(dt({},t),{participantId:t.id}),timestamp:null,action:null,clientId:t.id,connectionId:null,encoding:null,id:null},this.enableSync=t.type!=="audience",this.roomId=`superviz:${d.toLowerCase()}-${r}`,this.shouldKickParticipantsOnHostLeave=P,this.apiKey=r,this.client||this.buildClient()}auth(t,d){let r=new _t.default.Rest({key:this.ablyKey}),{origin:P}=window.location;r.auth.requestToken(t,{authUrl:`${this.apiUrl}/realtime/auth`,key:this.ablyKey,authParams:{domain:P,apiKey:this.apiKey}},(R,O)=>{R&&this.authenticationObserver.publish("realtime.authentication-failed"),d(R,O)})}join(t){let d=t?Object.assign({},t,{participantId:t.id}):this.myParticipant.data;this.logger.log("REALTIME",`Entering room. Room ID: ${this.roomId}`),this.updateMyProperties(d),this.clientSyncChannel=this.client.channels.get(`${this.roomId}:client-sync`),this.clientSyncChannel.subscribe(this.onClientSyncChannelUpdate),this.clientRoomStateChannel=this.client.channels.get(`${this.roomId}:client-state`),this.broadcastChannel=this.client.channels.get(`${this.roomId}:broadcast`),this.enableSync||this.broadcastChannel.subscribe("update",this.onReceiveBroadcastSync),this.supervizChannel=this.client.channels.get(this.roomId),this.supervizChannel.on(this.onAblyChannelStateChange),this.supervizChannel.subscribe("update",this.onAblyRoomUpdate),this.supervizChannel.presence.subscribe("enter",this.onAblyPresenceEnter),this.enableSync&&this.supervizChannel.presence.subscribe("update",this.onAblyPresenceUpdate),this.supervizChannel.presence.subscribe("leave",this.onAblyPresenceLeave),this.supervizChannel.presence.enter(this.myParticipant.data)}leave(){this.logger.log("REALTIME","Disconnecting from ably servers"),this.client.close(),this.isJoinedRoom=!1,this.isReconnecting=!1,this.roomId=null,this.participants={},this.hostParticipantId=null,this.myParticipant=null,this.supervizChannel=null,this.clientSyncChannel=null,this.client=null,this.left=!0}setGridMode(t){let d=this.localRoomProperties;this.updateRoomProperties(Object.assign({},d,{isGridModeEnable:t}))}setDrawing(t){let d=this.localRoomProperties;this.updateRoomProperties(Object.assign({},d,{drawing:t}))}setSyncProperty(t,d){var R;let r=(R=this.clientSyncPropertiesQueue[t])!=null?R:[],P=(O,A)=>({name:O,data:A,participantId:this.myParticipant.data.participantId,timestamp:Date.now()});this.isMessageTooBig(P(t,d),$n)&&(this.logger.log("REALTIME","Message too big, not sending"),this.throw("Message too long, the message limit size is 10kb.")),this.isMessageTooBig(r)&&(this.logger.log("REALTIME","Message queue too big, publishing"),this.publishClientSyncProperties()),this.logger.log("adding to queue",t,d),this.clientSyncPropertiesQueue[t]||(this.clientSyncPropertiesQueue[t]=[]),this.clientSyncPropertiesQueue[t].push(P(t,d)),this.clientSyncPropertiesTimeOut||(this.clientSyncPropertiesTimeOut=setTimeout(()=>{this.publishClientSyncProperties()},1e3))}setFollowParticipant(t){this.updateRoomProperties({followParticipantId:t})}setGather(t){this.updateRoomProperties({gather:t})}getParticipantSlot(t){var d,r;if(t){let P=t.toString();if(this.participants&&this.participants[P])return(r=(d=this.participants[t])==null?void 0:d.data)==null?void 0:r.slotIndex}return 16}onAblyPresenceEnter(t){t.clientId===this.myParticipant.data.participantId?this.onJoinRoom(t):this.onParticipantJoin(t)}onAblyPresenceUpdate(t){if(!this.isJoinedRoom)return;let{clientId:d}=t,r=Object.assign({},t,{participantId:t.clientId});this.publishParticipantUpdate(r),this.participants&&this.participants[d]&&this.hostParticipantId===this.localParticipantId&&this.isBroadcast&&this.syncBroadcast()}onAblyPresenceLeave(t){this.onParticipantLeave(t)}onClientSyncChannelUpdate(t){let{name:d,data:r}=t,P={};P[d]=r,this.syncPropertiesObserver.publish(P),this.isLocalParticipantHost&&this.saveClientRoomState(d,r)}onReceiveBroadcastSync(t){t.data.forEach(r=>{var R;let P=r.clientId;this.participants[P]=r,(R=r.data)!=null&&R.isAudience||(this.participants[P].data=JSON.parse(this.participants[P].data),this.publishParticipantUpdate(this.participants[P]))})}onAblyRoomUpdate(t){this.updateLocalRoomState(t.data)}buildClient(){this.client&&this.throw("Tried to call buildClient@Ably is already initialized");let t={key:this.ablyKey,disconnectedRetryTimeout:5e3,suspendedRetryTimeout:5e3,clientId:this.myParticipant.data.participantId,authCallback:this.auth};this.client=new _t.default.Realtime(t),this.client.connection.on(this.onAblyConnectionStateChange)}publishParticipantUpdate(t){this.participants[t.clientId]=t,this.participantsObserver.publish(this.participants),this.participantObservers[t.clientId]&&this.participantObservers[t.clientId].publish(t)}forceReconnect(){if(this.logger.log("REALTIME",`RECONNECT: Starting force realtime reconnect | Current attempt: ${this.currentReconnectAttempt}`),this.roomId||this.throw("Tried to reconnect without roomId set"),this.state===2){this.logger.log("REALTIME","Rejoining room since client already connected to ably servers."),this.join();return}this.logger.log("REALTIME","RECONNECT: Restarting ably server since participant lost connection."),this.buildClient(),this.updateMyProperties(this.myParticipant.data)}throw(t){throw this.logger.log(t),new Error(t)}publishStateUpdate(t){this.state!==t&&(this.state=t,this.logger.log("REALTIME",`Realtime state did change. New state: ${Ut[this.state]}`),this.realtimeStateObserver.publish(this.state))}fetchRoomProperties(){return new Promise((t,d)=>{this.supervizChannel.history((r,P)=>{var O;r&&d(r);let R=(O=P.items[0])==null?void 0:O.data;t(R||null)})})}fetchSyncClientProperty(t){return ht(this,null,function*(){try{let d=yield new Promise((r,P)=>{this.clientRoomStateChannel.history((R,O)=>{var x;R&&P(R);let A=(x=O==null?void 0:O.items[0])==null?void 0:x.data;r(A||null)})});if(t&&!d[t])throw new Error(`Event ${t} not found in the history`);return t?d[t]:d}catch(d){this.logger.log("REALTIME","Error in fetch client realtime data",d.message),this.throw(d.message)}})}onStateChange(){var m,y,i;let t=(m=this.supervizChannelState)==null?void 0:m.current,d=(y=this.connectionState)==null?void 0:y.current,r=d==="connected",P=["initialized","connecting"].includes(d),R=["closed","closing"].includes(d)||["detaching","detached"].includes(t),O={[0]:R,[1]:P,[2]:!t&&r,[3]:t==="attaching",[4]:t==="attached"&&r,[-1]:t==="failed"||d==="failed",[-2]:d==="suspended"||t==="suspended"},A=Object.entries(O).find(([g,S])=>S&&g)[0],x=Number(A);if(x===2&&(this.currentReconnectAttempt=0),r&&this.isReconnecting&&this.onJoinRoom(this.getMyParticipant),(x===-2||x===-1)&&this.forceReconnect(),(i=this.connectionState)!=null&&i.retryIn){this.currentReconnectAttempt++,this.isReconnecting=!0,this.publishStateUpdate(-2),this.reconnectObserver.publish(this.currentReconnectAttempt);return}this.publishStateUpdate(x)}onAblyConnectionStateChange(t){this.connectionState=t,this.onStateChange()}onAblyChannelStateChange(t){this.supervizChannelState=t,this.onStateChange()}onJoinRoom(t){return ht(this,null,function*(){var d;this.isJoinedRoom=!0,this.localRoomProperties=yield this.fetchRoomProperties(),this.enableSync&&this.findSlotIndex(t),this.localRoomProperties?(yield Promise.all([this.updateParticipants(),((d=this.localRoomProperties)==null?void 0:d.hostClientId)&&this.updateHostInfo(this.localRoomProperties.hostClientId)]),this.localRoomProperties=yield this.fetchRoomProperties(),this.updateLocalRoomState(this.localRoomProperties)):this.initializeRoomProperties(),this.isReconnecting=!1,this.publishStateUpdate(4),this.participantJoinedObserver.publish(t),this.logger.log("REALTIME","Joined realtime room")})}onParticipantLeave(t){if(this.state===2)return;let d=t.data.participantId===this.hostParticipantId;t.data.participantId===this.localRoomProperties.followParticipantId&&this.setFollowParticipant(),this.participantLeaveObserver.publish(t),d&&this.onHostLeft(),this.updateParticipants()}onHostLeft(){this.updateRoomProperties({hostClientId:null})}};J();var Ht=class{constructor({ablyKey:l,apiUrl:t,apiKey:d,conferenceLayerUrl:r,participant:P,group:R,roomId:O,shouldKickParticipantsOnHostLeave:A}){this.addComponent=l=>{l.attach({localParticipant:this.participant,realtime:this.realtime})};this.removeComponent=l=>{l.detach()};this.subscribeToPubSubEvent=(l,t)=>{this.logger.log("laucher service @ subscribeToPubSubEvent"),this.pubsub.subscribe(l,t)};this.unsubscribeFromPubSubEvent=(l,t)=>{this.logger.log("laucher service @ unsubscribeFromPubSubEvent"),this.pubsub.unsubscribe(l,t)};this.publishToPubSubEvent=(l,t)=>{this.logger.log("laucher service @ publishToPubSubEvent"),this.pubsub.publish(l,t)};this.fetchPubSubHistory=l=>this.pubsub.fetchHistory(l);this.startRealtime=()=>{this.logger.log("laucher service @ startRealtime"),this.realtime.start({apiKey:this.apiKey,participant:this.participant,roomId:this.roomId,shouldKickParticipantsOnHostLeave:this.shouldKickParticipantsOnHostLeave}),this.realtime.join()};this.apiUrl=t,this.apiKey=d,this.ablyKey=l,this.conferenceLayerUrl=r,this.shouldKickParticipantsOnHostLeave=A!=null?A:!0,this.participant=P,this.roomId=O,this.group=R,this.logger=new ft("@superviz/sdk/laucher"),this.realtime=new yt(this.apiUrl,this.ablyKey),this.pubsub=new It(this.realtime),this.logger.log("laucher created"),this.startRealtime()}},Xn=D=>{let l=new Ht(D);return{subscribe:l.subscribeToPubSubEvent,unsubscribe:l.unsubscribeFromPubSubEvent,publish:l.publishToPubSubEvent,fetchHistory:l.fetchPubSubHistory,addComponent:l.addComponent,removeComponent:l.removeComponent}};export{Xn as Laucher};
/*!
 * @license Copyright 2015-2022 Ably Real-time Ltd (ably.com)
 * 
 * Ably JavaScript Library v1.2.29
 * https://github.com/ably/ably-js
 * 
 * Released under the Apache Licence v2.0
 */
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
